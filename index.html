<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Учет автомойки и детейлинга</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <style>
        /* Стили остаются без изменений */
        :root {
            --primary: #4A6FA5;
            --primary-light: #6A8BC5;
            --secondary: #6B8E23;
            --secondary-light: #8BAE43;
            --dark: #2C3E50;
            --light: #F8F9FA;
            --danger: #D9534F;
            --warning: #F0AD4E;
            --purple: #8E44AD;
            --teal: #17A2B8;
            --orange: #E67E22;
            --pink: #E84393;
            --success: #28A745;
            --gray: #6C757D;
            --light-gray: #E9ECEF;
            --border-radius: 10px;
            --box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            --transition: all 0.3s ease;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #F5F7FA;
            color: var(--dark);
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: linear-gradient(135deg, var(--primary), var(--dark));
            color: white;
            padding: 20px 0;
            border-radius: var(--border-radius);
            margin-bottom: 25px;
            box-shadow: var(--box-shadow);
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            padding: 0 20px;
        }
        
        h1 {
            font-size: 1.8rem;
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        .auth-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        
        .nav-tabs {
            display: flex;
            background-color: white;
            border-radius: var(--border-radius);
            overflow: hidden;
            margin-bottom: 20px;
            box-shadow: var(--box-shadow);
        }
        
        .tab {
            padding: 14px 20px;
            cursor: pointer;
            flex: 1;
            text-align: center;
            transition: var(--transition);
            font-weight: 500;
            border-bottom: 3px solid transparent;
        }
        
        .tab.active {
            background-color: white;
            color: var(--primary);
            border-bottom: 3px solid var(--primary);
        }
        
        .tab:hover:not(.active) {
            background-color: #f8f9fa;
            color: var(--primary);
        }
        
        .tab-content {
            display: none;
            background-color: white;
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-bottom: 20px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 18px;
        }
        
        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: var(--dark);
            font-size: 0.9rem;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #E0E0E0;
            border-radius: 8px;
            font-size: 15px;
            transition: var(--transition);
            background-color: white;
        }
        
        input:focus, select:focus, textarea:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(74, 111, 165, 0.1);
        }
        
        button {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 12px 18px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 15px;
            transition: var(--transition);
            font-weight: 500;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        button:hover {
            background-color: var(--primary-light);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .btn-secondary {
            background-color: var(--secondary);
        }
        
        .btn-secondary:hover {
            background-color: var(--secondary-light);
        }
        
        .btn-danger {
            background-color: var(--danger);
        }
        
        .btn-danger:hover {
            background-color: #C9302C;
        }
        
        .btn-purple {
            background-color: var(--purple);
        }
        
        .btn-purple:hover {
            background-color: #7D3C98;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--box-shadow);
        }
        
        th, td {
            padding: 12px 14px;
            text-align: left;
            border-bottom: 1px solid #E9ECEF;
        }
        
        th {
            background-color: #F8F9FA;
            font-weight: 600;
            color: var(--dark);
        }
        
        tr:hover {
            background-color: #F8F9FA;
        }
        
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .card {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 22px;
            box-shadow: var(--box-shadow);
            border-left: 5px solid var(--primary);
            transition: var(--transition);
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        }
        
        .card.detailing {
            border-left-color: var(--purple);
        }
        
        .card.self12 {
            border-left-color: var(--teal);
        }
        
        .card.self35 {
            border-left-color: var(--warning);
        }
        
        .card h3 {
            margin-bottom: 12px;
            color: var(--dark);
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .card-value {
            font-size: 1.7rem;
            font-weight: bold;
            margin-bottom: 8px;
        }
        
        .card-positive {
            color: var(--success);
        }
        
        .card-negative {
            color: var(--danger);
        }
        
        .card-neutral {
            color: var(--dark);
        }
        
        .card-warning {
            color: var(--warning);
        }
        
        .chart-container {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 22px;
            margin-bottom: 22px;
            box-shadow: var(--box-shadow);
        }
        
        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .filter-group {
            flex: 1;
            min-width: 200px;
        }
        
        .actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .search-container {
            margin-bottom: 20px;
        }
        
        .highlight {
            background-color: #FFF9C4;
        }
        
        .profit-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .settlement-card {
            background: linear-gradient(135deg, var(--primary), var(--dark));
            color: white;
            border-radius: var(--border-radius);
            padding: 22px;
            box-shadow: var(--box-shadow);
        }
        
        .settlement-card h3 {
            margin-bottom: 12px;
            font-size: 1.2rem;
        }
        
        .settlement-amount {
            font-size: 2.2rem;
            font-weight: bold;
            margin: 12px 0;
        }
        
        .section-title {
            font-size: 1.4rem;
            margin: 22px 0 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid #E9ECEF;
            color: var(--dark);
            font-weight: 600;
        }
        
        .reserve-card {
            background: linear-gradient(135deg, var(--warning), var(--orange));
            color: white;
            border-radius: var(--border-radius);
            padding: 18px;
            margin-bottom: 20px;
            box-shadow: var(--box-shadow);
        }
        
        .reserve-actions {
            display: flex;
            gap: 10px;
            margin-top: 12px;
        }
        
        .transaction-filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
            padding: 18px;
            background-color: #F8F9FA;
            border-radius: var(--border-radius);
        }
        
        .detail-table {
            margin-top: 20px;
        }
        
        .detail-table h4 {
            margin-bottom: 8px;
            color: var(--dark);
            font-weight: 600;
        }
        
        .firebase-status {
            padding: 10px 12px;
            border-radius: 8px;
            margin: 8px 0;
            font-weight: 500;
        }
        
        .firebase-success {
            background: #D4EDDA;
            color: #155724;
            border: 1px solid #C3E6CB;
        }
        
        .firebase-error {
            background: #F8D7DA;
            color: #721C24;
            border: 1px solid #F5C6CB;
        }
        
        .firebase-warning {
            background: #FFF3CD;
            color: #856404;
            border: 1px solid #FFEAA7;
        }

        .profit-analysis {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: var(--border-radius);
            padding: 22px;
            margin-bottom: 20px;
            box-shadow: var(--box-shadow);
        }

        .profit-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .metric-card {
            background: rgba(255,255,255,0.15);
            padding: 18px;
            border-radius: 8px;
            text-align: center;
            backdrop-filter: blur(10px);
            transition: var(--transition);
        }

        .metric-card:hover {
            transform: translateY(-5px);
        }

        .metric-value {
            font-size: 1.7rem;
            font-weight: bold;
            margin: 8px 0;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .mini-chart-container {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 18px;
            box-shadow: var(--box-shadow);
            height: 280px;
        }
        
        .mini-chart-container h4 {
            margin-bottom: 12px;
            font-size: 1rem;
            color: var(--dark);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 18px;
            box-shadow: var(--box-shadow);
            text-align: center;
            border-top: 4px solid var(--primary);
        }
        
        .stat-card.detailing {
            border-top-color: var(--purple);
        }
        
        .stat-card.self12 {
            border-top-color: var(--teal);
        }
        
        .stat-card.self35 {
            border-top-color: var(--warning);
        }
        
        .stat-value {
            font-size: 1.7rem;
            font-weight: bold;
            margin: 8px 0;
        }
        
        .stat-label {
            font-size: 0.85rem;
            color: var(--gray);
        }
        
        .chart-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .compact-chart {
            height: 240px;
        }

        .profitability-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .profitability-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 18px;
            box-shadow: var(--box-shadow);
            text-align: center;
            border-top: 4px solid var(--primary);
        }
        
        .profitability-card.detailing {
            border-top-color: var(--purple);
        }
        
        .profitability-card.self12 {
            border-top-color: var(--teal);
        }
        
        .profitability-card.self35 {
            border-top-color: var(--warning);
        }
        
        .profitability-value {
            font-size: 1.7rem;
            font-weight: bold;
            margin: 8px 0;
        }
        
        .profitability-label {
            font-size: 0.85rem;
            color: var(--gray);
        }

        .partnership-info {
            background: #F8F9FA;
            padding: 22px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            border-left: 4px solid var(--primary);
        }

        .partnership-section {
            margin-bottom: 22px;
        }

        .partnership-section h4 {
            color: var(--dark);
            margin-bottom: 8px;
            font-size: 1.1rem;
        }

        .partnership-section ul {
            padding-left: 20px;
            margin-bottom: 12px;
        }

        .partnership-section li {
            margin-bottom: 6px;
            line-height: 1.5;
        }

        /* Стили для модальных окон */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(3px);
        }

        .modal-content {
            background-color: white;
            padding: 25px;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--dark);
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray);
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .close-btn:hover {
            background-color: var(--light-gray);
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        /* Стили для вкладки сохраненных расходов - ТАБЛИЦА */
        .saved-expenses-table-container {
            overflow-x: auto;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-top: 20px;
        }

        .saved-expenses-table {
            width: 100%;
            border-collapse: collapse;
        }

        .saved-expenses-table th,
        .saved-expenses-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #E9ECEF;
        }

        .saved-expenses-table th {
            background-color: #F8F9FA;
            font-weight: 600;
            color: var(--dark);
            position: sticky;
            top: 0;
        }

        .saved-expenses-table tr:hover {
            background-color: #F8F9FA;
        }

        .saved-expense-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px;
            border-bottom: 1px solid #E9ECEF;
            transition: var(--transition);
        }

        .saved-expense-item:hover {
            background-color: #F8F9FA;
        }

        .saved-expense-info {
            flex-grow: 1;
        }

        .saved-expense-actions {
            display: flex;
            gap: 8px;
        }

        .saved-expense-form {
            background: #F8F9FA;
            padding: 22px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
        }

        /* Стили для улучшенных счетов в отчетах */
        .accounts-breakdown {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .account-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 18px;
            box-shadow: var(--box-shadow);
            transition: var(--transition);
        }

        .account-card:hover {
            transform: translateY(-5px);
        }

        .account-card h4 {
            margin-bottom: 12px;
            color: var(--dark);
            font-weight: 600;
        }

        .account-details {
            margin-top: 12px;
        }

        .account-item {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px solid #E9ECEF;
        }

        /* Стили для аутентификации */
        .auth-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #E9ECEF;
        }

        .auth-tab {
            padding: 10px 20px;
            cursor: pointer;
            flex: 1;
            text-align: center;
            transition: var(--transition);
        }

        .auth-tab.active {
            border-bottom: 2px solid var(--primary);
            color: var(--primary);
            font-weight: 600;
        }

        .auth-form {
            display: none;
        }

        .auth-form.active {
            display: block;
        }

        /* Стили для улучшенного дизайна таблиц */
        .table-container {
            overflow-x: auto;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }

        /* Стили для детализированной прибыли в отчетах */
        .profit-breakdown {
            margin-top: 15px;
        }

        .profit-breakdown-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #E9ECEF;
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                text-align: center;
                gap: 15px;
            }
            
            .auth-section {
                flex-direction: column;
                width: 100%;
            }
            
            .nav-tabs {
                flex-direction: column;
            }
            
            .summary-cards, .profit-details {
                grid-template-columns: 1fr;
            }
            
            .filters, .actions {
                flex-direction: column;
            }
            
            .reserve-actions {
                flex-direction: column;
            }
            
            .transaction-filters {
                grid-template-columns: 1fr;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .chart-row {
                grid-template-columns: 1fr;
            }
            
            .profitability-grid {
                grid-template-columns: 1fr;
            }

            .modal-content {
                width: 95%;
                padding: 20px;
            }

            .saved-expenses-table th,
            .saved-expenses-table td {
                padding: 8px 10px;
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <div>
                    <h1>Учет автомойки самообслуживания и детейлинга</h1>
                    <p>Султан (собственник) и Чингиз (управляющий)</p>
                </div>
                <div class="auth-section">
                    <div id="user-info" class="user-info" style="display: none;">
                        <div class="user-avatar" id="user-avatar">U</div>
                        <span id="user-email"></span>
                        <button id="logout-btn" class="btn-danger">Выйти</button>
                    </div>
                    <button id="login-btn" style="display: none;">Войти</button>
                </div>
            </div>
        </header>
        
        <div id="firebase-status-message"></div>
        
        <div class="nav-tabs">
            <div class="tab active" data-tab="dashboard">Дашборд</div>
            <div class="tab" data-tab="transactions">Операции</div>
            <div class="tab" data-tab="reports">Отчеты</div>
            <div class="tab" data-tab="saved-expenses">Сохраненные расходы</div>
            <div class="tab" data-tab="settings">Настройки</div>
        </div>
        
        <!-- Дашборд -->
        <div id="dashboard" class="tab-content active">
            <h2 style="color: var(--dark); margin-bottom: 20px;">Дашборд</h2>
            
            <div class="filters">
                <div class="filter-group">
                    <label for="period">Период</label>
                    <select id="period">
                        <option value="current_month">Текущий месяц</option>
                        <option value="last_month">Прошлый месяц</option>
                        <option value="last_3_months">Последние 3 месяца</option>
                        <option value="current_year">Текущий год</option>
                        <option value="last_year">Прошлый год</option>
                        <option value="custom">Произвольный период</option>
                    </select>
                </div>
                
                <div class="filter-group" id="custom-period" style="display: none;">
                    <label for="start-date">С</label>
                    <input type="date" id="start-date">
                    <label for="end-date">По</label>
                    <input type="date" id="end-date">
                </div>
            </div>
            
            <!-- Статистика по направлениям -->
            <div class="stats-grid">
                <div class="stat-card detailing">
                    <h3>Детейлинг</h3>
                    <div class="stat-value" id="detailing-profit-stat">0 руб.</div>
                    <div class="stat-label">Чистая прибыль</div>
                    <div class="stat-label" id="detailing-margin-stat">Маржа: 0%</div>
                </div>
                
                <div class="stat-card self12">
                    <h3>Посты 1-2</h3>
                    <div class="stat-value" id="self12-profit-stat">0 руб.</div>
                    <div class="stat-label">Чистая прибыль</div>
                    <div class="stat-label" id="self12-margin-stat">Маржа: 0%</div>
                </div>
                
                <div class="stat-card self35">
                    <h3>Посты 3-5</h3>
                    <div class="stat-value" id="self35-profit-stat">0 руб.</div>
                    <div class="stat-label">Чистая прибыль</div>
                    <div class="stat-label" id="self35-margin-stat">Маржа: 0%</div>
                </div>
            </div>
            
            <!-- Показатели рентабельности -->
            <div class="profitability-grid">
                <div class="profitability-card detailing">
                    <h3>Рентабельность детейлинга</h3>
                    <div class="profitability-value" id="detailing-profitability">0%</div>
                    <div class="profitability-label">Валовая рентабельность</div>
                </div>
                
                <div class="profitability-card self12">
                    <h3>Рентабельность постов 1-2</h3>
                    <div class="profitability-value" id="self12-profitability">0%</div>
                    <div class="profitability-label">Валовая рентабельность</div>
                </div>
                
                <div class="profitability-card self35">
                    <h3>Рентабельность постов 3-5</h3>
                    <div class="profitability-value" id="self35-profitability">0%</div>
                    <div class="profitability-label">Валовая рентабельность</div>
                </div>
            </div>
            
            <!-- Основная сетка дашборда -->
            <div class="dashboard-grid">
                <div>
                    <!-- Графики доходов и расходов -->
                    <div class="chart-row">
                        <div class="mini-chart-container">
                            <h4>Доходы по категориям</h4>
                            <canvas id="incomeChart" height="200"></canvas>
                        </div>
                        <div class="mini-chart-container">
                            <h4>Расходы по категориям</h4>
                            <canvas id="expenseChart" height="200"></canvas>
                        </div>
                    </div>
                    
                    <!-- Графики прибыльности -->
                    <div class="chart-row">
                        <div class="mini-chart-container">
                            <h4>Прибыль по направлениям</h4>
                            <canvas id="profitChart" height="200"></canvas>
                        </div>
                        <div class="mini-chart-container">
                            <h4>Способы оплаты</h4>
                            <canvas id="paymentChart" height="200"></canvas>
                        </div>
                    </div>
                    
                    <!-- Новые графики динамики за 6 месяцев -->
                    <div class="chart-row">
                        <div class="mini-chart-container">
                            <h4>Динамика доходов за 6 месяцев</h4>
                            <canvas id="incomeTrendChart" height="200"></canvas>
                        </div>
                        <div class="mini-chart-container">
                            <h4>Динамика расходов за 6 месяцев</h4>
                            <canvas id="expenseTrendChart" height="200"></canvas>
                        </div>
                    </div>
                    
                    <div class="chart-row">
                        <div class="mini-chart-container">
                            <h4>Динамика доходов по направлениям</h4>
                            <canvas id="incomeByCategoryTrendChart" height="200"></canvas>
                        </div>
                        <div class="mini-chart-container">
                            <h4>Динамика расходов по направлениям</h4>
                            <canvas id="expenseByCategoryTrendChart" height="200"></canvas>
                        </div>
                    </div>
                </div>
                
                <div>
                    <!-- Боковая панель с расчетами -->
                    <div class="settlement-card">
                        <h3>Взаимные расчеты</h3>
                        <p>Сумма для уравнивания прибыли</p>
                        <div class="settlement-amount" id="settlement-amount">0 руб.</div>
                        <p id="settlement-text">Расчеты сбалансированы</p>
                    </div>
                    
                    <div class="reserve-card">
                        <h3>Резервный фонд</h3>
                        <p>Текущий баланс</p>
                        <div class="settlement-amount" id="reserve-amount">0 руб.</div>
                        <p id="reserve-used-info">Использовано в периоде: 0 руб.</p>
                        <div class="reserve-actions">
                            <button id="add-reserve-btn">Пополнить</button>
                            <button id="withdraw-reserve-btn">Списать</button>
                        </div>
                    </div>
                    
                    <!-- Прибыль собственника и управляющего -->
                    <div class="card">
                        <h3>Прибыль собственника и управляющего</h3>
                        <div style="margin-top: 15px;">
                            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #E9ECEF;">
                                <span>Султан (собственник):</span>
                                <span id="sultan-profit-stat">0 руб.</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #E9ECEF;">
                                <span>Чингиз (управляющий):</span>
                                <span id="chingiz-profit-stat">0 руб.</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 10px 0; border-top: 1px solid #E9ECEF; margin-top: 10px;">
                                <span><strong>Итого:</strong></span>
                                <span><strong id="total-profit-stat">0 руб.</strong></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Анализ прибыльности -->
            <div class="profit-analysis">
                <h3 style="color: white; margin-bottom: 20px;">Анализ прибыльности</h3>
                
                <div class="profit-metrics">
                    <div class="metric-card">
                        <div>Общая рентабельность</div>
                        <div class="metric-value" id="overall-margin">0%</div>
                    </div>
                    <div class="metric-card">
                        <div>Валовая маржа</div>
                        <div class="metric-value" id="gross-margin">0%</div>
                    </div>
                    <div class="metric-card">
                        <div>Чистая маржа</div>
                        <div class="metric-value" id="net-margin">0%</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Операции -->
        <div id="transactions" class="tab-content">
            <h2 style="margin-bottom: 20px;">Управление операциями</h2>
            
            <div class="search-container">
                <input type="text" id="search-input" placeholder="Поиск по описанию...">
            </div>
            
            <div class="transaction-filters">
                <div class="filter-group">
                    <label for="filter-type">Тип операции</label>
                    <select id="filter-type">
                        <option value="">Все типы</option>
                        <option value="income">Доход</option>
                        <option value="expense">Расход</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="filter-category">Категория</label>
                    <select id="filter-category">
                        <option value="">Все категории</option>
                        <option value="detailing">Детейлинг</option>
                        <option value="self12">Самообслуживание (1-2)</option>
                        <option value="self35">Самообслуживание (3-5)</option>
                        <option value="reserve">Резервный фонд</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="filter-payment">Способ оплаты</label>
                    <select id="filter-payment">
                        <option value="">Все способы</option>
                        <option value="sultan_akbars">Счет АББ Султана</option>
                        <option value="sultan_sber">Счет Сбер/Яндекс Султана</option>
                        <option value="chingiz_cash">Наличные (Чингиз)</option>
                        <option value="chingiz_card">Счет Чингиза</option>
                        <option value="sultan_sber_cash">Счет Сбер (Султан) - самообслуживание</option>
                        <option value="chingiz_cash_self">Наличные (Чингиз) - самообслуживание</option>
                        <option value="reserve">Резервный фонд Чингиза</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="filter-period">Период</label>
                    <select id="filter-period">
                        <option value="all">За все время</option>
                        <option value="current_month">Текущий месяц</option>
                        <option value="last_month">Прошлый месяц</option>
                        <option value="last_3_months">Последние 3 месяца</option>
                    </select>
                </div>
            </div>
            
            <div class="actions">
                <button id="add-transaction-btn">Добавить операцию</button>
                <button id="export-btn" class="btn-secondary">Экспорт в Excel</button>
                <button id="sync-firebase-btn" class="btn-purple">Синхронизировать с облаком</button>
            </div>
            
            <div class="table-container">
                <table id="transactions-table">
                    <thead>
                        <tr>
                            <th>Дата</th>
                            <th>Тип</th>
                            <th>Категория</th>
                            <th>Способ оплаты</th>
                            <th>Сумма</th>
                            <th>Описание</th>
                            <th>Категория расходов</th>
                            <th>Действия</th>
                        </tr>
                    </thead>
                    <tbody id="transactions-body">
                        <!-- Данные будут загружены через JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Отчеты -->
        <div id="reports" class="tab-content">
            <h2 style="margin-bottom: 20px;">Отчеты</h2>
            
            <div class="filters">
                <div class="filter-group">
                    <label for="report-period">Период отчета</label>
                    <select id="report-period">
                        <option value="current_month">Текущий месяц</option>
                        <option value="first_half">1-15 число месяца</option>
                        <option value="second_half">16-последний день месяца</option>
                        <option value="year">Годовой отчет</option>
                        <option value="custom">Произвольный период</option>
                    </select>
                </div>
                
                <div class="filter-group" id="report-year-group">
                    <label for="report-year">Год</label>
                    <select id="report-year">
                        <!-- Годы будут заполнены через JavaScript -->
                    </select>
                </div>
                
                <div class="filter-group" id="report-month-group">
                    <label for="report-month">Месяц</label>
                    <select id="report-month">
                        <option value="01">Январь</option>
                        <option value="02">Февраль</option>
                        <option value="03">Март</option>
                        <option value="04">Апрель</option>
                        <option value="05">Май</option>
                        <option value="06">Июнь</option>
                        <option value="07">Июль</option>
                        <option value="08">Август</option>
                        <option value="09">Сентябрь</option>
                        <option value="10">Октябрь</option>
                        <option value="11">Ноябрь</option>
                        <option value="12">Декабрь</option>
                    </select>
                </div>
                
                <div class="filter-group" id="report-custom-period" style="display: none;">
                    <label for="report-start-date">С</label>
                    <input type="date" id="report-start-date">
                    <label for="report-end-date">По</label>
                    <input type="date" id="report-end-date">
                </div>
            </div>
            
            <div class="actions">
                <button id="generate-report-btn" class="btn-secondary">Сформировать отчет</button>
                <button id="export-excel-btn" class="btn-purple">Выгрузить в Excel</button>
                <button id="save-report-btn">Сохранить отчет</button>
            </div>
            
            <div id="report-content">
                <!-- Содержимое отчета будет генерироваться здесь -->
            </div>
        </div>
        
        <!-- Сохраненные расходы -->
        <div id="saved-expenses" class="tab-content">
            <h2 style="margin-bottom: 20px;">Сохраненные расходы</h2>
            <p style="margin-bottom: 20px;">Создавайте и управляйте шаблонами часто используемых расходов для быстрого добавления операций.</p>
            
            <div class="saved-expense-form">
                <h3 id="saved-expense-form-title">Добавить новый сохраненный расход</h3>
                <div class="form-group">
                    <label for="saved-expense-category">Категория</label>
                    <select id="saved-expense-category" required>
                        <option value="">Выберите категорию</option>
                        <option value="detailing">Детейлинг</option>
                        <option value="self12">Самообслуживание (посты 1-2)</option>
                        <option value="self35">Самообслуживание (посты 3-5)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="saved-expense-payment">Способ оплаты</label>
                    <select id="saved-expense-payment" required>
                        <option value="">Выберите способ оплаты</option>
                        <option value="sultan_akbars">Счет АББ Султана</option>
                        <option value="sultan_sber">Счет Сбер/Яндекс Султана</option>
                        <option value="chingiz_cash">Наличные (Чингиз)</option>
                        <option value="chingiz_card">Счет Чингиза</option>
                        <option value="sultan_sber_cash">Счет Сбер (Султан) - самообслуживание</option>
                        <option value="chingiz_cash_self">Наличные (Чингиз) - самообслуживание</option>
                        <option value="reserve">Резервный фонд Чингиза</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="saved-expense-amount">Сумма (руб.)</label>
                    <input type="number" id="saved-expense-amount" min="0" step="0.01">
                </div>
                
                <div class="form-group">
                    <label for="saved-expense-description">Описание</label>
                    <textarea id="saved-expense-description" rows="3" required></textarea>
                </div>

                <div class="form-group">
                    <label for="saved-expense-category-type">Категория расходов (для аналитики)</label>
                    <select id="saved-expense-category-type">
                        <option value="">Автоматическое определение</option>
                        <option value="cogs">Себестоимость (COGS)</option>
                        <option value="direct">Прямые затраты</option>
                        <option value="indirect">Косвенные затраты</option>
                        <option value="fixed">Постоянные затраты</option>
                        <option value="variable">Переменные затраты</option>
                    </select>
                </div>
                
                <div class="actions">
                    <button id="add-saved-expense-btn" class="btn-secondary">Сохранить шаблон</button>
                    <button id="update-saved-expense-btn" class="btn-purple" style="display: none;">Обновить шаблон</button>
                    <button id="cancel-edit-saved-expense-btn" style="display: none;">Отмена</button>
                </div>
            </div>
            
            <h3>Сохраненные шаблоны расходов</h3>
            <div class="saved-expenses-table-container">
                <table class="saved-expenses-table">
                    <thead>
                        <tr>
                            <th>Описание</th>
                            <th>Категория</th>
                            <th>Способ оплаты</th>
                            <th>Сумма</th>
                            <th>Категория расходов</th>
                            <th>Действия</th>
                        </tr>
                    </thead>
                    <tbody id="saved-expenses-body">
                        <!-- Данные будут загружены через JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Настройки -->
        <div id="settings" class="tab-content">
            <h2 style="margin-bottom: 20px;">Настройки</h2>
            
            <div class="partnership-info">
                <h3>Условия сотрудничества и распределения прибыли</h3>
                
                <div class="partnership-section">
                    <h4>Общие принципы сотрудничества</h4>
                    <ul>
                        <li>Собственник: Султан, Управляющий: Чингиз</li>
                        <li>Совместное ведение бизнеса: автомойка самообслуживания и детейлинг</li>
                        <li>Распределение ответственности по направлениям бизнеса</li>
                    </ul>
                </div>
                
                <div class="partnership-section">
                    <h4>Распределение прибыли</h4>
                    <ul>
                        <li><strong>Детейлинг:</strong> Прибыль распределяется поровну (50/50) между собственником и управляющим</li>
                        <li><strong>Самообслуживание (посты 1-2):</strong> Прибыль распределяется поровну (50/50) между собственником и управляющим</li>
                        <li><strong>Самообслуживание (посты 3-5):</strong> Прибыль полностью принадлежит собственнику</li>
                        <li>Общие расходы покрываются из резервного фонда или распределяются пропорционально долям участия</li>
                    </ul>
                </div>
                
                <div class="partnership-section">
                    <h4>Взаимные расчеты</h4>
                    <ul>
                        <li>Система автоматически рассчитывает сумму для уравнивания прибыли собственника и управляющего</li>
                        <li>Если расчет показывает положительную сумму - Султан (собственник) должен перевести Чингизу (управляющему)</li>
                        <li>Если расчет показывает отрицательную сумму - Чингиз (управляющий) должен перевести Султану (собственнику)</li>
                        <li>Расчеты производятся на основе фактических поступлений и расходов по счетам каждого</li>
                    </ul>
                </div>
                
                <div class="partnership-section">
                    <h4>Резервный фонд</h4>
                    <ul>
                        <li>Создан для покрытия расходов, когда у Чингиза не хватает средств из текущих доходов</li>
                        <li>Пополняется по решению собственника и управляющего</li>
                        <li>Использование средств согласовывается обоими</li>
                        <li>Учет операций с резервным фондом ведется отдельно</li>
                        <li><strong>Автоматическое использование:</strong> Средства автоматически списываются при превышении расходов Чингиза над доходами</li>
                        <li><strong>Может уходить в минус:</strong> Если у Чингиза не хватило денег на расходы, резервный фонд может уйти в отрицательный баланс</li>
                    </ul>
                </div>
                
                <div class="partnership-section">
                    <h4>Учет и отчетность</h4>
                    <ul>
                        <li>Все операции фиксируются в системе с указанием даты, типа, категории и способа оплаты</li>
                        <li>Система автоматически классифицирует расходы для аналитики</li>
                        <li>Доступны различные периоды отчетности: текущий месяц, произвольный период, годовые отчеты</li>
                        <li>Экспорт данных в Excel для детального анализа</li>
                        <li>Облачная синхронизация для доступа с разных устройств</li>
                    </ul>
                </div>
            </div>
            
            <div class="form-group">
                <h3>Экспорт/Импорт данных</h3>
                <p>Сохраняйте резервные копии данных регулярно</p>
                <div class="actions">
                    <button id="backup-btn" class="btn-secondary">Создать резервную копию</button>
                    <button id="restore-btn">Восстановить из резервной копии</button>
                    <input type="file" id="restore-file" style="display: none;" accept=".json">
                </div>
            </div>
            
            <div class="form-group">
                <h3>О программе</h3>
                <p>Версия 7.2 (Исправленные отчеты + Улучшенный дизайн + Оптимизированный резерв)</p>
                <p>2025 Разработано для SK-Detailing by Chingiz</p>
            </div>
        </div>
        
        <!-- Модальные окна -->
        <div id="auth-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">Вход в систему</h3>
                    <button class="close-btn" id="close-auth-btn">&times;</button>
                </div>
                
                <div class="auth-tabs">
                    <div class="auth-tab active" data-form="login">Вход</div>
                    <div class="auth-tab" data-form="register">Регистрация</div>
                </div>
                
                <div id="login-form" class="auth-form active">
                    <div class="form-group">
                        <label for="login-email">Email</label>
                        <input type="email" id="login-email" placeholder="Ваш email">
                    </div>
                    
                    <div class="form-group">
                        <label for="login-password">Пароль</label>
                        <input type="password" id="login-password" placeholder="Ваш пароль">
                    </div>
                    
                    <button id="login-submit-btn" class="btn-secondary" style="width: 100%;">Войти</button>
                </div>
                
                <div id="register-form" class="auth-form">
                    <div class="form-group">
                        <label for="register-email">Email</label>
                        <input type="email" id="register-email" placeholder="Ваш email">
                    </div>
                    
                    <div class="form-group">
                        <label for="register-password">Пароль</label>
                        <input type="password" id="register-password" placeholder="Пароль (минимум 6 символов)">
                    </div>
                    
                    <div class="form-group">
                        <label for="register-confirm-password">Подтвердите пароль</label>
                        <input type="password" id="register-confirm-password" placeholder="Повторите пароль">
                    </div>
                    
                    <button id="register-submit-btn" class="btn-secondary" style="width: 100%;">Зарегистрироваться</button>
                </div>
            </div>
        </div>
        
        <!-- Модальное окно для добавления/редактирования операции -->
        <div id="transaction-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title" id="modal-title">Добавить операцию</h3>
                    <button class="close-btn" id="cancel-transaction-btn">&times;</button>
                </div>
                
                <div class="form-group">
                    <label for="transaction-date">Дата</label>
                    <input type="date" id="transaction-date" required>
                </div>
                
                <div class="form-group">
                    <label for="transaction-type">Тип операции</label>
                    <select id="transaction-type" required>
                        <option value="">Выберите тип</option>
                        <option value="income">Доход</option>
                        <option value="expense">Расход</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="transaction-category">Категория</label>
                    <select id="transaction-category" required>
                        <option value="">Выберите категорию</option>
                        <option value="detailing">Детейлинг</option>
                        <option value="self12">Самообслуживание (посты 1-2)</option>
                        <option value="self35">Самообслуживание (посты 3-5)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="transaction-payment">Способ оплаты</label>
                    <select id="transaction-payment" required>
                        <option value="">Выберите способ оплаты</option>
                        <option value="sultan_akbars">Счет АББ Султана</option>
                        <option value="sultan_sber">Счет Сбер/Яндекс Султана</option>
                        <option value="chingiz_cash">Наличные (Чингиз)</option>
                        <option value="chingiz_card">Счет Чингиза</option>
                        <option value="sultan_sber_cash">Счет Сбер (Султан) - самообслуживание</option>
                        <option value="chingiz_cash_self">Наличные (Чингиз) - самообслуживание</option>
                        <option value="reserve">Резервный фонд Чингиза</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="transaction-amount">Сумма (руб.)</label>
                    <input type="number" id="transaction-amount" min="0" step="0.01" required>
                </div>
                
                <div class="form-group">
                    <label for="transaction-description">Описание</label>
                    <textarea id="transaction-description" rows="3"></textarea>
                </div>

                <div class="form-group" id="expense-category-group" style="display: none;">
                    <label for="transaction-expense-category">Категория расходов (для аналитики)</label>
                    <select id="transaction-expense-category">
                        <option value="">Автоматическое определение</option>
                        <option value="cogs">Себестоимость (COGS)</option>
                        <option value="direct">Прямые затраты</option>
                        <option value="indirect">Косвенные затраты</option>
                        <option value="fixed">Постоянные затраты</option>
                        <option value="variable">Переменные затраты</option>
                    </select>
                    <small id="expense-category-auto" style="color: var(--gray); font-size: 0.8rem;"></small>
                </div>

                <div class="form-group" id="saved-expense-group" style="display: none;">
                    <label for="saved-expense-select">Использовать сохраненный расход</label>
                    <select id="saved-expense-select">
                        <option value="">Выберите шаблон</option>
                    </select>
                </div>
                
                <div class="modal-actions">
                    <button id="cancel-transaction-btn2">Отмена</button>
                    <button id="save-transaction-btn" class="btn-secondary">Сохранить</button>
                </div>
            </div>
        </div>
        
        <!-- Модальное окно для управления резервом -->
        <div id="reserve-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title" id="reserve-modal-title">Управление резервным фондом</h3>
                    <button class="close-btn" id="cancel-reserve-btn">&times;</button>
                </div>
                
                <div class="form-group">
                    <label for="reserve-date">Дата</label>
                    <input type="date" id="reserve-date" required>
                </div>
                
                <div class="form-group">
                    <label for="reserve-amount-input">Сумма (руб.)</label>
                    <input type="number" id="reserve-amount-input" min="0" step="0.01" required>
                </div>
                
                <div class="form-group">
                    <label for="reserve-description">Описание</label>
                    <textarea id="reserve-description" rows="3"></textarea>
                </div>
                
                <div class="modal-actions">
                    <button id="cancel-reserve-btn2">Отмена</button>
                    <button id="save-reserve-btn" class="btn-secondary">Сохранить</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Конфигурация Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyC_klfpOSe-AzacQqzxzdZmy_cU0qNP6ow",
            authDomain: "reportsk-7ea5a.firebaseapp.com",
            projectId: "reportsk-7ea5a",
            storageBucket: "reportsk-7ea5a.firebasestorage.app",
            messagingSenderId: "866594757497",
            appId: "1:866594757497:web:eef363f6c6731d0481ada8"
        };

        // Инициализация Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Основные переменные
        let transactions = JSON.parse(localStorage.getItem('carwash_transactions')) || [];
        let reserveBalance = parseFloat(localStorage.getItem('carwash_reserve')) || 0;
        let savedExpenses = JSON.parse(localStorage.getItem('carwash_saved_expenses')) || [];
        let editingId = null;
        let editingSavedExpenseId = null;
        let reserveAction = null;
        let incomeChart = null;
        let expenseChart = null;
        let profitChart = null;
        let paymentChart = null;
        let incomeTrendChart = null;
        let expenseTrendChart = null;
        let incomeByCategoryTrendChart = null;
        let expenseByCategoryTrendChart = null;
        let currentUser = null;
        let reportGenerated = false;

        // Улучшенная система классификации расходов
        const expenseCategories = {
            cogs: {
                name: "Себестоимость",
                keywords: ["химия", "материал", "смарикомплекс", "оборудование", "запчасти", "инструмент", 
                          "расходники", "перчатки", "полотенца", "шампунь", "воск", "полироль", "щетки",
                          "пены", "автохимия", "моющее", "чистящее", "абразив", " паста", "герметик"]
            },
            direct: {
                name: "Прямые затраты",
                keywords: ["зарплата", "зп", "оператор", "мойщик", "администратор", "менеджер", 
                          "сотрудник", "премия", "отпускные", "больничный", "надбавка", "инструктаж"]
            },
            indirect: {
                name: "Косвенные затраты",
                keywords: ["реклама", "маркетинг", "интернет", "связь", "банковское обслуживание", 
                          "канцелярия", "офис", "юрист", "бухгалтер", "консультация", "лицензия", 
                          "программное обеспечение", "сайт", "соцсети"]
            },
            fixed: {
                name: "Постоянные затраты",
                keywords: ["аренда", "коммунал", "электричество", "вода", "отопление", "арендная плата", 
                          "лизинг", "амортизация", "страхование", "налоги", "аренда оборудования", 
                          "техобслуживание", "ремонт помещения"]
            },
            variable: {
                name: "Переменные затраты",
                keywords: ["транспорт", "командировка", "обучение", "сертификация", "мероприятие", 
                          "представительские", "хозяйственные", "прочие расходы", "непредвиденные"]
            }
        };

        // Функция для классификации расходов на основе описания
        function classifyExpense(description) {
            if (!description) return 'variable';
            
            const desc = description.toLowerCase();
            
            for (const [category, data] of Object.entries(expenseCategories)) {
                if (data.keywords.some(keyword => desc.includes(keyword))) {
                    return category;
                }
            }
            
            return 'variable';
        }

        // Получить название категории по ключу
        function getExpenseCategoryName(categoryKey) {
            return expenseCategories[categoryKey] ? expenseCategories[categoryKey].name : 'Не определена';
        }

        // Функция для расчета детализации по счетам
        function calculateAccountDetails(transactions) {
            const accountDetails = {
                sultan: {
                    akbars: { detailing: { income: 0, expense: 0 } },
                    sber: { detailing: { income: 0, expense: 0 } },
                    sber_cash: { self12: { income: 0, expense: 0 }, self35: { income: 0, expense: 0 } }
                },
                chingiz: {
                    cash: { detailing: { income: 0, expense: 0 }, self12: { income: 0, expense: 0 }, self35: { income: 0, expense: 0 } },
                    card: { detailing: { income: 0, expense: 0 }, self12: { income: 0, expense: 0 }, self35: { income: 0, expense: 0 } },
                    cash_self: { detailing: { income: 0, expense: 0 }, self12: { income: 0, expense: 0 }, self35: { income: 0, expense: 0 } }
                }
            };

            transactions.forEach(transaction => {
                const { type, category, payment, amount } = transaction;
                
                if (payment === 'sultan_akbars') {
                    if (category === 'detailing') {
                        if (type === 'income') accountDetails.sultan.akbars.detailing.income += amount;
                        else accountDetails.sultan.akbars.detailing.expense += amount;
                    }
                }
                else if (payment === 'sultan_sber') {
                    if (category === 'detailing') {
                        if (type === 'income') accountDetails.sultan.sber.detailing.income += amount;
                        else accountDetails.sultan.sber.detailing.expense += amount;
                    }
                }
                else if (payment === 'sultan_sber_cash') {
                    if (category === 'self12' || category === 'self35') {
                        if (type === 'income') accountDetails.sultan.sber_cash[category].income += amount;
                        else accountDetails.sultan.sber_cash[category].expense += amount;
                    }
                }
                else if (payment === 'chingiz_cash') {
                    if (type === 'income') accountDetails.chingiz.cash[category].income += amount;
                    else accountDetails.chingiz.cash[category].expense += amount;
                }
                else if (payment === 'chingiz_card') {
                    if (type === 'income') accountDetails.chingiz.card[category].income += amount;
                    else accountDetails.chingiz.card[category].expense += amount;
                }
                else if (payment === 'chingiz_cash_self') {
                    if (type === 'income') accountDetails.chingiz.cash_self[category].income += amount;
                    else accountDetails.chingiz.cash_self[category].expense += amount;
                }
            });

            return accountDetails;
        }

        // Получить даты периода для дашборда
        function getPeriodDates() {
            const period = document.getElementById('period').value;
            const now = new Date();
            let startDate, endDate;
            
            switch (period) {
                case 'current_month':
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59, 999);
                    break;
                case 'last_month':
                    startDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                    endDate = new Date(now.getFullYear(), now.getMonth(), 0, 23, 59, 59, 999);
                    break;
                case 'last_3_months':
                    startDate = new Date(now.getFullYear(), now.getMonth() - 3, 1);
                    endDate = new Date(now.getFullYear(), now.getMonth(), 0, 23, 59, 59, 999);
                    break;
                case 'current_year':
                    startDate = new Date(now.getFullYear(), 0, 1);
                    endDate = new Date(now.getFullYear(), 11, 31, 23, 59, 59, 999);
                    break;
                case 'last_year':
                    startDate = new Date(now.getFullYear() - 1, 0, 1);
                    endDate = new Date(now.getFullYear() - 1, 11, 31, 23, 59, 59, 999);
                    break;
                case 'custom':
                    const customStart = document.getElementById('start-date').value;
                    const customEnd = document.getElementById('end-date').value;
                    
                    if (customStart && customEnd) {
                        startDate = new Date(customStart);
                        endDate = new Date(customEnd + 'T23:59:59.999');
                    } else {
                        // Если даты не выбраны, возвращаем null
                        return { startDate: null, endDate: null };
                    }
                    break;
                default:
                    // Если период не выбран, возвращаем все время
                    return { startDate: null, endDate: null };
            }
            
            return { startDate, endDate };
        }

        // Получить даты периода для отчетов
        function getReportPeriodDates() {
            const reportPeriod = document.getElementById('report-period').value;
            const reportYear = parseInt(document.getElementById('report-year').value);
            const reportMonth = parseInt(document.getElementById('report-month').value) - 1;
            const now = new Date();
            
            let startDate, endDate;
            
            switch (reportPeriod) {
                case 'current_month':
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59, 999);
                    break;
                case 'first_half':
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    endDate = new Date(now.getFullYear(), now.getMonth(), 15, 23, 59, 59, 999);
                    break;
                case 'second_half':
                    startDate = new Date(now.getFullYear(), now.getMonth(), 16);
                    endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59, 999);
                    break;
                case 'year':
                    startDate = new Date(reportYear, 0, 1);
                    endDate = new Date(reportYear, 11, 31, 23, 59, 59, 999);
                    break;
                case 'custom':
                    const customStart = document.getElementById('report-start-date').value;
                    const customEnd = document.getElementById('report-end-date').value;
                    
                    if (customStart && customEnd) {
                        startDate = new Date(customStart);
                        endDate = new Date(customEnd + 'T23:59:59.999');
                    } else {
                        startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                        endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59, 999);
                    }
                    break;
                default:
                    // Если выбран конкретный месяц
                    if (reportMonth >= 0) {
                        startDate = new Date(reportYear, reportMonth, 1);
                        endDate = new Date(reportYear, reportMonth + 1, 0, 23, 59, 59, 999);
                    } else {
                        startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                        endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59, 999);
                    }
            }
            
            return { startDate, endDate };
        }

        // Инициализация при загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            initializeFirebaseAuth();
            renderTransactions();
            updateDashboard();
            updateReserveDisplay();
            renderSavedExpenses();
            populateYearSelect();
            
            // Устанавливаем текущий месяц и год для отчетов
            const now = new Date();
            document.getElementById('report-year').value = now.getFullYear();
            document.getElementById('report-month').value = (now.getMonth() + 1).toString().padStart(2, '0');
        });

        // Заполнение выпадающего списка годов
        function populateYearSelect() {
            const yearSelect = document.getElementById('report-year');
            const currentYear = new Date().getFullYear();
            
            // Очищаем список
            yearSelect.innerHTML = '';
            
            // Добавляем годы от 2020 до текущего года + 1
            for (let year = 2020; year <= currentYear + 1; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                if (year === currentYear) {
                    option.selected = true;
                }
                yearSelect.appendChild(option);
            }
        }

        // Инициализация Firebase Auth
        function initializeFirebaseAuth() {
            auth.onAuthStateChanged((user) => {
                if (user) {
                    currentUser = user;
                    showUserInfo(user);
                    loadFromFirebase();
                } else {
                    currentUser = null;
                    hideUserInfo();
                    showAuthModal();
                }
            });
        }

        // Показать информацию о пользователе
        function showUserInfo(user) {
            document.getElementById('user-info').style.display = 'flex';
            document.getElementById('login-btn').style.display = 'none';
            document.getElementById('user-email').textContent = user.email;
            document.getElementById('user-avatar').textContent = user.email.charAt(0).toUpperCase();
        }

        // Скрыть информацию о пользователе
        function hideUserInfo() {
            document.getElementById('user-info').style.display = 'none';
            document.getElementById('login-btn').style.display = 'block';
        }

        // Показать модальное окно аутентификации
        function showAuthModal() {
            document.getElementById('auth-modal').style.display = 'flex';
        }

        // Скрыть модальное окно аутентификации
        function hideAuthModal() {
            document.getElementById('auth-modal').style.display = 'none';
        }

        // Загрузка данных из Firebase
        async function loadFromFirebase() {
            if (!currentUser) return;
            
            try {
                showFirebaseStatus('Загрузка данных из облака...', 'warning');
                
                const doc = await db.collection('users').doc(currentUser.uid).get();
                
                if (doc.exists) {
                    const data = doc.data();
                    
                    transactions = data.transactions || [];
                    reserveBalance = data.reserveBalance || 0;
                    savedExpenses = data.savedExpenses || [];
                    
                    localStorage.setItem('carwash_transactions', JSON.stringify(transactions));
                    localStorage.setItem('carwash_reserve', reserveBalance.toString());
                    localStorage.setItem('carwash_saved_expenses', JSON.stringify(savedExpenses));
                    
                    renderTransactions();
                    updateDashboard();
                    updateReserveDisplay();
                    renderSavedExpenses();
                    
                    showFirebaseStatus(`Данные успешно загружены (${transactions.length} операций)`, 'success');
                } else {
                    await saveToFirebase();
                    showFirebaseStatus('Создан новый профиль в облаке', 'success');
                }
            } catch (error) {
                console.error('Ошибка загрузки из Firebase:', error);
                showFirebaseStatus(`Ошибка загрузки: ${error.message}`, 'error');
            }
        }

        // Сохранение данных в Firebase
        async function saveToFirebase() {
            if (!currentUser) return;
            
            try {
                showFirebaseStatus('Сохранение данных в облако...', 'warning');
                
                function removeUndefinedFields(obj) {
                    if (Array.isArray(obj)) {
                        return obj.map(item => 
                            item && typeof item === 'object' ? removeUndefinedFields(item) : item
                        ).filter(item => item !== undefined);
                    } else if (obj && typeof obj === 'object') {
                        return Object.fromEntries(
                            Object.entries(obj)
                                .map(([key, value]) => [
                                    key, 
                                    value && typeof value === 'object' ? removeUndefinedFields(value) : value
                                ])
                                .filter(([_, value]) => value !== undefined)
                        );
                    }
                    return obj;
                }
                
                const cleanedTransactions = removeUndefinedFields(transactions);
                const cleanedSavedExpenses = removeUndefinedFields(savedExpenses);
                
                const data = removeUndefinedFields({
                    transactions: cleanedTransactions,
                    savedExpenses: cleanedSavedExpenses,
                    reserveBalance: reserveBalance,
                    lastUpdate: new Date().toISOString(),
                    email: currentUser.email
                });
                
                await db.collection('users').doc(currentUser.uid).set(data);
                
                showFirebaseStatus(`Данные успешно сохранены в облако (${transactions.length} операций)`, 'success');
            } catch (error) {
                console.error('Ошибка сохранения в Firebase:', error);
                showFirebaseStatus(`Ошибка сохранения: ${error.message}`, 'error');
            }
        }

        // Показать статус Firebase
        function showFirebaseStatus(message, type) {
            const statusElement = document.getElementById('firebase-status-message');
            statusElement.innerHTML = `<div class="firebase-status firebase-${type}">${message}</div>`;
            
            if (type !== 'warning') {
                setTimeout(() => {
                    statusElement.innerHTML = '';
                }, 5000);
            }
        }

        // Инициализация приложения
        function initializeApp() {
            // Навигация по вкладкам
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    this.classList.add('active');
                    document.getElementById(this.dataset.tab).classList.add('active');
                    
                    if (this.dataset.tab === 'transactions') {
                        renderTransactions();
                    }
                    
                    if (this.dataset.tab === 'saved-expenses') {
                        renderSavedExpenses();
                    }

                    if (this.dataset.tab === 'reports') {
                        generateReport();
                        reportGenerated = true;
                    }
                });
            });
            
            // Фильтр периода на дашборде
            document.getElementById('period').addEventListener('change', function() {
                const customPeriod = document.getElementById('custom-period');
                if (this.value === 'custom') {
                    customPeriod.style.display = 'block';
                } else {
                    customPeriod.style.display = 'none';
                }
                updateDashboard();
            });
            
            // Обработчик изменения периода отчета
            document.getElementById('report-period').addEventListener('change', function() {
                const yearGroup = document.getElementById('report-year-group');
                const monthGroup = document.getElementById('report-month-group');
                const customPeriod = document.getElementById('report-custom-period');
                
                if (this.value === 'year') {
                    yearGroup.style.display = 'block';
                    monthGroup.style.display = 'none';
                    customPeriod.style.display = 'none';
                } else if (this.value === 'custom') {
                    yearGroup.style.display = 'none';
                    monthGroup.style.display = 'none';
                    customPeriod.style.display = 'block';
                } else {
                    yearGroup.style.display = 'block';
                    monthGroup.style.display = 'block';
                    customPeriod.style.display = 'none';
                }
                
                // Автоматически генерируем отчет при изменении периода
                generateReport();
            });
            
            // Обработчики изменения года и месяца для отчетов
            document.getElementById('report-year').addEventListener('change', function() {
                generateReport();
            });
            
            document.getElementById('report-month').addEventListener('change', function() {
                generateReport();
            });
            
            // Обработчики для пользовательского периода в отчетах
            document.getElementById('report-start-date').addEventListener('change', function() {
                generateReport();
            });
            
            document.getElementById('report-end-date').addEventListener('change', function() {
                generateReport();
            });
            
            // Поиск операций
            document.getElementById('search-input').addEventListener('input', function() {
                renderTransactions();
            });
            
            // Фильтры операций
            document.getElementById('filter-type').addEventListener('change', function() {
                renderTransactions();
            });
            
            document.getElementById('filter-category').addEventListener('change', function() {
                renderTransactions();
            });
            
            document.getElementById('filter-payment').addEventListener('change', function() {
                renderTransactions();
            });
            
            document.getElementById('filter-period').addEventListener('change', function() {
                renderTransactions();
            });
            
            // Кнопка добавления операции
            document.getElementById('add-transaction-btn').addEventListener('click', function() {
                showTransactionModal();
            });
            
            // Кнопки в модальном окне операции
            document.getElementById('cancel-transaction-btn').addEventListener('click', function() {
                hideTransactionModal();
            });
            
            document.getElementById('cancel-transaction-btn2').addEventListener('click', function() {
                hideTransactionModal();
            });
            
            document.getElementById('save-transaction-btn').addEventListener('click', function() {
                saveTransaction();
            });

            // Обработчик изменения типа операции в модальном окне
            document.getElementById('transaction-type').addEventListener('change', function() {
                const expenseCategoryGroup = document.getElementById('expense-category-group');
                const savedExpenseGroup = document.getElementById('saved-expense-group');
                
                if (this.value === 'expense') {
                    expenseCategoryGroup.style.display = 'block';
                    savedExpenseGroup.style.display = 'block';
                    updateSavedExpenseSelect();
                    
                    // Показываем автоматическую категорию на основе описания
                    const description = document.getElementById('transaction-description').value;
                    if (description) {
                        const autoCategory = classifyExpense(description);
                        document.getElementById('expense-category-auto').textContent = `Автоматически: ${getExpenseCategoryName(autoCategory)}`;
                    }
                } else {
                    expenseCategoryGroup.style.display = 'none';
                    savedExpenseGroup.style.display = 'none';
                }
            });

            // Обработчик изменения описания в модальном окне
            document.getElementById('transaction-description').addEventListener('input', function() {
                const transactionType = document.getElementById('transaction-type').value;
                if (transactionType === 'expense') {
                    const autoCategory = classifyExpense(this.value);
                    document.getElementById('expense-category-auto').textContent = `Автоматически: ${getExpenseCategoryName(autoCategory)}`;
                }
            });

            // Обработчик выбора сохраненного расхода
            document.getElementById('saved-expense-select').addEventListener('change', function() {
                const selectedId = this.value;
                if (selectedId) {
                    const savedExpense = savedExpenses.find(exp => exp.id === selectedId);
                    if (savedExpense) {
                        document.getElementById('transaction-category').value = savedExpense.category;
                        document.getElementById('transaction-payment').value = savedExpense.payment;
                        document.getElementById('transaction-amount').value = savedExpense.amount || '';
                        document.getElementById('transaction-description').value = savedExpense.description;
                        document.getElementById('transaction-expense-category').value = savedExpense.expenseCategory || '';
                        
                        // Обновляем автоматическую категорию
                        const autoCategory = classifyExpense(savedExpense.description);
                        document.getElementById('expense-category-auto').textContent = `Автоматически: ${getExpenseCategoryName(autoCategory)}`;
                    }
                }
            });
            
            // Экспорт данных
            document.getElementById('export-btn').addEventListener('click', function() {
                exportToExcel();
            });
            
            // Синхронизация с Firebase
            document.getElementById('sync-firebase-btn').addEventListener('click', function() {
                saveToFirebase();
            });
            
            // Генерация отчета
            document.getElementById('generate-report-btn').addEventListener('click', function() {
                generateReport();
            });
            
            // Сохранение отчета
            document.getElementById('save-report-btn').addEventListener('click', function() {
                saveReport();
            });
            
            // Выгрузка в Excel
            document.getElementById('export-excel-btn').addEventListener('click', function() {
                exportReportToExcel();
            });
            
            // Резервное копирование
            document.getElementById('backup-btn').addEventListener('click', function() {
                exportData(true);
            });
            
            // Восстановление из резервной копии
            document.getElementById('restore-btn').addEventListener('click', function() {
                document.getElementById('restore-file').click();
            });
            
            document.getElementById('restore-file').addEventListener('change', function(e) {
                importData(e, true);
            });
            
            // Управление резервом
            document.getElementById('add-reserve-btn').addEventListener('click', function() {
                showReserveModal('add');
            });
            
            document.getElementById('withdraw-reserve-btn').addEventListener('click', function() {
                showReserveModal('withdraw');
            });
            
            document.getElementById('cancel-reserve-btn').addEventListener('click', function() {
                hideReserveModal();
            });
            
            document.getElementById('cancel-reserve-btn2').addEventListener('click', function() {
                hideReserveModal();
            });
            
            document.getElementById('save-reserve-btn').addEventListener('click', function() {
                saveReserveTransaction();
            });

            // Обработчики для сохраненных расходов
            document.getElementById('add-saved-expense-btn').addEventListener('click', function() {
                addSavedExpense();
            });

            document.getElementById('update-saved-expense-btn').addEventListener('click', function() {
                updateSavedExpense();
            });

            document.getElementById('cancel-edit-saved-expense-btn').addEventListener('click', function() {
                cancelEditSavedExpense();
            });

            // Обработчики для аутентификации
            document.getElementById('login-btn').addEventListener('click', function() {
                showAuthModal();
            });
            
            document.getElementById('logout-btn').addEventListener('click', function() {
                auth.signOut();
            });
            
            document.getElementById('close-auth-btn').addEventListener('click', function() {
                hideAuthModal();
            });
            
            document.getElementById('login-submit-btn').addEventListener('click', function() {
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                
                if (!email || !password) {
                    showFirebaseStatus('Заполните все поля', 'error');
                    return;
                }
                
                auth.signInWithEmailAndPassword(email, password)
                    .then((userCredential) => {
                        hideAuthModal();
                        showFirebaseStatus('Успешный вход', 'success');
                    })
                    .catch((error) => {
                        showFirebaseStatus(`Ошибка входа: ${error.message}`, 'error');
                    });
            });
            
            document.getElementById('register-submit-btn').addEventListener('click', function() {
                const email = document.getElementById('register-email').value;
                const password = document.getElementById('register-password').value;
                const confirmPassword = document.getElementById('register-confirm-password').value;
                
                if (!email || !password || !confirmPassword) {
                    showFirebaseStatus('Заполните все поля', 'error');
                    return;
                }
                
                if (password !== confirmPassword) {
                    showFirebaseStatus('Пароли не совпадают', 'error');
                    return;
                }
                
                if (password.length < 6) {
                    showFirebaseStatus('Пароль должен содержать минимум 6 символов', 'error');
                    return;
                }
                
                auth.createUserWithEmailAndPassword(email, password)
                    .then((userCredential) => {
                        hideAuthModal();
                        showFirebaseStatus('Успешная регистрация', 'success');
                    })
                    .catch((error) => {
                        showFirebaseStatus(`Ошибка регистрации: ${error.message}`, 'error');
                    });
            });
        }

        // Обновление выпадающего списка сохраненных расходов
        function updateSavedExpenseSelect() {
            const select = document.getElementById('saved-expense-select');
            select.innerHTML = '<option value="">Выберите шаблон</option>';
            
            savedExpenses.forEach(expense => {
                const option = document.createElement('option');
                option.value = expense.id;
                option.textContent = `${expense.description} (${getCategoryLabel(expense.category)})`;
                select.appendChild(option);
            });
        }

        // Добавление сохраненного расхода
        function addSavedExpense() {
            const category = document.getElementById('saved-expense-category').value;
            const payment = document.getElementById('saved-expense-payment').value;
            const amount = document.getElementById('saved-expense-amount').value;
            const description = document.getElementById('saved-expense-description').value;
            const expenseCategory = document.getElementById('saved-expense-category-type').value;
            
            if (!category || !payment || !description) {
                alert('Пожалуйста, заполните все обязательные поля');
                return;
            }
            
            const newSavedExpense = {
                id: Date.now().toString(),
                category,
                payment,
                amount: amount ? parseFloat(amount) : null,
                description,
                expenseCategory,
                createdAt: new Date().toISOString()
            };
            
            savedExpenses.push(newSavedExpense);
            
            localStorage.setItem('carwash_saved_expenses', JSON.stringify(savedExpenses));
            
            if (currentUser) {
                saveToFirebase();
            }
            
            document.getElementById('saved-expense-category').value = '';
            document.getElementById('saved-expense-payment').value = '';
            document.getElementById('saved-expense-amount').value = '';
            document.getElementById('saved-expense-description').value = '';
            document.getElementById('saved-expense-category-type').value = '';
            
            renderSavedExpenses();
            
            alert('Шаблон расхода успешно сохранен!');
        }

        // Редактирование сохраненного расхода
        function editSavedExpense(id) {
            const expense = savedExpenses.find(exp => exp.id === id);
            if (!expense) return;
            
            editingSavedExpenseId = id;
            
            document.getElementById('saved-expense-category').value = expense.category;
            document.getElementById('saved-expense-payment').value = expense.payment;
            document.getElementById('saved-expense-amount').value = expense.amount || '';
            document.getElementById('saved-expense-description').value = expense.description;
            document.getElementById('saved-expense-category-type').value = expense.expenseCategory || '';
            
            document.getElementById('saved-expense-form-title').textContent = 'Редактировать сохраненный расход';
            document.getElementById('add-saved-expense-btn').style.display = 'none';
            document.getElementById('update-saved-expense-btn').style.display = 'inline-block';
            document.getElementById('cancel-edit-saved-expense-btn').style.display = 'inline-block';
            
            // Прокручиваем к форме
            document.getElementById('saved-expense-form').scrollIntoView({ behavior: 'smooth' });
        }

        // Обновление сохраненного расхода
        function updateSavedExpense() {
            if (!editingSavedExpenseId) return;
            
            const category = document.getElementById('saved-expense-category').value;
            const payment = document.getElementById('saved-expense-payment').value;
            const amount = document.getElementById('saved-expense-amount').value;
            const description = document.getElementById('saved-expense-description').value;
            const expenseCategory = document.getElementById('saved-expense-category-type').value;
            
            if (!category || !payment || !description) {
                alert('Пожалуйста, заполните все обязательные поля');
                return;
            }
            
            const index = savedExpenses.findIndex(exp => exp.id === editingSavedExpenseId);
            if (index !== -1) {
                savedExpenses[index] = {
                    ...savedExpenses[index],
                    category,
                    payment,
                    amount: amount ? parseFloat(amount) : null,
                    description,
                    expenseCategory
                };
                
                localStorage.setItem('carwash_saved_expenses', JSON.stringify(savedExpenses));
                
                if (currentUser) {
                    saveToFirebase();
                }
                
                cancelEditSavedExpense();
                renderSavedExpenses();
                
                alert('Шаблон расхода успешно обновлен!');
            }
        }

        // Отмена редактирования сохраненного расхода
        function cancelEditSavedExpense() {
            editingSavedExpenseId = null;
            
            document.getElementById('saved-expense-category').value = '';
            document.getElementById('saved-expense-payment').value = '';
            document.getElementById('saved-expense-amount').value = '';
            document.getElementById('saved-expense-description').value = '';
            document.getElementById('saved-expense-category-type').value = '';
            
            document.getElementById('saved-expense-form-title').textContent = 'Добавить новый сохраненный расход';
            document.getElementById('add-saved-expense-btn').style.display = 'inline-block';
            document.getElementById('update-saved-expense-btn').style.display = 'none';
            document.getElementById('cancel-edit-saved-expense-btn').style.display = 'none';
        }

        // Удаление сохраненного расхода
        function deleteSavedExpense(id) {
            if (confirm('Вы уверены, что хотите удалить этот шаблон расхода?')) {
                savedExpenses = savedExpenses.filter(exp => exp.id !== id);
                
                localStorage.setItem('carwash_saved_expenses', JSON.stringify(savedExpenses));
                
                if (currentUser) {
                    saveToFirebase();
                }
                
                renderSavedExpenses();
            }
        }

        // Отображение сохраненных расходов в виде таблицы
        function renderSavedExpenses() {
            const tbody = document.getElementById('saved-expenses-body');
            
            if (savedExpenses.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px;">Нет сохраненных шаблонов расходов</td></tr>';
                return;
            }
            
            tbody.innerHTML = '';
            
            savedExpenses.forEach(expense => {
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${expense.description}</td>
                    <td>${getCategoryLabel(expense.category)}</td>
                    <td>${getPaymentLabel(expense.payment)}</td>
                    <td>${expense.amount ? expense.amount.toFixed(2) + ' руб.' : '-'}</td>
                    <td>${expense.expenseCategory ? getExpenseCategoryName(expense.expenseCategory) : 'Автоматически'}</td>
                    <td>
                        <button onclick="useSavedExpense('${expense.id}')">Использовать</button>
                        <button onclick="editSavedExpense('${expense.id}')">Редактировать</button>
                        <button onclick="deleteSavedExpense('${expense.id}')" class="btn-danger">Удалить</button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }

        // Использование сохраненного расхода
        function useSavedExpense(id) {
            const expense = savedExpenses.find(exp => exp.id === id);
            if (!expense) return;
            
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            document.querySelector('.tab[data-tab="transactions"]').classList.add('active');
            document.getElementById('transactions').classList.add('active');
            
            showTransactionModal();
            
            document.getElementById('transaction-type').value = 'expense';
            document.getElementById('transaction-category').value = expense.category;
            document.getElementById('transaction-payment').value = expense.payment;
            document.getElementById('transaction-amount').value = expense.amount || '';
            document.getElementById('transaction-description').value = expense.description;
            document.getElementById('transaction-expense-category').value = expense.expenseCategory || '';
            
            // Обновляем видимость полей
            document.getElementById('expense-category-group').style.display = 'block';
            document.getElementById('saved-expense-group').style.display = 'block';
            
            // Обновляем автоматическую категорию
            const autoCategory = classifyExpense(expense.description);
            document.getElementById('expense-category-auto').textContent = `Автоматически: ${getExpenseCategoryName(autoCategory)}`;
            
            // Обновляем список сохраненных расходов
            updateSavedExpenseSelect();
        }
        
        // Показать модальное окно операции
        function showTransactionModal(id = null) {
            editingId = id;
            const modal = document.getElementById('transaction-modal');
            const title = document.getElementById('modal-title');
            const expenseCategoryGroup = document.getElementById('expense-category-group');
            const savedExpenseGroup = document.getElementById('saved-expense-group');
            
            if (id) {
                title.textContent = 'Редактировать операцию';
                const transaction = transactions.find(t => t.id === id);
                
                document.getElementById('transaction-date').value = transaction.date;
                document.getElementById('transaction-type').value = transaction.type;
                document.getElementById('transaction-category').value = transaction.category;
                document.getElementById('transaction-payment').value = transaction.payment;
                document.getElementById('transaction-amount').value = transaction.amount;
                document.getElementById('transaction-description').value = transaction.description || '';
                
                // Устанавливаем значение категории расходов, если операция - расход
                if (transaction.type === 'expense') {
                    expenseCategoryGroup.style.display = 'block';
                    savedExpenseGroup.style.display = 'block';
                    document.getElementById('transaction-expense-category').value = transaction.manualExpenseCategory || '';
                    
                    // Показываем автоматическую категорию
                    const autoCategory = classifyExpense(transaction.description);
                    document.getElementById('expense-category-auto').textContent = `Автоматически: ${getExpenseCategoryName(autoCategory)}`;
                    
                    // Обновляем список сохраненных расходов
                    updateSavedExpenseSelect();
                } else {
                    expenseCategoryGroup.style.display = 'none';
                    savedExpenseGroup.style.display = 'none';
                }
            } else {
                title.textContent = 'Добавить операцию';
                document.getElementById('transaction-date').value = new Date().toISOString().split('T')[0];
                document.getElementById('transaction-type').value = '';
                document.getElementById('transaction-category').value = '';
                document.getElementById('transaction-payment').value = '';
                document.getElementById('transaction-amount').value = '';
                document.getElementById('transaction-description').value = '';
                document.getElementById('transaction-expense-category').value = '';
                expenseCategoryGroup.style.display = 'none';
                savedExpenseGroup.style.display = 'none';
            }
            
            modal.style.display = 'flex';
        }
        
        // Скрыть модальное окно операции
        function hideTransactionModal() {
            document.getElementById('transaction-modal').style.display = 'none';
            editingId = null;
        }
        
        // Показать модальное окно резерва
        function showReserveModal(action) {
            reserveAction = action;
            const modal = document.getElementById('reserve-modal');
            const title = document.getElementById('reserve-modal-title');
            
            if (action === 'add') {
                title.textContent = 'Пополнение резервного фонда';
            } else {
                title.textContent = 'Списание с резервного фонда';
            }
            
            document.getElementById('reserve-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('reserve-amount-input').value = '';
            document.getElementById('reserve-description').value = '';
            
            modal.style.display = 'flex';
        }
        
        // Скрыть модальное окно резерва
        function hideReserveModal() {
            document.getElementById('reserve-modal').style.display = 'none';
            reserveAction = null;
        }
        
        // Сохранить операцию с резервом
        function saveReserveTransaction() {
            const date = document.getElementById('reserve-date').value;
            const amount = parseFloat(document.getElementById('reserve-amount-input').value);
            const description = document.getElementById('reserve-description').value;
            
            if (!date || !amount || amount <= 0) {
                alert('Пожалуйста, заполните все обязательные поля');
                return;
            }
            
            if (reserveAction === 'add') {
                reserveBalance += amount;
                
                // Добавляем запись о пополнении резерва
                const newTransaction = {
                    id: Date.now().toString(),
                    date: date,
                    type: 'expense',
                    category: 'reserve',
                    payment: 'reserve',
                    amount: amount,
                    description: description || 'Пополнение резервного фонда',
                    createdAt: new Date().toISOString(),
                    manualExpenseCategory: null
                };
                
                transactions.push(newTransaction);
            } else {
                reserveBalance -= amount;
                
                // Добавляем запись о списании с резерва
                const newTransaction = {
                    id: Date.now().toString(),
                    date: date,
                    type: 'income',
                    category: 'reserve',
                    payment: 'reserve',
                    amount: amount,
                    description: description || 'Списание с резервного фонда',
                    createdAt: new Date().toISOString(),
                    manualExpenseCategory: null
                };
                
                transactions.push(newTransaction);
            }
            
            // Сохраняем в localStorage
            localStorage.setItem('carwash_reserve', reserveBalance.toString());
            localStorage.setItem('carwash_transactions', JSON.stringify(transactions));
            
            // Сохраняем в Firebase, если пользователь авторизован
            if (currentUser) {
                saveToFirebase();
            }
            
            // Обновляем интерфейс
            hideReserveModal();
            updateReserveDisplay();
            renderTransactions();
            updateDashboard();
        }
        
        // Обновление отображения резерва
        function updateReserveDisplay() {
            const reserveElement = document.getElementById('reserve-amount');
            reserveElement.textContent = `${reserveBalance.toFixed(2)} руб.`;
            
            // Добавляем визуальное отображение изменений
            if (reserveBalance < 0) {
                reserveElement.className = 'settlement-amount card-negative';
            } else if (reserveBalance === 0) {
                reserveElement.className = 'settlement-amount card-neutral';
            } else if (reserveBalance < 10000) {
                reserveElement.className = 'settlement-amount card-warning';
            } else {
                reserveElement.className = 'settlement-amount card-positive';
            }
        }
        
        // Сохранить операцию
        function saveTransaction() {
            const date = document.getElementById('transaction-date').value;
            const type = document.getElementById('transaction-type').value;
            const category = document.getElementById('transaction-category').value;
            const payment = document.getElementById('transaction-payment').value;
            const amount = parseFloat(document.getElementById('transaction-amount').value);
            const description = document.getElementById('transaction-description').value;
            const expenseCategory = document.getElementById('transaction-expense-category').value;
            
            if (!date || !type || !category || !payment || !amount) {
                alert('Пожалуйста, заполните все обязательные поля');
                return;
            }
            
            if (editingId) {
                // Редактирование существующей операции
                const index = transactions.findIndex(t => t.id === editingId);
                if (index !== -1) {
                    transactions[index] = {
                        ...transactions[index],
                        date,
                        type,
                        category,
                        payment,
                        amount,
                        description,
                        manualExpenseCategory: type === 'expense' ? (expenseCategory || null) : null
                    };
                }
            } else {
                // Добавление новой операции
                const newTransaction = {
                    id: Date.now().toString(),
                    date,
                    type,
                    category,
                    payment,
                    amount,
                    description,
                    manualExpenseCategory: type === 'expense' ? (expenseCategory || null) : null,
                    createdAt: new Date().toISOString()
                };
                
                transactions.push(newTransaction);
            }
            
            // Сохраняем в localStorage
            localStorage.setItem('carwash_transactions', JSON.stringify(transactions));
            
            // Сохраняем в Firebase, если пользователь авторизован
            if (currentUser) {
                saveToFirebase();
            }
            
            // Обновляем интерфейс
            hideTransactionModal();
            renderTransactions();
            updateDashboard();
        }
        
        // Удалить операцию
        function deleteTransaction(id) {
            if (confirm('Вы уверены, что хотите удалить эту операцию?')) {
                transactions = transactions.filter(t => t.id !== id);
                localStorage.setItem('carwash_transactions', JSON.stringify(transactions));
                
                // Сохраняем в Firebase, если пользователь авторизован
                if (currentUser) {
                    saveToFirebase();
                }
                
                renderTransactions();
                updateDashboard();
            }
        }
        
        // Отображение списка операций
        function renderTransactions() {
            const tbody = document.getElementById('transactions-body');
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const filterType = document.getElementById('filter-type').value;
            const filterCategory = document.getElementById('filter-category').value;
            const filterPayment = document.getElementById('filter-payment').value;
            const filterPeriod = document.getElementById('filter-period').value;
            
            // Фильтрация операций
            let filteredTransactions = transactions;
            
            // Поиск по описанию
            if (searchTerm) {
                filteredTransactions = filteredTransactions.filter(t => 
                    t.description && t.description.toLowerCase().includes(searchTerm)
                );
            }
            
            // Фильтр по типу
            if (filterType) {
                filteredTransactions = filteredTransactions.filter(t => t.type === filterType);
            }
            
            // Фильтр по категории
            if (filterCategory) {
                filteredTransactions = filteredTransactions.filter(t => t.category === filterCategory);
            }
            
            // Фильтр по способу оплаты
            if (filterPayment) {
                filteredTransactions = filteredTransactions.filter(t => t.payment === filterPayment);
            }
            
            // Фильтр по периоду
            if (filterPeriod && filterPeriod !== 'all') {
                const now = new Date();
                let startDate, endDate;
                
                switch (filterPeriod) {
                    case 'current_month':
                        startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                        endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59, 999);
                        break;
                    case 'last_month':
                        startDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                        endDate = new Date(now.getFullYear(), now.getMonth(), 0, 23, 59, 59, 999);
                        break;
                    case 'last_3_months':
                        startDate = new Date(now.getFullYear(), now.getMonth() - 3, 1);
                        endDate = new Date(now.getFullYear(), now.getMonth(), 0, 23, 59, 59, 999);
                        break;
                }
                
                filteredTransactions = filteredTransactions.filter(t => {
                    const transactionDate = new Date(t.date);
                    return transactionDate >= startDate && transactionDate <= endDate;
                });
            }
            
            // Сортировка по дате (новые сверху)
            filteredTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            if (filteredTransactions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center;">Нет операций</td></tr>';
                return;
            }
            
            tbody.innerHTML = '';
            
            filteredTransactions.forEach(transaction => {
                const row = document.createElement('tr');
                
                // Подсветка при поиске
                let description = transaction.description || '';
                if (searchTerm && description.toLowerCase().includes(searchTerm)) {
                    const regex = new RegExp(`(${searchTerm})`, 'gi');
                    description = description.replace(regex, '<span class="highlight">$1</span>');
                }
                
                // Определяем категорию расходов для отображения
                let expenseCategoryDisplay = '';
                if (transaction.type === 'expense') {
                    const manualCategory = transaction.manualExpenseCategory;
                    if (manualCategory) {
                        expenseCategoryDisplay = getExpenseCategoryName(manualCategory) + ' (ручная)';
                    } else {
                        const autoCategory = classifyExpense(transaction.description);
                        expenseCategoryDisplay = getExpenseCategoryName(autoCategory) + ' (авто)';
                    }
                }
                
                row.innerHTML = `
                    <td>${formatDate(transaction.date)}</td>
                    <td>${getTypeLabel(transaction.type)}</td>
                    <td>${getCategoryLabel(transaction.category)}</td>
                    <td>${getPaymentLabel(transaction.payment)}</td>
                    <td>${transaction.amount.toFixed(2)} руб.</td>
                    <td>${description}</td>
                    <td>${expenseCategoryDisplay}</td>
                    <td>
                        <button onclick="showTransactionModal('${transaction.id}')">Редактировать</button>
                        <button onclick="deleteTransaction('${transaction.id}')" class="btn-danger">Удалить</button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }

        // Фильтрация транзакций по периоду
        function filterTransactionsByPeriod() {
            const { startDate, endDate } = getPeriodDates();
            if (!startDate || !endDate) return transactions;
            
            return transactions.filter(t => {
                const transactionDate = new Date(t.date);
                return transactionDate >= startDate && transactionDate <= endDate;
            });
        }

        // Обновление дашборда
        function updateDashboard() {
            const filteredTransactions = filterTransactionsByPeriod();
            const { startDate, endDate } = getPeriodDates();
            
            const {
                detailingIncome, detailingExpense, detailingNet,
                self12Income, self12Expense, self12Net,
                self35Income, self35Expense, self35Net,
                chingizProfit, sultanProfit, totalProfit,
                mutualSettlement,
                reserveUsed
            } = calculateProfits(filteredTransactions, startDate, endDate);

            // Расширенный анализ прибыльности
            const advancedAnalysis = calculateAdvancedProfits(filteredTransactions);
            updateAdvancedAnalytics(advancedAnalysis);
            createMiniCharts(filteredTransactions, advancedAnalysis);
            createTrendCharts(); // Создаем графики динамики

            // Обновление интерфейса
            document.getElementById('detailing-profit-stat').textContent = `${detailingNet.toFixed(2)} руб.`;
            document.getElementById('detailing-margin-stat').textContent = `Маржа: ${advancedAnalysis.detailing.grossMargin.toFixed(1)}%`;
            
            document.getElementById('self12-profit-stat').textContent = `${self12Net.toFixed(2)} руб.`;
            document.getElementById('self12-margin-stat').textContent = `Маржа: ${advancedAnalysis.self12.grossMargin.toFixed(1)}%`;
            
            document.getElementById('self35-profit-stat').textContent = `${self35Net.toFixed(2)} руб.`;
            document.getElementById('self35-margin-stat').textContent = `Маржа: ${advancedAnalysis.self35.grossMargin.toFixed(1)}%`;
            
            // Обновление показателей рентабельности
            document.getElementById('detailing-profitability').textContent = `${advancedAnalysis.detailing.grossMargin.toFixed(1)}%`;
            document.getElementById('self12-profitability').textContent = `${advancedAnalysis.self12.grossMargin.toFixed(1)}%`;
            document.getElementById('self35-profitability').textContent = `${advancedAnalysis.self35.grossMargin.toFixed(1)}%`;
            
            document.getElementById('chingiz-profit-stat').textContent = `${chingizProfit.toFixed(2)} руб.`;
            document.getElementById('sultan-profit-stat').textContent = `${sultanProfit.toFixed(2)} руб.`;
            document.getElementById('total-profit-stat').textContent = `${totalProfit.toFixed(2)} руб.`;
            
            document.getElementById('settlement-amount').textContent = `${Math.abs(mutualSettlement).toFixed(2)} руб.`;
            
            // ОБНОВЛЯЕМ ОТОБРАЖЕНИЕ РЕЗЕРВА
            updateReserveDisplay();
            
            // ОБНОВЛЯЕМ ИНФОРМАЦИЮ ОБ ИСПОЛЬЗОВАНИИ РЕЗЕРВА
            document.getElementById('reserve-used-info').textContent = `Использовано в периоде: ${reserveUsed.toFixed(2)} руб.`;
            
            // ДОБАВЛЯЕМ ИНФОРМАЦИЮ О ВЗАИМНЫХ РАСЧЕТАХ
            const settlementText = document.getElementById('settlement-text');
            if (mutualSettlement > 0) {
                settlementText.textContent = 'Султан (собственник) должен перевести Чингизу (управляющему)';
                document.getElementById('settlement-amount').className = 'settlement-amount card-positive';
            } else if (mutualSettlement < 0) {
                settlementText.textContent = 'Чингиз (управляющий) должен перевести Султану (собственнику)';
                document.getElementById('settlement-amount').className = 'settlement-amount card-negative';
            } else {
                settlementText.textContent = 'Расчеты сбалансированы';
                document.getElementById('settlement-amount').className = 'settlement-amount card-neutral';
            }
        }
        
        // Создание графиков динамики за 6 месяцев
        function createTrendCharts() {
            const now = new Date();
            const months = [];
            const monthNames = [];
            
            // Создаем массив последних 6 месяцев
            for (let i = 5; i >= 0; i--) {
                const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
                months.push(date);
                monthNames.push(date.toLocaleDateString('ru-RU', { month: 'short', year: '2-digit' }));
            }
            
            // Данные для графиков
            const incomeData = [];
            const expenseData = [];
            const detailingIncomeData = [];
            const self12IncomeData = [];
            const self35IncomeData = [];
            const detailingExpenseData = [];
            const self12ExpenseData = [];
            const self35ExpenseData = [];
            
            // Собираем данные за каждый месяц
            months.forEach(month => {
                const startDate = new Date(month.getFullYear(), month.getMonth(), 1);
                const endDate = new Date(month.getFullYear(), month.getMonth() + 1, 0, 23, 59, 59, 999);
                
                const monthTransactions = transactions.filter(t => {
                    const transactionDate = new Date(t.date);
                    return transactionDate >= startDate && transactionDate <= endDate;
                });
                
                // Общие доходы и расходы
                const monthIncome = monthTransactions
                    .filter(t => t.type === 'income')
                    .reduce((sum, t) => sum + t.amount, 0);
                
                const monthExpense = monthTransactions
                    .filter(t => t.type === 'expense')
                    .reduce((sum, t) => sum + t.amount, 0);
                
                incomeData.push(monthIncome);
                expenseData.push(monthExpense);
                
                // Доходы по направлениям
                const detailingIncome = monthTransactions
                    .filter(t => t.type === 'income' && t.category === 'detailing')
                    .reduce((sum, t) => sum + t.amount, 0);
                
                const self12Income = monthTransactions
                    .filter(t => t.type === 'income' && t.category === 'self12')
                    .reduce((sum, t) => sum + t.amount, 0);
                
                const self35Income = monthTransactions
                    .filter(t => t.type === 'income' && t.category === 'self35')
                    .reduce((sum, t) => sum + t.amount, 0);
                
                detailingIncomeData.push(detailingIncome);
                self12IncomeData.push(self12Income);
                self35IncomeData.push(self35Income);
                
                // Расходы по направлениям
                const detailingExpense = monthTransactions
                    .filter(t => t.type === 'expense' && t.category === 'detailing')
                    .reduce((sum, t) => sum + t.amount, 0);
                
                const self12Expense = monthTransactions
                    .filter(t => t.type === 'expense' && t.category === 'self12')
                    .reduce((sum, t) => sum + t.amount, 0);
                
                const self35Expense = monthTransactions
                    .filter(t => t.type === 'expense' && t.category === 'self35')
                    .reduce((sum, t) => sum + t.amount, 0);
                
                detailingExpenseData.push(detailingExpense);
                self12ExpenseData.push(self12Expense);
                self35ExpenseData.push(self35Expense);
            });
            
            // График динамики доходов
            const incomeTrendCtx = document.getElementById('incomeTrendChart').getContext('2d');
            if (incomeTrendChart) incomeTrendChart.destroy();
            
            incomeTrendChart = new Chart(incomeTrendCtx, {
                type: 'line',
                data: {
                    labels: monthNames,
                    datasets: [
                        {
                            label: 'Доходы',
                            data: incomeData,
                            borderColor: '#4A6FA5',
                            backgroundColor: 'rgba(74, 111, 165, 0.1)',
                            tension: 0.3,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
            
            // График динамики расходов
            const expenseTrendCtx = document.getElementById('expenseTrendChart').getContext('2d');
            if (expenseTrendChart) expenseTrendChart.destroy();
            
            expenseTrendChart = new Chart(expenseTrendCtx, {
                type: 'line',
                data: {
                    labels: monthNames,
                    datasets: [
                        {
                            label: 'Расходы',
                            data: expenseData,
                            borderColor: '#D9534F',
                            backgroundColor: 'rgba(217, 83, 79, 0.1)',
                            tension: 0.3,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
            
            // График динамики доходов по направлениям
            const incomeByCategoryTrendCtx = document.getElementById('incomeByCategoryTrendChart').getContext('2d');
            if (incomeByCategoryTrendChart) incomeByCategoryTrendChart.destroy();
            
            incomeByCategoryTrendChart = new Chart(incomeByCategoryTrendCtx, {
                type: 'bar',
                data: {
                    labels: monthNames,
                    datasets: [
                        {
                            label: 'Детейлинг',
                            data: detailingIncomeData,
                            backgroundColor: '#8E44AD'
                        },
                        {
                            label: 'Посты 1-2',
                            data: self12IncomeData,
                            backgroundColor: '#17A2B8'
                        },
                        {
                            label: 'Посты 3-5',
                            data: self35IncomeData,
                            backgroundColor: '#F0AD4E'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
            
            // График динамики расходов по направлениям
            const expenseByCategoryTrendCtx = document.getElementById('expenseByCategoryTrendChart').getContext('2d');
            if (expenseByCategoryTrendChart) expenseByCategoryTrendChart.destroy();
            
            expenseByCategoryTrendChart = new Chart(expenseByCategoryTrendCtx, {
                type: 'bar',
                data: {
                    labels: monthNames,
                    datasets: [
                        {
                            label: 'Детейлинг',
                            data: detailingExpenseData,
                            backgroundColor: '#8E44AD'
                        },
                        {
                            label: 'Посты 1-2',
                            data: self12ExpenseData,
                            backgroundColor: '#17A2B8'
                        },
                        {
                            label: 'Посты 3-5',
                            data: self35ExpenseData,
                            backgroundColor: '#F0AD4E'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        // Создание мини-графиков для нового дизайна дашборда
        function createMiniCharts(transactions, analysisData) {
            const { detailing, self12, self35 } = analysisData;

            // График доходов по категориям
            const incomeCtx = document.getElementById('incomeChart').getContext('2d');
            if (incomeChart) incomeChart.destroy();
            
            incomeChart = new Chart(incomeCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Детейлинг', 'Посты 1-2', 'Посты 3-5'],
                    datasets: [{
                        data: [detailing.income, self12.income, self35.income],
                        backgroundColor: ['#4A6FA5', '#6B8E23', '#F0AD4E']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });

            // График расходов по категориям
            const expenseCtx = document.getElementById('expenseChart').getContext('2d');
            if (expenseChart) expenseChart.destroy();
            
            expenseChart = new Chart(expenseCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Детейлинг', 'Посты 1-2', 'Посты 3-5'],
                    datasets: [{
                        data: [detailing.operatingExpenses, self12.operatingExpenses, self35.operatingExpenses],
                        backgroundColor: ['#4A6FA5', '#6B8E23', '#F0AD4E']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });

            // График прибыли по направлениям
            const profitCtx = document.getElementById('profitChart').getContext('2d');
            if (profitChart) profitChart.destroy();
            
            profitChart = new Chart(profitCtx, {
                type: 'bar',
                data: {
                    labels: ['Детейлинг', 'Посты 1-2', 'Посты 3-5'],
                    datasets: [{
                        label: 'Чистая прибыль',
                        data: [detailing.netProfit, self12.netProfit, self35.netProfit],
                        backgroundColor: ['#4A6FA5', '#6B8E23', '#F0AD4E']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            // График способов оплаты
            const paymentMethods = {
                'sultan_akbars': 0,
                'sultan_sber': 0,
                'chingiz_cash': 0,
                'chingiz_card': 0,
                'sultan_sber_cash': 0,
                'chingiz_cash_self': 0,
                'reserve': 0
            };
            
            transactions
                .filter(t => t.type === 'income')
                .forEach(t => {
                    if (paymentMethods.hasOwnProperty(t.payment)) {
                        paymentMethods[t.payment] += t.amount;
                    }
                });
            
            const paymentCtx = document.getElementById('paymentChart').getContext('2d');
            if (paymentChart) paymentChart.destroy();
            
            paymentChart = new Chart(paymentCtx, {
                type: 'pie',
                data: {
                    labels: [
                        'Счет АББ Султана',
                        'Счет Сбер/Яндекс Султана',
                        'Наличные (Чингиз)',
                        'Счет Чингиза',
                        'Счет Сбер (Султан)',
                        'Наличные (Чингиз) - самооб.',
                        'Резерв'
                    ],
                    datasets: [{
                        data: [
                            paymentMethods.sultan_akbars,
                            paymentMethods.sultan_sber,
                            paymentMethods.chingiz_cash,
                            paymentMethods.chingiz_card,
                            paymentMethods.sultan_sber_cash,
                            paymentMethods.chingiz_cash_self,
                            paymentMethods.reserve
                        ],
                        backgroundColor: [
                            '#4A6FA5',
                            '#3A5A8C',
                            '#D9534F',
                            '#C9302C',
                            '#8E44AD',
                            '#7D3C98',
                            '#F0AD4E'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            }
                    }
                }
            });
        }

// Расширенный расчет прибыли с детализацией
function calculateAdvancedProfits(transactions) {
    // Инициализация структур данных с ВСЕМИ категориями расходов
    const initCategoryData = () => ({
        income: 0,
        operatingExpenses: 0,
        cogs: 0,
        directCosts: 0,
        indirectCosts: 0,
        fixedCosts: 0,
        variableCosts: 0
    });

    const analysis = {
        detailing: initCategoryData(),
        self12: initCategoryData(),
        self35: initCategoryData()
    };

    // Сопоставление между ключами классификации и свойствами объекта
    const categoryMapping = {
        'cogs': 'cogs',
        'direct': 'directCosts', 
        'indirect': 'indirectCosts',
        'fixed': 'fixedCosts',
        'variable': 'variableCosts'
    };

    // Расчет доходов и расходов по категориям
    transactions.forEach(transaction => {
        const { type, category, amount, description, manualExpenseCategory } = transaction;
        
        if (type === 'income') {
            if (category === 'detailing') analysis.detailing.income += amount;
            if (category === 'self12') analysis.self12.income += amount;
            if (category === 'self35') analysis.self35.income += amount;
        } else if (type === 'expense') {
            const expenseCategory = manualExpenseCategory || classifyExpense(description);
            const expenseAmount = amount;
            const analysisCategory = categoryMapping[expenseCategory] || 'variableCosts';
            
            // Добавляем к общим расходам
            if (category === 'detailing') {
                analysis.detailing.operatingExpenses += expenseAmount;
                analysis.detailing[analysisCategory] += expenseAmount;
            }
            if (category === 'self12') {
                analysis.self12.operatingExpenses += expenseAmount;
                analysis.self12[analysisCategory] += expenseAmount;
            }
            if (category === 'self35') {
                analysis.self35.operatingExpenses += expenseAmount;
                analysis.self35[analysisCategory] += expenseAmount;
            }
        }
    });

    // Расчет производных показателей
    ['detailing', 'self12', 'self35'].forEach(category => {
        const cat = analysis[category];
        cat.netProfit = cat.income - cat.operatingExpenses;
        cat.grossProfit = cat.income - cat.cogs;
        cat.grossMargin = cat.income > 0 ? (cat.grossProfit / cat.income) * 100 : 0;
        cat.netMargin = cat.income > 0 ? (cat.netProfit / cat.income) * 100 : 0;
    });

    // Расчет общих показателей
    analysis.totals = {
        totalIncome: analysis.detailing.income + analysis.self12.income + analysis.self35.income,
        totalCosts: analysis.detailing.operatingExpenses + analysis.self12.operatingExpenses + analysis.self35.operatingExpenses,
        totalProfit: analysis.detailing.netProfit + analysis.self12.netProfit + analysis.self35.netProfit,
        totalGrossProfit: analysis.detailing.grossProfit + analysis.self12.grossProfit + analysis.self35.grossProfit
    };

    analysis.totals.grossMargin = analysis.totals.totalIncome > 0 ? 
        (analysis.totals.totalGrossProfit / analysis.totals.totalIncome) * 100 : 0;
    analysis.totals.netMargin = analysis.totals.totalIncome > 0 ? 
        (analysis.totals.totalProfit / analysis.totals.totalIncome) * 100 : 0;

    return analysis;
}

        // Обновление расширенной аналитики на дашборде
        function updateAdvancedAnalytics(analysis) {
            document.getElementById('overall-margin').textContent = `${analysis.totals.grossMargin.toFixed(1)}%`;
            document.getElementById('gross-margin').textContent = `${analysis.totals.grossMargin.toFixed(1)}%`;
            document.getElementById('net-margin').textContent = `${analysis.totals.netMargin.toFixed(1)}%`;
        }

        // Основной расчет прибыли
        function calculateProfits(transactions, startDate, endDate) {
            let detailingIncome = 0;
            let detailingExpense = 0;
            let self12Income = 0;
            let self12Expense = 0;
            let self35Income = 0;
            let self35Expense = 0;
            let chingizIncome = 0;
            let chingizExpense = 0;
            let sultanIncome = 0;
            let sultanExpense = 0;
            
            // Фильтрация транзакций по дате
            let filteredTransactions = transactions;
            if (startDate && endDate) {
                filteredTransactions = transactions.filter(t => {
                    const transactionDate = new Date(t.date);
                    return transactionDate >= startDate && transactionDate <= endDate;
                });
            }
            
            // Расчет доходов и расходов по категориям
            filteredTransactions.forEach(transaction => {
                const { type, category, payment, amount } = transaction;
                
                if (type === 'income') {
                    if (category === 'detailing') detailingIncome += amount;
                    if (category === 'self12') self12Income += amount;
                    if (category === 'self35') self35Income += amount;
                    
                    // Доходы по счетам
                    if (payment === 'sultan_akbars' || payment === 'sultan_sber' || payment === 'sultan_sber_cash') {
                        sultanIncome += amount;
                    } else if (payment === 'chingiz_cash' || payment === 'chingiz_card' || payment === 'chingiz_cash_self') {
                        chingizIncome += amount;
                    }
                } else if (type === 'expense') {
                    if (category === 'detailing') detailingExpense += amount;
                    if (category === 'self12') self12Expense += amount;
                    if (category === 'self35') self35Expense += amount;
                    
                    // Расходы по счетам
                    if (payment === 'sultan_akbars' || payment === 'sultan_sber' || payment === 'sultan_sber_cash') {
                        sultanExpense += amount;
                    } else if (payment === 'chingiz_cash' || payment === 'chingiz_card' || payment === 'chingiz_cash_self') {
                        chingizExpense += amount;
                    }
                }
            });
            
            // Расчет чистой прибыли
            const detailingNet = detailingIncome - detailingExpense;
            const self12Net = self12Income - self12Expense;
            const self35Net = self35Income - self35Expense;
            
            // Расчет прибыли по условиям сотрудничества
            const chingizProfit = (detailingNet * 0.5) + (self12Net * 0.5);
            const sultanProfit = (detailingNet * 0.5) + (self12Net * 0.5) + self35Net;
            const totalProfit = detailingNet + self12Net + self35Net;
            
            // Расчет суммы для уравнивания прибыли
            // Если расчет показывает положительную сумму - Султан должен перевести Чингизу
            // Если расчет показывает отрицательную сумму - Чингиз должен перевести Султану
            const mutualSettlement = chingizProfit - (chingizIncome - chingizExpense);
            
            // Расчет использования резерва
            // Резерв используется, когда у Чингиза расходы превышают доходы
            const reserveUsed = Math.max(0, chingizExpense - chingizIncome);
            
            return {
                detailingIncome,
                detailingExpense,
                detailingNet,
                self12Income,
                self12Expense,
                self12Net,
                self35Income,
                self35Expense,
                self35Net,
                chingizIncome,
                chingizExpense,
                chingizProfit,
                sultanIncome,
                sultanExpense,
                sultanProfit,
                totalProfit,
                mutualSettlement,
                reserveUsed
            };
        }
        
        // Форматирование даты
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('ru-RU');
        }
        
        // Получить метку типа операции
        function getTypeLabel(type) {
            const labels = {
                'income': 'Доход',
                'expense': 'Расход'
            };
            return labels[type] || type;
        }
        
        // Получить метку категории
        function getCategoryLabel(category) {
            const labels = {
                'detailing': 'Детейлинг',
                'self12': 'Посты 1-2',
                'self35': 'Посты 3-5',
                'reserve': 'Резервный фонд'
            };
            return labels[category] || category;
        }
        
        // Получить метку способа оплаты
        function getPaymentLabel(payment) {
            const labels = {
                'sultan_akbars': 'Счет АББ Султана',
                'sultan_sber': 'Счет Сбер/Яндекс Султана',
                'chingiz_cash': 'Наличные (Чингиз)',
                'chingiz_card': 'Счет Чингиза',
                'sultan_sber_cash': 'Счет Сбер (Султан) - самообслуживание',
                'chingiz_cash_self': 'Наличные (Чингиз) - самообслуживание',
                'reserve': 'Резервный фонд Чингиза'
            };
            return labels[payment] || payment;
        }
        
        // Генерация отчета
        function generateReport() {
            const reportContent = document.getElementById('report-content');
            
            // Получаем даты периода для отчета
            const { startDate, endDate } = getReportPeriodDates();
            let periodLabel = '';
            
            // Создаем метку периода
            if (startDate && endDate) {
                periodLabel = `за период с ${formatDate(startDate)} по ${formatDate(endDate)}`;
            } else {
                periodLabel = 'за все время';
            }
            
            // Фильтруем транзакции по периоду отчета
            const reportTransactions = startDate && endDate ? 
                transactions.filter(t => {
                    const transactionDate = new Date(t.date);
                    return transactionDate >= startDate && transactionDate <= endDate;
                }) : 
                transactions;
            
            // Рассчитываем прибыль
            const {
                detailingIncome, detailingExpense, detailingNet,
                self12Income, self12Expense, self12Net,
                self35Income, self35Expense, self35Net,
                chingizIncome, chingizExpense, chingizProfit,
                sultanIncome, sultanExpense, sultanProfit,
                totalProfit,
                mutualSettlement,
                reserveUsed
            } = calculateProfits(reportTransactions, startDate, endDate);
            
            // Рассчитываем расширенную аналитику
            const analysisData = calculateAdvancedProfits(reportTransactions);
            
            // Рассчитываем детализацию по счетам
            const accountDetails = calculateAccountDetails(reportTransactions);
            
            // Генерируем HTML отчета
            let reportHTML = `
                <h2 style="color: var(--dark); margin-bottom: 20px;">Финансовый отчет ${periodLabel}</h2>
                
                <div class="summary-cards">
                    <div class="card detailing">
                        <h3>Детейлинг</h3>
                        <div class="card-value ${detailingNet >= 0 ? 'card-positive' : 'card-negative'}">${detailingNet.toFixed(2)} руб.</div>
                        <p>Доходы: ${detailingIncome.toFixed(2)} руб.</p>
                        <p>Расходы: ${detailingExpense.toFixed(2)} руб.</p>
                        <p>Маржа: ${analysisData.detailing.grossMargin.toFixed(1)}%</p>
                    </div>
                    
                    <div class="card self12">
                        <h3>Посты 1-2</h3>
                        <div class="card-value ${self12Net >= 0 ? 'card-positive' : 'card-negative'}">${self12Net.toFixed(2)} руб.</div>
                        <p>Доходы: ${self12Income.toFixed(2)} руб.</p>
                        <p>Расходы: ${self12Expense.toFixed(2)} руб.</p>
                        <p>Маржа: ${analysisData.self12.grossMargin.toFixed(1)}%</p>
                    </div>
                    
                    <div class="card self35">
                        <h3>Посты 3-5</h3>
                        <div class="card-value ${self35Net >= 0 ? 'card-positive' : 'card-negative'}">${self35Net.toFixed(2)} руб.</div>
                        <p>Доходы: ${self35Income.toFixed(2)} руб.</p>
                        <p>Расходы: ${self35Expense.toFixed(2)} руб.</p>
                        <p>Маржа: ${analysisData.self35.grossMargin.toFixed(1)}%</p>
                    </div>
                </div>
                
                <div class="profit-details">
                    <div class="settlement-card">
                        <h3>Взаимные расчеты</h3>
                        <p>Сумма для уравнивания прибыли</p>
                        <div class="settlement-amount ${mutualSettlement > 0 ? 'card-positive' : mutualSettlement < 0 ? 'card-negative' : 'card-neutral'}">${Math.abs(mutualSettlement).toFixed(2)} руб.</div>
                        <p>${mutualSettlement > 0 ? 'Султан (собственник) должен перевести Чингизу (управляющему)' : mutualSettlement < 0 ? 'Чингиз (управляющий) должен перевести Султану (собственнику)' : 'Расчеты сбалансированы'}</p>
                    </div>
                    
                    <div class="reserve-card">
                        <h3>Резервный фонд</h3>
                        <div class="settlement-amount">${reserveUsed.toFixed(2)} руб.</div>
                        <p>Использовано в периоде</p>
                        ${reserveUsed > 0 ? `<p><strong>Использовано в периоде: ${reserveUsed.toFixed(2)} руб.</strong></p>` : '<p>В данном периоде резервный фонд не использовался</p>'}
                    </div>
                    
                    <div class="card">
                        <h3>Прибыль собственника и управляющего</h3>
                        <div style="margin-top: 15px;">
                            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #E9ECEF;">
                                <span>Султан (собственник):</span>
                                <span>${sultanProfit.toFixed(2)} руб.</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #E9ECEF;">
                                <span>Чингиз (управляющий):</span>
                                <span>${chingizProfit.toFixed(2)} руб.</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 10px 0; border-top: 1px solid #E9ECEF; margin-top: 10px;">
                                <span><strong>Итого:</strong></span>
                                <span><strong>${totalProfit.toFixed(2)} руб.</strong></span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="section-title">Детализация по счетам</div>
                <div class="accounts-breakdown">
                    <div class="account-card">
                        <h4>Султан (собственник)</h4>
                        <div class="account-details">
                            <h5>Счет АББ - Детейлинг</h5>
                            <div class="account-item">
                                <span>Доходы:</span>
                                <span>${accountDetails.sultan.akbars.detailing.income.toFixed(2)} руб.</span>
                            </div>
                            <div class="account-item">
                                <span>Расходы:</span>
                                <span>${accountDetails.sultan.akbars.detailing.expense.toFixed(2)} руб.</span>
                            </div>
                            <div class="account-item">
                                <span>Баланс:</span>
                                <span>${(accountDetails.sultan.akbars.detailing.income - accountDetails.sultan.akbars.detailing.expense).toFixed(2)} руб.</span>
                            </div>
                        </div>
                        
                        <div class="account-details">
                            <h5>Счет Сбер/Яндекс - Детейлинг</h5>
                            <div class="account-item">
                                <span>Доходы:</span>
                                <span>${accountDetails.sultan.sber.detailing.income.toFixed(2)} руб.</span>
                            </div>
                            <div class="account-item">
                                <span>Расходы:</span>
                                <span>${accountDetails.sultan.sber.detailing.expense.toFixed(2)} руб.</span>
                            </div>
                            <div class="account-item">
                                <span>Баланс:</span>
                                <span>${(accountDetails.sultan.sber.detailing.income - accountDetails.sultan.sber.detailing.expense).toFixed(2)} руб.</span>
                            </div>
                        </div>
                        
                        <div class="account-details">
                            <h5>Счет Сбер - Самообслуживание</h5>
                            <div class="account-item">
                                <span>Посты 1-2 (доходы):</span>
                                <span>${accountDetails.sultan.sber_cash.self12.income.toFixed(2)} руб.</span>
                            </div>
                            <div class="account-item">
                                <span>Посты 1-2 (расходы):</span>
                                <span>${accountDetails.sultan.sber_cash.self12.expense.toFixed(2)} руб.</span>
                            </div>
                            <div class="account-item">
                                <span>Посты 3-5 (доходы):</span>
                                <span>${accountDetails.sultan.sber_cash.self35.income.toFixed(2)} руб.</span>
                            </div>
                            <div class="account-item">
                                <span>Посты 3-5 (расходы):</span>
                                <span>${accountDetails.sultan.sber_cash.self35.expense.toFixed(2)} руб.</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="account-card">
                        <h4>Чингиз (управляющий)</h4>
                        <div class="account-details">
                            <h5>Наличные - Детейлинг</h5>
                            <div class="account-item">
                                <span>Доходы:</span>
                                <span>${accountDetails.chingiz.cash.detailing.income.toFixed(2)} руб.</span>
                            </div>
                            <div class="account-item">
                                <span>Расходы:</span>
                                <span>${accountDetails.chingiz.cash.detailing.expense.toFixed(2)} руб.</span>
                            </div>
                            <div class="account-item">
                                <span>Баланс:</span>
                                <span>${(accountDetails.chingiz.cash.detailing.income - accountDetails.chingiz.cash.detailing.expense).toFixed(2)} руб.</span>
                            </div>
                        </div>
                        
                        <div class="account-details">
                            <h5>Счет - Детейлинг</h5>
                            <div class="account-item">
                                <span>Доходы:</span>
                                <span>${accountDetails.chingiz.card.detailing.income.toFixed(2)} руб.</span>
                            </div>
                            <div class="account-item">
                                <span>Расходы:</span>
                                <span>${accountDetails.chingiz.card.detailing.expense.toFixed(2)} руб.</span>
                            </div>
                            <div class="account-item">
                                <span>Баланс:</span>
                                <span>${(accountDetails.chingiz.card.detailing.income - accountDetails.chingiz.card.detailing.expense).toFixed(2)} руб.</span>
                            </div>
                        </div>
                        
                        <div class="account-details">
                            <h5>Наличные - Самообслуживание</h5>
                            <div class="account-item">
                                <span>Посты 1-2 (доходы):</span>
                                <span>${accountDetails.chingiz.cash_self.self12.income.toFixed(2)} руб.</span>
                            </div>
                            <div class="account-item">
                                <span>Посты 1-2 (расходы):</span>
                                <span>${accountDetails.chingiz.cash_self.self12.expense.toFixed(2)} руб.</span>
                            </div>
                            <div class="account-item">
                                <span>Посты 3-5 (доходы):</span>
                                <span>${accountDetails.chingiz.cash_self.self35.income.toFixed(2)} руб.</span>
                            </div>
                            <div class="account-item">
                                <span>Посты 3-5 (расходы):</span>
                                <span>${accountDetails.chingiz.cash_self.self35.expense.toFixed(2)} руб.</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="section-title">Анализ расходов по категориям</div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Направление</th>
                                <th>Себестоимость</th>
                                <th>Прямые затраты</th>
                                <th>Косвенные затраты</th>
                                <th>Постоянные затраты</th>
                                <th>Переменные затраты</th>
                                <th>Всего расходов</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Детейлинг</td>
                                <td>${analysisData.detailing.cogs.toFixed(2)} руб.</td>
                                <td>${analysisData.detailing.directCosts.toFixed(2)} руб.</td>
                                <td>${analysisData.detailing.indirectCosts.toFixed(2)} руб.</td>
                                <td>${analysisData.detailing.fixedCosts.toFixed(2)} руб.</td>
                                <td>${analysisData.detailing.variableCosts.toFixed(2)} руб.</td>
                                <td>${detailingExpense.toFixed(2)} руб.</td>
                            </tr>
                            <tr>
                                <td>Посты 1-2</td>
                                <td>${analysisData.self12.cogs.toFixed(2)} руб.</td>
                                <td>${analysisData.self12.directCosts.toFixed(2)} руб.</td>
                                <td>${analysisData.self12.indirectCosts.toFixed(2)} руб.</td>
                                <td>${analysisData.self12.fixedCosts.toFixed(2)} руб.</td>
                                <td>${analysisData.self12.variableCosts.toFixed(2)} руб.</td>
                                <td>${self12Expense.toFixed(2)} руб.</td>
                            </tr>
                            <tr>
                                <td>Посты 3-5</td>
                                <td>${analysisData.self35.cogs.toFixed(2)} руб.</td>
                                <td>${analysisData.self35.directCosts.toFixed(2)} руб.</td>
                                <td>${analysisData.self35.indirectCosts.toFixed(2)} руб.</td>
                                <td>${analysisData.self35.fixedCosts.toFixed(2)} руб.</td>
                                <td>${analysisData.self35.variableCosts.toFixed(2)} руб.</td>
                                <td>${self35Expense.toFixed(2)} руб.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="section-title">Детализация операций</div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Дата</th>
                                <th>Тип</th>
                                <th>Категория</th>
                                <th>Способ оплаты</th>
                                <th>Сумма</th>
                                <th>Описание</th>
                                <th>Категория расходов</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            // Добавляем строки с операциями
            const reportTransactionsSorted = [...reportTransactions].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            if (reportTransactionsSorted.length === 0) {
                reportHTML += `
                    <tr>
                        <td colspan="7" style="text-align: center;">Нет операций за выбранный период</td>
                    </tr>
                `;
            } else {
                reportTransactionsSorted.forEach(transaction => {
                    // Определяем категорию расходов для отображения
                    let expenseCategoryDisplay = '';
                    if (transaction.type === 'expense') {
                        const manualCategory = transaction.manualExpenseCategory;
                        if (manualCategory) {
                            expenseCategoryDisplay = getExpenseCategoryName(manualCategory) + ' (ручная)';
                        } else {
                            const autoCategory = classifyExpense(transaction.description);
                            expenseCategoryDisplay = getExpenseCategoryName(autoCategory) + ' (авто)';
                        }
                    }
                    
                    reportHTML += `
                        <tr>
                            <td>${formatDate(transaction.date)}</td>
                            <td>${getTypeLabel(transaction.type)}</td>
                            <td>${getCategoryLabel(transaction.category)}</td>
                            <td>${getPaymentLabel(transaction.payment)}</td>
                            <td>${transaction.amount.toFixed(2)} руб.</td>
                            <td>${transaction.description || ''}</td>
                            <td>${expenseCategoryDisplay}</td>
                        </tr>
                    `;
                });
            }
            
            reportHTML += `
                        </tbody>
                    </table>
                </div>
            `;
            
            reportContent.innerHTML = reportHTML;
            reportGenerated = true;
        }
        
        // Сохранение отчета
        function saveReport() {
            if (!reportGenerated) {
                alert('Сначала сформируйте отчет');
                return;
            }
            
            const reportContent = document.getElementById('report-content');
            const reportHTML = reportContent.innerHTML;
            
            // Создаем Blob с HTML-содержимым
            const blob = new Blob([`
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Финансовый отчет</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        .summary-cards { display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 30px; }
                        .card { border: 1px solid #ddd; padding: 15px; border-radius: 8px; flex: 1; min-width: 250px; }
                        .settlement-card { background: #4A6FA5; color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
                        .reserve-card { background: #F0AD4E; color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
                        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #f2f2f2; }
                        .section-title { font-size: 1.4rem; margin: 22px 0 12px; padding-bottom: 8px; border-bottom: 2px solid #E9ECEF; }
                        .accounts-breakdown { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
                        .account-card { border: 1px solid #ddd; padding: 15px; border-radius: 8px; }
                        .account-details { margin-top: 15px; }
                        .account-item { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #E9ECEF; }
                    </style>
                </head>
                <body>
                    ${reportHTML}
                </body>
                </html>
            `], { type: 'text/html' });
            
            // Создаем ссылку для скачивания
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `финансовый_отчет_${new Date().toISOString().split('T')[0]}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // Экспорт отчета в Excel
        function exportReportToExcel() {
            if (!reportGenerated) {
                alert('Сначала сформируйте отчет');
                return;
            }
            
            // Получаем даты периода для отчета
            const { startDate, endDate } = getReportPeriodDates();
            let periodLabel = '';
            
            // Создаем метку периода
            if (startDate && endDate) {
                periodLabel = `за период с ${formatDate(startDate)} по ${formatDate(endDate)}`;
            } else {
                periodLabel = 'за все время';
            }
            
            // Фильтруем транзакции по периоду отчета
            const reportTransactions = startDate && endDate ? 
                transactions.filter(t => {
                    const transactionDate = new Date(t.date);
                    return transactionDate >= startDate && transactionDate <= endDate;
                }) : 
                transactions;
            
            // Рассчитываем прибыль
            const {
                detailingIncome, detailingExpense, detailingNet,
                self12Income, self12Expense, self12Net,
                self35Income, self35Expense, self35Net,
                chingizIncome, chingizExpense, chingizProfit,
                sultanIncome, sultanExpense, sultanProfit,
                totalProfit,
                mutualSettlement
            } = calculateProfits(reportTransactions, startDate, endDate);
            
            // Рассчитываем расширенную аналитику
            const analysisData = calculateAdvancedProfits(reportTransactions);
            
            // Создаем книгу Excel
            const wb = XLSX.utils.book_new();
            
            // Лист с общей информацией
            const summaryData = [
                ['Финансовый отчет', periodLabel],
                [''],
                ['Направление', 'Доходы', 'Расходы', 'Чистая прибыль', 'Валовая маржа'],
                ['Детейлинг', detailingIncome, detailingExpense, detailingNet, `${analysisData.detailing.grossMargin.toFixed(1)}%`],
                ['Посты 1-2', self12Income, self12Expense, self12Net, `${analysisData.self12.grossMargin.toFixed(1)}%`],
                ['Посты 3-5', self35Income, self35Expense, self35Net, `${analysisData.self35.grossMargin.toFixed(1)}%`],
                [''],
                ['Прибыль собственника и управляющего'],
                ['Султан (собственник)', sultanProfit],
                ['Чингиз (управляющий)', chingizProfit],
                ['Итого', totalProfit],
                [''],
                ['Взаимные расчеты'],
                ['Сумма для уравнивания прибыли', Math.abs(mutualSettlement)],
                [mutualSettlement > 0 ? 'Султан должен перевести Чингизу' : mutualSettlement < 0 ? 'Чингиз должен перевести Султану' : 'Расчеты сбалансированы']
            ];
            
            const wsSummary = XLSX.utils.aoa_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, wsSummary, 'Общая информация');
            
            // Лист с анализом расходов
            const expenseAnalysisData = [
                ['Анализ расходов по категориям'],
                [''],
                ['Направление', 'Себестоимость', 'Прямые затраты', 'Косвенные затраты', 'Постоянные затраты', 'Переменные затраты', 'Всего расходов'],
                ['Детейлинг', analysisData.detailing.cogs, analysisData.detailing.directCosts, analysisData.detailing.indirectCosts, analysisData.detailing.fixedCosts, analysisData.detailing.variableCosts, detailingExpense],
                ['Посты 1-2', analysisData.self12.cogs, analysisData.self12.directCosts, analysisData.self12.indirectCosts, analysisData.self12.fixedCosts, analysisData.self12.variableCosts, self12Expense],
                ['Посты 3-5', analysisData.self35.cogs, analysisData.self35.directCosts, analysisData.self35.indirectCosts, analysisData.self35.fixedCosts, analysisData.self35.variableCosts, self35Expense]
            ];
            
            const wsExpenseAnalysis = XLSX.utils.aoa_to_sheet(expenseAnalysisData);
            XLSX.utils.book_append_sheet(wb, wsExpenseAnalysis, 'Анализ расходов');
            
            // Лист с операциями
            const transactionsData = [
                ['Детализация операций'],
                [''],
                ['Дата', 'Тип', 'Категория', 'Способ оплаты', 'Сумма', 'Описание', 'Категория расходов']
            ];
            
            const reportTransactionsSorted = [...reportTransactions].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            reportTransactionsSorted.forEach(transaction => {
                // Определяем категорию расходов для отображения
                let expenseCategoryDisplay = '';
                if (transaction.type === 'expense') {
                    const manualCategory = transaction.manualExpenseCategory;
                    if (manualCategory) {
                        expenseCategoryDisplay = getExpenseCategoryName(manualCategory) + ' (ручная)';
                    } else {
                        const autoCategory = classifyExpense(transaction.description);
                        expenseCategoryDisplay = getExpenseCategoryName(autoCategory) + ' (авто)';
                    }
                }
                
                transactionsData.push([
                    formatDate(transaction.date),
                    getTypeLabel(transaction.type),
                    getCategoryLabel(transaction.category),
                    getPaymentLabel(transaction.payment),
                    transaction.amount,
                    transaction.description || '',
                    expenseCategoryDisplay
                ]);
            });
            
            const wsTransactions = XLSX.utils.aoa_to_sheet(transactionsData);
            XLSX.utils.book_append_sheet(wb, wsTransactions, 'Операции');
            
            // Сохраняем файл
            XLSX.writeFile(wb, `финансовый_отчет_${new Date().toISOString().split('T')[0]}.xlsx`);
        }
        
        // Экспорт данных в Excel
        function exportToExcel() {
            // Создаем книгу Excel
            const wb = XLSX.utils.book_new();
            
            // Создаем лист с операциями
            const transactionsData = [
                ['Дата', 'Тип', 'Категория', 'Способ оплаты', 'Сумма', 'Описание', 'Категория расходов']
            ];
            
            // Сортируем транзакции по дате (новые сверху)
            const sortedTransactions = [...transactions].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            sortedTransactions.forEach(transaction => {
                // Определяем категорию расходов для отображения
                let expenseCategoryDisplay = '';
                if (transaction.type === 'expense') {
                    const manualCategory = transaction.manualExpenseCategory;
                    if (manualCategory) {
                        expenseCategoryDisplay = getExpenseCategoryName(manualCategory) + ' (ручная)';
                    } else {
                        const autoCategory = classifyExpense(transaction.description);
                        expenseCategoryDisplay = getExpenseCategoryName(autoCategory) + ' (авто)';
                    }
                }
                
                transactionsData.push([
                    formatDate(transaction.date),
                    getTypeLabel(transaction.type),
                    getCategoryLabel(transaction.category),
                    getPaymentLabel(transaction.payment),
                    transaction.amount,
                    transaction.description || '',
                    expenseCategoryDisplay
                ]);
            });
            
            const wsTransactions = XLSX.utils.aoa_to_sheet(transactionsData);
            XLSX.utils.book_append_sheet(wb, wsTransactions, 'Операции');
            
            // Сохраняем файл
            XLSX.writeFile(wb, `данные_автомойки_${new Date().toISOString().split('T')[0]}.xlsx`);
        }
        
        // Экспорт данных
        function exportData(isBackup = false) {
            const data = {
                transactions,
                reserveBalance,
                savedExpenses,
                exportDate: new Date().toISOString(),
                isBackup
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const url = URL.createObjectURL(dataBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = isBackup ? 
                `резервная_копия_автомойки_${new Date().toISOString().split('T')[0]}.json` :
                `данные_автомойки_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            if (isBackup) {
                alert('Резервная копия успешно создана!');
            } else {
                alert('Данные успешно экспортированы!');
            }
        }
        
        // Импорт данных
        function importData(event, isRestore = false) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    // Проверяем структуру данных
                    if (!data.transactions || !Array.isArray(data.transactions)) {
                        throw new Error('Некорректный формат файла');
                    }
                    
                    // Запрашиваем подтверждение
                    const message = isRestore ? 
                        'Вы уверены, что хотите восстановить данные из резервной копии? Текущие данные будут перезаписаны.' :
                        'Вы уверены, что хотите импортировать данные? Текущие данные будут перезаписаны.';
                    
                    if (confirm(message)) {
                        transactions = data.transactions;
                        reserveBalance = data.reserveBalance || 0;
                        savedExpenses = data.savedExpenses || [];
                        
                        // Сохраняем в localStorage
                        localStorage.setItem('carwash_transactions', JSON.stringify(transactions));
                        localStorage.setItem('carwash_reserve', reserveBalance.toString());
                        localStorage.setItem('carwash_saved_expenses', JSON.stringify(savedExpenses));
                        
                        // Сохраняем в Firebase, если пользователь авторизован
                        if (currentUser) {
                            saveToFirebase();
                        }
                        
                        // Обновляем интерфейс
                        renderTransactions();
                        updateDashboard();
                        updateReserveDisplay();
                        renderSavedExpenses();
                        
                        alert(isRestore ? 'Данные успешно восстановлены!' : 'Данные успешно импортированы!');
                    }
                } catch (error) {
                    console.error('Ошибка импорта данных:', error);
                    alert('Ошибка при импорте данных: ' + error.message);
                }
            };
            reader.readAsText(file);
            
            // Сбрасываем значение input, чтобы можно было загрузить тот же файл снова
            event.target.value = '';
        }
    </script>
</body>
</html>