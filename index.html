<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Учет автомойки и детейлинга</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <style>
        /* Все стили остаются без изменений */
        :root {
            --primary: #4A6FA5;
            --secondary: #6B8E23;
            --dark: #2C3E50;
            --light: #F8F9FA;
            --danger: #D9534F;
            --warning: #F0AD4E;
            --purple: #8E44AD;
            --teal: #17A2B8;
            --orange: #E67E22;
            --pink: #E84393;
            --success: #28A745;
            --gray: #6C757D;
            --light-gray: #E9ECEF;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #F5F7FA;
            color: var(--dark);
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: linear-gradient(135deg, var(--primary), var(--dark));
            color: white;
            padding: 25px 0;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 6px 15px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            padding: 0 20px;
        }
        
        h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .auth-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        
        .nav-tabs {
            display: flex;
            background-color: white;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .tab {
            padding: 15px 25px;
            cursor: pointer;
            flex: 1;
            text-align: center;
            transition: all 0.3s ease;
            font-weight: 500;
            border-bottom: 3px solid transparent;
        }
        
        .tab.active {
            background-color: white;
            color: var(--primary);
            border-bottom: 3px solid var(--primary);
        }
        
        .tab:hover:not(.active) {
            background-color: #f8f9fa;
            color: var(--primary);
        }
        
        .tab-content {
            display: none;
            background-color: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #E0E0E0;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
            background-color: white;
        }
        
        input:focus, select:focus, textarea:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(74, 111, 165, 0.1);
        }
        
        button {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
            font-weight: 500;
        }
        
        button:hover {
            background-color: #3A5A8C;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .btn-secondary {
            background-color: var(--secondary);
        }
        
        .btn-secondary:hover {
            background-color: #5A7E1A;
        }
        
        .btn-danger {
            background-color: var(--danger);
        }
        
        .btn-danger:hover {
            background-color: #C9302C;
        }
        
        .btn-purple {
            background-color: var(--purple);
        }
        
        .btn-purple:hover {
            background-color: #7D3C98;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        th, td {
            padding: 14px 16px;
            text-align: left;
            border-bottom: 1px solid #E9ECEF;
        }
        
        th {
            background-color: #F8F9FA;
            font-weight: 600;
            color: var(--dark);
        }
        
        tr:hover {
            background-color: #F8F9FA;
        }
        
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .card {
            background-color: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            border-left: 5px solid var(--primary);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        }
        
        .card.detailing {
            border-left-color: var(--purple);
        }
        
        .card.self12 {
            border-left-color: var(--teal);
        }
        
        .card.self35 {
            border-left-color: var(--warning);
        }
        
        .card h3 {
            margin-bottom: 15px;
            color: var(--dark);
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        .card-value {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .card-positive {
            color: var(--success);
        }
        
        .card-negative {
            color: var(--danger);
        }
        
        .card-neutral {
            color: var(--dark);
        }
        
        .chart-container {
            background-color: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }
        
        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .filter-group {
            flex: 1;
            min-width: 200px;
        }
        
        .actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .search-container {
            margin-bottom: 20px;
        }
        
        .highlight {
            background-color: #FFF9C4;
        }
        
        .profit-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .settlement-card {
            background: linear-gradient(135deg, var(--primary), var(--dark));
            color: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 6px 15px rgba(0,0,0,0.1);
        }
        
        .settlement-card h3 {
            margin-bottom: 15px;
            font-size: 1.4rem;
        }
        
        .settlement-amount {
            font-size: 2.5rem;
            font-weight: bold;
            margin: 15px 0;
        }
        
        .section-title {
            font-size: 1.5rem;
            margin: 25px 0 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #E9ECEF;
            color: var(--dark);
            font-weight: 600;
        }
        
        .reserve-card {
            background: linear-gradient(135deg, var(--warning), var(--orange));
            color: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .reserve-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .transaction-filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
            padding: 20px;
            background-color: #F8F9FA;
            border-radius: 12px;
        }
        
        .detail-table {
            margin-top: 20px;
        }
        
        .detail-table h4 {
            margin-bottom: 10px;
            color: var(--dark);
            font-weight: 600;
        }
        
        .firebase-status {
            padding: 12px 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: 500;
        }
        
        .firebase-success {
            background: #D4EDDA;
            color: #155724;
            border: 1px solid #C3E6CB;
        }
        
        .firebase-error {
            background: #F8D7DA;
            color: #721C24;
            border: 1px solid #F5C6CB;
        }
        
        .firebase-warning {
            background: #FFF3CD;
            color: #856404;
            border: 1px solid #FFEAA7;
        }

        /* Стили для расширенной аналитики */
        .profit-analysis {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 6px 15px rgba(0,0,0,0.1);
        }

        .profit-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .metric-card {
            background: rgba(255,255,255,0.15);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            backdrop-filter: blur(10px);
            transition: transform 0.3s;
        }

        .metric-card:hover {
            transform: translateY(-5px);
        }

        .metric-value {
            font-size: 1.8rem;
            font-weight: bold;
            margin: 10px 0;
        }

        .analysis-tabs {
            display: flex;
            background: rgba(255,255,255,0.15);
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .analysis-tab {
            padding: 12px 20px;
            cursor: pointer;
            flex: 1;
            text-align: center;
            transition: all 0.3s ease;
        }

        .analysis-tab.active {
            background: rgba(255,255,255,0.25);
        }

        .analysis-content {
            display: none;
        }

        .analysis-content.active {
            display: block;
        }

        .profit-breakdown {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .breakdown-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            color: var(--dark);
            transition: transform 0.3s;
        }

        .breakdown-card:hover {
            transform: translateY(-5px);
        }

        .trend-indicator {
            display: inline-flex;
            align-items: center;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            margin-left: 10px;
        }

        .trend-up {
            background: #D4EDDA;
            color: #155724;
        }

        .trend-down {
            background: #F8D7DA;
            color: #721C24;
        }

        .comparison-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .cost-structure {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .cost-item {
            background: #F8F9FA;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            transition: transform 0.3s;
        }

        .cost-item:hover {
            transform: translateY(-3px);
        }

        .expense-categories {
            margin-top: 20px;
            padding: 20px;
            background: #F8F9FA;
            border-radius: 10px;
        }

        .expense-category-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .expense-category-item {
            padding: 12px 15px;
            background: white;
            border-radius: 8px;
            border-left: 4px solid var(--primary);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .expense-classification-table {
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }

        .expense-classification-table th {
            background-color: #F8F9FA;
        }

        .classification-info {
            background: #F8F9FA;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid var(--primary);
        }

        /* Стили для модального окна входа */
        .auth-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .auth-modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }

        .auth-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #E9ECEF;
        }

        .auth-tab {
            padding: 10px 20px;
            cursor: pointer;
            flex: 1;
            text-align: center;
            transition: all 0.3s ease;
        }

        .auth-tab.active {
            border-bottom: 2px solid var(--primary);
            color: var(--primary);
            font-weight: 600;
        }

        .auth-form {
            display: none;
        }

        .auth-form.active {
            display: block;
        }

        /* Стили для вкладки сохраненных расходов */
        .saved-expense-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #E9ECEF;
            transition: background-color 0.3s;
        }

        .saved-expense-item:hover {
            background-color: #F8F9FA;
        }

        .saved-expense-info {
            flex-grow: 1;
        }

        .saved-expense-actions {
            display: flex;
            gap: 10px;
        }

        .saved-expense-form {
            background: #F8F9FA;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        /* Стили для улучшенных счетов в отчетах */
        .accounts-breakdown {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .account-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            transition: transform 0.3s;
        }

        .account-card:hover {
            transform: translateY(-5px);
        }

        .account-card h4 {
            margin-bottom: 15px;
            color: var(--dark);
            font-weight: 600;
        }

        .account-details {
            margin-top: 15px;
        }

        .account-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #E9ECEF;
        }

        /* Новые стили для улучшенного дизайна дашборда */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .mini-chart-container {
            background-color: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            height: 300px;
        }
        
        .mini-chart-container h4 {
            margin-bottom: 15px;
            font-size: 1.1rem;
            color: var(--dark);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            text-align: center;
            border-top: 4px solid var(--primary);
        }
        
        .stat-card.detailing {
            border-top-color: var(--purple);
        }
        
        .stat-card.self12 {
            border-top-color: var(--teal);
        }
        
        .stat-card.self35 {
            border-top-color: var(--warning);
        }
        
        .stat-value {
            font-size: 1.8rem;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: var(--gray);
        }
        
        .chart-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .compact-chart {
            height: 250px;
        }

        /* Новые стили для рентабельности */
        .profitability-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .profitability-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            text-align: center;
            border-top: 4px solid var(--primary);
        }
        
        .profitability-card.detailing {
            border-top-color: var(--purple);
        }
        
        .profitability-card.self12 {
            border-top-color: var(--teal);
        }
        
        .profitability-card.self35 {
            border-top-color: var(--warning);
        }
        
        .profitability-value {
            font-size: 1.8rem;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .profitability-label {
            font-size: 0.9rem;
            color: var(--gray);
        }

        /* Стили для описания сотрудничества */
        .partnership-info {
            background: #F8F9FA;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 20px;
            border-left: 4px solid var(--primary);
        }

        .partnership-section {
            margin-bottom: 25px;
        }

        .partnership-section h4 {
            color: var(--dark);
            margin-bottom: 10px;
            font-size: 1.2rem;
        }

        .partnership-section ul {
            padding-left: 20px;
            margin-bottom: 15px;
        }

        .partnership-section li {
            margin-bottom: 8px;
            line-height: 1.5;
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                text-align: center;
                gap: 15px;
            }
            
            .auth-section {
                flex-direction: column;
                width: 100%;
            }
            
            .nav-tabs {
                flex-direction: column;
            }
            
            .summary-cards, .profit-details {
                grid-template-columns: 1fr;
            }
            
            .filters, .actions {
                flex-direction: column;
            }
            
            .reserve-actions {
                flex-direction: column;
            }
            
            .transaction-filters {
                grid-template-columns: 1fr;
            }

            .profit-metrics,
            .profit-breakdown,
            .comparison-grid,
            .cost-structure,
            .accounts-breakdown {
                grid-template-columns: 1fr;
            }

            .saved-expense-item {
                flex-direction: column;
                align-items: flex-start;
            }

            .saved-expense-actions {
                margin-top: 10px;
                width: 100%;
                justify-content: flex-end;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .chart-row {
                grid-template-columns: 1fr;
            }
            
            .profitability-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <div>
                    <h1>Учет автомойки самообслуживания и детейлинга</h1>
                    <p>Султан (собственник) и Чингиз (управляющий)</p>
                </div>
                <div class="auth-section">
                    <div id="user-info" class="user-info" style="display: none;">
                        <div class="user-avatar" id="user-avatar">U</div>
                        <span id="user-email"></span>
                        <button id="logout-btn" class="btn-danger">Выйти</button>
                    </div>
                    <button id="login-btn" style="display: none;">Войти</button>
                </div>
            </div>
        </header>
        
        <div id="firebase-status-message"></div>
        
        <div class="nav-tabs">
            <div class="tab active" data-tab="dashboard">Дашборд</div>
            <div class="tab" data-tab="transactions">Операции</div>
            <div class="tab" data-tab="reports">Отчеты</div>
            <div class="tab" data-tab="saved-expenses">Сохраненные расходы</div>
            <div class="tab" data-tab="settings">Настройки</div>
        </div>
        
        <!-- Дашборд -->
        <div id="dashboard" class="tab-content active">
            <h2 style="color: var(--dark);">Дашборд</h2>
            
            <div class="filters">
                <div class="filter-group">
                    <label for="period">Период</label>
                    <select id="period">
                        <option value="current_month">Текущий месяц</option>
                        <option value="last_month">Прошлый месяц</option>
                        <option value="last_3_months">Последние 3 месяца</option>
                        <option value="current_year">Текущий год</option>
                        <option value="last_year">Прошлый год</option>
                        <option value="custom">Произвольный период</option>
                    </select>
                </div>
                
                <div class="filter-group" id="custom-period" style="display: none;">
                    <label for="start-date">С</label>
                    <input type="date" id="start-date">
                    <label for="end-date">По</label>
                    <input type="date" id="end-date">
                </div>
            </div>
            
            <!-- Статистика по направлениям -->
            <div class="stats-grid">
                <div class="stat-card detailing">
                    <h3>Детейлинг</h3>
                    <div class="stat-value" id="detailing-profit-stat">0 руб.</div>
                    <div class="stat-label">Чистая прибыль</div>
                    <div class="stat-label" id="detailing-margin-stat">Маржа: 0%</div>
                </div>
                
                <div class="stat-card self12">
                    <h3>Посты 1-2</h3>
                    <div class="stat-value" id="self12-profit-stat">0 руб.</div>
                    <div class="stat-label">Чистая прибыль</div>
                    <div class="stat-label" id="self12-margin-stat">Маржа: 0%</div>
                </div>
                
                <div class="stat-card self35">
                    <h3>Посты 3-5</h3>
                    <div class="stat-value" id="self35-profit-stat">0 руб.</div>
                    <div class="stat-label">Чистая прибыль</div>
                    <div class="stat-label" id="self35-margin-stat">Маржа: 0%</div>
                </div>
            </div>
            
            <!-- Показатели рентабельности -->
            <div class="profitability-grid">
                <div class="profitability-card detailing">
                    <h3>Рентабельность детейлинга</h3>
                    <div class="profitability-value" id="detailing-profitability">0%</div>
                    <div class="profitability-label">Валовая рентабельность</div>
                </div>
                
                <div class="profitability-card self12">
                    <h3>Рентабельность постов 1-2</h3>
                    <div class="profitability-value" id="self12-profitability">0%</div>
                    <div class="profitability-label">Валовая рентабельность</div>
                </div>
                
                <div class="profitability-card self35">
                    <h3>Рентабельность постов 3-5</h3>
                    <div class="profitability-value" id="self35-profitability">0%</div>
                    <div class="profitability-label">Валовая рентабельность</div>
                </div>
            </div>
            
            <!-- Основная сетка дашборда -->
            <div class="dashboard-grid">
                <div>
                    <!-- Графики доходов и расходов -->
                    <div class="chart-row">
                        <div class="mini-chart-container">
                            <h4>Доходы по категориям</h4>
                            <canvas id="incomeChart" height="200"></canvas>
                        </div>
                        <div class="mini-chart-container">
                            <h4>Расходы по категориям</h4>
                            <canvas id="expenseChart" height="200"></canvas>
                        </div>
                    </div>
                    
                    <!-- Графики прибыльности -->
                    <div class="chart-row">
                        <div class="mini-chart-container">
                            <h4>Прибыль по направлениям</h4>
                            <canvas id="profitChart" height="200"></canvas>
                        </div>
                        <div class="mini-chart-container">
                            <h4>Способы оплаты</h4>
                            <canvas id="paymentChart" height="200"></canvas>
                        </div>
                    </div>
                    
                    <!-- Новые графики динамики по категориям -->
                    <div class="chart-row">
                        <div class="mini-chart-container">
                            <h4>Динамика доходов по месяцам</h4>
                            <canvas id="incomeTrendChart" height="200"></canvas>
                        </div>
                        <div class="mini-chart-container">
                            <h4>Динамика расходов по месяцам</h4>
                            <canvas id="expenseTrendChart" height="200"></canvas>
                        </div>
                    </div>
                    
                    <!-- Графики динамики по направлениям -->
                    <div class="chart-row">
                        <div class="mini-chart-container">
                            <h4>Динамика доходов по направлениям</h4>
                            <canvas id="incomeByCategoryChart" height="200"></canvas>
                        </div>
                        <div class="mini-chart-container">
                            <h4>Динамика расходов по направлениям</h4>
                            <canvas id="expenseByCategoryChart" height="200"></canvas>
                        </div>
                    </div>
                </div>
                
                <div>
                    <!-- Боковая панель с расчетами -->
                    <div class="settlement-card">
                        <h3>Взаимные расчеты</h3>
                        <p>Сумма для уравнивания прибыли</p>
                        <div class="settlement-amount" id="settlement-amount">0 руб.</div>
                        <p id="settlement-text">Расчеты сбалансированы</p>
                    </div>
                    
                    <div class="reserve-card">
                        <h3>Резервный фонд</h3>
                        <p>Средства для общих расходов</p>
                        <div class="settlement-amount" id="reserve-amount">0 руб.</div>
                        <div class="reserve-actions">
                            <button id="add-reserve-btn">Пополнить</button>
                            <button id="withdraw-reserve-btn">Списать</button>
                        </div>
                    </div>
                    
                    <!-- Прибыль собственника и управляющего -->
                    <div class="card">
                        <h3>Прибыль собственника и управляющего</h3>
                        <div class="comparison-grid">
                            <div class="comparison-item">
                                <span>Султан (собственник):</span>
                                <span id="sultan-profit-stat">0 руб.</span>
                            </div>
                            <div class="comparison-item">
                                <span>Чингиз (управляющий):</span>
                                <span id="chingiz-profit-stat">0 руб.</span>
                            </div>
                            <div class="comparison-item" style="border-top: 1px solid #E9ECEF; padding-top: 10px;">
                                <span><strong>Итого:</strong></span>
                                <span><strong id="total-profit-stat">0 руб.</strong></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Анализ прибыльности -->
            <div class="profit-analysis">
                <h3 style="color: white; margin-bottom: 20px;">Анализ прибыльности</h3>
                
                <div class="profit-metrics">
                    <div class="metric-card">
                        <div>Общая рентабельность</div>
                        <div class="metric-value" id="overall-margin">0%</div>
                    </div>
                    <div class="metric-card">
                        <div>Валовая маржа</div>
                        <div class="metric-value" id="gross-margin">0%</div>
                    </div>
                    <div class="metric-card">
                        <div>Чистая маржа</div>
                        <div class="metric-value" id="net-margin">0%</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Операции -->
        <div id="transactions" class="tab-content">
            <h2>Управление операциями</h2>
            
            <div class="search-container">
                <input type="text" id="search-input" placeholder="Поиск по описанию...">
            </div>
            
            <div class="transaction-filters">
                <div class="filter-group">
                    <label for="filter-type">Тип операции</label>
                    <select id="filter-type">
                        <option value="">Все типы</option>
                        <option value="income">Доход</option>
                        <option value="expense">Расход</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="filter-category">Категория</label>
                    <select id="filter-category">
                        <option value="">Все категории</option>
                        <option value="detailing">Детейлинг</option>
                        <option value="self12">Самообслуживание (1-2)</option>
                        <option value="self35">Самообслуживание (3-5)</option>
                        <option value="reserve">Резервный фонд</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="filter-payment">Способ оплаты</label>
                    <select id="filter-payment">
                        <option value="">Все способы</option>
                        <option value="sultan_akbars">Счет АББ Султана</option>
                        <option value="sultan_sber">Счет Сбер Султана</option>
                        <option value="chingiz_cash">Наличные (Чингиз)</option>
                        <option value="chingiz_card">Счет Чингиза</option>
                        <option value="sultan_sber_cash">Счет Сбер (Султан) - самообслуживание</option>
                        <option value="chingiz_cash_self">Наличные (Чингиз) - самообслуживание</option>
                        <option value="reserve">Резервный фонд Чингиза</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="filter-period">Период</label>
                    <select id="filter-period">
                        <option value="all">За все время</option>
                        <option value="current_month">Текущий месяц</option>
                        <option value="last_month">Прошлый месяц</option>
                        <option value="last_3_months">Последние 3 месяца</option>
                    </select>
                </div>
            </div>
            
            <div class="actions">
                <button id="add-transaction-btn">Добавить операцию</button>
                <button id="export-btn" class="btn-secondary">Экспорт в Excel</button>
                <button id="sync-firebase-btn" class="btn-purple">Синхронизировать с облаком</button>
            </div>
            
            <table id="transactions-table">
                <thead>
                    <tr>
                        <th>Дата</th>
                        <th>Тип</th>
                        <th>Категория</th>
                        <th>Способ оплаты</th>
                        <th>Сумма</th>
                        <th>Описание</th>
                        <th>Категория расходов</th>
                        <th>Действия</th>
                    </tr>
                </thead>
                <tbody id="transactions-body">
                    <!-- Данные будут загружены через JavaScript -->
                </tbody>
            </table>
        </div>
        
        <!-- Отчеты -->
        <div id="reports" class="tab-content">
            <h2>Отчеты</h2>
            
            <div class="filters">
                <div class="filter-group">
                    <label for="report-period">Период отчета</label>
                    <select id="report-period">
                        <option value="first_half">1-15 число месяца</option>
                        <option value="second_half">16-последний день месяца</option>
                        <option value="current_month">Текущий месяц</option>
                        <option value="year">Годовой отчет</option>
                        <option value="custom">Произвольный период</option>
                    </select>
                </div>
                
                <div class="filter-group" id="report-year-group">
                    <label for="report-year">Год</label>
                    <select id="report-year">
                        <!-- Годы будут заполнены через JavaScript -->
                    </select>
                </div>
                
                <div class="filter-group" id="report-month-group" style="display: none;">
                    <label for="report-month">Месяц</label>
                    <select id="report-month">
                        <option value="01">Январь</option>
                        <option value="02">Февраль</option>
                        <option value="03">Март</option>
                        <option value="04">Апрель</option>
                        <option value="05">Май</option>
                        <option value="06">Июнь</option>
                        <option value="07">Июль</option>
                        <option value="08">Август</option>
                        <option value="09">Сентябрь</option>
                        <option value="10">Октябрь</option>
                        <option value="11">Ноябрь</option>
                        <option value="12">Декабрь</option>
                    </select>
                </div>
            </div>
            
            <div class="actions">
                <button id="generate-report-btn" class="btn-secondary">Сформировать отчет</button>
                <button id="export-excel-btn" class="btn-purple">Выгрузить в Excel</button>
                <button id="save-report-btn">Сохранить отчет</button>
            </div>
            
            <div id="report-content">
                <!-- Содержимое отчета будет генерироваться здесь -->
            </div>
        </div>
        
        <!-- Сохраненные расходы -->
        <div id="saved-expenses" class="tab-content">
            <h2>Сохраненные расходы</h2>
            <p>Создавайте и управляйте шаблонами часто используемых расходов для быстрого добавления операций.</p>
            
            <div class="saved-expense-form">
                <h3>Добавить новый сохраненный расход</h3>
                <div class="form-group">
                    <label for="saved-expense-category">Категория</label>
                    <select id="saved-expense-category" required>
                        <option value="">Выберите категорию</option>
                        <option value="detailing">Детейлинг</option>
                        <option value="self12">Самообслуживание (посты 1-2)</option>
                        <option value="self35">Самообслуживание (посты 3-5)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="saved-expense-payment">Способ оплаты</label>
                    <select id="saved-expense-payment" required>
                        <option value="">Выберите способ оплаты</option>
                        <option value="sultan_akbars">Счет АББ Султана</option>
                        <option value="sultan_sber">Счет Сбер Султана</option>
                        <option value="chingiz_cash">Наличные (Чингиз)</option>
                        <option value="chingiz_card">Счет Чингиза</option>
                        <option value="sultan_sber_cash">Счет Сбер (Султан) - самообслуживание</option>
                        <option value="chingiz_cash_self">Наличные (Чингиз) - самообслуживание</option>
                        <option value="reserve">Резервный фонд Чингиза</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="saved-expense-amount">Сумма (руб.)</label>
                    <input type="number" id="saved-expense-amount" min="0" step="0.01">
                </div>
                
                <div class="form-group">
                    <label for="saved-expense-description">Описание</label>
                    <textarea id="saved-expense-description" rows="3" required></textarea>
                </div>

                <div class="form-group">
                    <label for="saved-expense-category-type">Категория расходов (для аналитики)</label>
                    <select id="saved-expense-category-type">
                        <option value="">Автоматическое определение</option>
                        <option value="cogs">Себестоимость (COGS)</option>
                        <option value="direct">Прямые затраты</option>
                        <option value="indirect">Косвенные затраты</option>
                        <option value="fixed">Постоянные затраты</option>
                        <option value="variable">Переменные затраты</option>
                    </select>
                </div>
                
                <div class="actions">
                    <button id="add-saved-expense-btn" class="btn-secondary">Сохранить шаблон</button>
                </div>
            </div>
            
            <h3>Сохраненные шаблоны расходов</h3>
            <div id="saved-expenses-list">
                <!-- Список сохраненных расходов будет загружен здесь -->
            </div>
        </div>
        
        <!-- Настройки -->
        <div id="settings" class="tab-content">
            <h2>Настройки</h2>
            
            <div class="partnership-info">
                <h3>Условия сотрудничества и распределения прибыли</h3>
                
                <div class="partnership-section">
                    <h4>Общие принципы сотрудничества</h4>
                    <ul>
                        <li>Собственник: Султан, Управляющий: Чингиз</li>
                        <li>Совместное ведение бизнеса: автомойка самообслуживания и детейлинг</li>
                        <li>Распределение ответственности по направлениям бизнеса</li>
                    </ul>
                </div>
                
                <div class="partnership-section">
                    <h4>Распределение прибыли</h4>
                    <ul>
                        <li><strong>Детейлинг:</strong> Прибыль распределяется поровну (50/50) между собственником и управляющим</li>
                        <li><strong>Самообслуживание (посты 1-2):</strong> Прибыль распределяется поровну (50/50) между собственником и управляющим</li>
                        <li><strong>Самообслуживание (посты 3-5):</strong> Прибыль полностью принадлежит собственнику</li>
                        <li>Общие расходы покрываются из резервного фонда или распределяются пропорционально долям участия</li>
                    </ul>
                </div>
                
                <div class="partnership-section">
                    <h4>Взаимные расчеты</h4>
                    <ul>
                        <li>Система автоматически рассчитывает сумму для уравнивания прибыли собственника и управляющего</li>
                        <li>Если расчет показывает положительную сумму - Султан (собственник) должен перевести Чингизу (управляющему)</li>
                        <li>Если расчет показывает отрицательную сумму - Чингиз (управляющий) должен перевести Султану (собственнику)</li>
                        <li>Расчеты производятся на основе фактических поступлений и расходов по счетам каждого</li>
                    </ul>
                </div>
                
                <div class="partnership-section">
                    <h4>Резервный фонд</h4>
                    <ul>
                        <li>Создан для покрытия общих непредвиденных расходов</li>
                        <li>Пополняется по решению собственника и управляющего</li>
                        <li>Использование средств согласовывается обоими</li>
                        <li>Учет операций с резервным фондом ведется отдельно</li>
                    </ul>
                </div>
                
                <div class="partnership-section">
                    <h4>Учет и отчетность</h4>
                    <ul>
                        <li>Все операции фиксируются в системе с указанием даты, типа, категории и способа оплаты</li>
                        <li>Система автоматически классифицирует расходы для аналитики</li>
                        <li>Доступны различные периоды отчетности: текущий месяц, произвольный период, годовые отчеты</li>
                        <li>Экспорт данных в Excel для детального анализа</li>
                        <li>Облачная синхронизация для доступа с разных устройств</li>
                    </ul>
                </div>
            </div>
            
            <div class="form-group">
                <h3>Управление классификацией расходов</h3>
                <p>Система автоматически определяет категории расходов на основе ключевых слов в описании. Вы можете вручную изменить категорию для любой операции во вкладке "Операции".</p>
                
                <div class="expense-category-list">
                    <div class="expense-category-item">
                        <strong>Себестоимость (COGS):</strong> химия, материалы, смарикомплекс, оборудование, запчасти, инструмент, расходники, перчатки, полотенца, шампунь, воск, полироль, щетки, пены, автохимия, моющее, чистящее, абразив, паста, герметик
                    </div>
                    <div class="expense-category-item">
                        <strong>Прямые затраты:</strong> зарплата, зп, оператор, мойщик, администратор, менеджер, сотрудник, премия, отпускные, больничный, надбавка, инструктаж
                    </div>
                    <div class="expense-category-item">
                        <strong>Косвенные затраты:</strong> реклама, маркетинг, интернет, связь, банковское обслуживание, канцелярия, офис, юрист, бухгалтер, консультация, лицензия, программное обеспечение, сайт, соцсети
                    </div>
                    <div class="expense-category-item">
                        <strong>Постоянные затраты:</strong> аренда, коммунал, электричество, вода, отопление, арендная плата, лизинг, амортизация, страхование, налоги, аренда оборудования, техобслуживание, ремонт помещения
                    </div>
                    <div class="expense-category-item">
                        <strong>Переменные затраты:</strong> транспорт, командировка, обучение, сертификация, мероприятие, представительские, хозяйственные, прочие расходы, непредвиденные
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <h3>Экспорт/Импорт данных</h3>
                <p>Сохраняйте резервные копии данных регулярно</p>
                <div class="actions">
                    <button id="backup-btn" class="btn-secondary">Создать резервную копию</button>
                    <button id="restore-btn">Восстановить из резервной копии</button>
                    <input type="file" id="restore-file" style="display: none;" accept=".json">
                </div>
            </div>
            
            <div class="form-group">
                <h3>О программе</h3>
                <p>Версия 6.5 (Годовой отчет + Детализация по постам + Показатели рентабельности + Графики + Динамика по категориям)</p>
                <p>2025 Разработано для SK-Detailing by Chingiz</p>
            </div>
        </div>
        
        <!-- Модальные окна -->
        <div id="auth-modal" class="auth-modal">
            <div class="auth-modal-content">
                <h3>Вход в систему</h3>
                
                <div class="auth-tabs">
                    <div class="auth-tab active" data-form="login">Вход</div>
                    <div class="auth-tab" data-form="register">Регистрация</div>
                </div>
                
                <div id="login-form" class="auth-form active">
                    <div class="form-group">
                        <label for="login-email">Email</label>
                        <input type="email" id="login-email" placeholder="Ваш email">
                    </div>
                    
                    <div class="form-group">
                        <label for="login-password">Пароль</label>
                        <input type="password" id="login-password" placeholder="Ваш пароль">
                    </div>
                    
                    <button id="login-submit-btn" class="btn-secondary" style="width: 100%;">Войти</button>
                </div>
                
                <div id="register-form" class="auth-form">
                    <div class="form-group">
                        <label for="register-email">Email</label>
                        <input type="email" id="register-email" placeholder="Ваш email">
                    </div>
                    
                    <div class="form-group">
                        <label for="register-password">Пароль</label>
                        <input type="password" id="register-password" placeholder="Пароль (минимум 6 символов)">
                    </div>
                    
                    <div class="form-group">
                        <label for="register-confirm-password">Подтвердите пароль</label>
                        <input type="password" id="register-confirm-password" placeholder="Повторите пароль">
                    </div>
                    
                    <button id="register-submit-btn" class="btn-secondary" style="width: 100%;">Зарегистрироваться</button>
                </div>
                
                <div style="text-align: center; margin-top: 15px;">
                    <button id="close-auth-btn" style="background: none; border: none; color: var(--primary); cursor: pointer;">Закрыть</button>
                </div>
            </div>
        </div>
        
        <!-- Модальное окно для добавления/редактирования операции -->
        <div id="transaction-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000;">
            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: white; padding: 30px; border-radius: 12px; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto;">
                <h3 id="modal-title">Добавить операцию</h3>
                
                <div class="form-group">
                    <label for="transaction-date">Дата</label>
                    <input type="date" id="transaction-date" required>
                </div>
                
                <div class="form-group">
                    <label for="transaction-type">Тип операции</label>
                    <select id="transaction-type" required>
                        <option value="">Выберите тип</option>
                        <option value="income">Доход</option>
                        <option value="expense">Расход</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="transaction-category">Категория</label>
                    <select id="transaction-category" required>
                        <option value="">Выберите категорию</option>
                        <option value="detailing">Детейлинг</option>
                        <option value="self12">Самообслуживание (посты 1-2)</option>
                        <option value="self35">Самообслуживание (посты 3-5)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="transaction-payment">Способ оплаты</label>
                    <select id="transaction-payment" required>
                        <option value="">Выберите способ оплаты</option>
                        <option value="sultan_akbars">Счет АББ Султана</option>
                        <option value="sultan_sber">Счет Сбер Султана</option>
                        <option value="chingiz_cash">Наличные (Чингиз)</option>
                        <option value="chingiz_card">Счет Чингиза</option>
                        <option value="sultan_sber_cash">Счет Сбер (Султан) - самообслуживание</option>
                        <option value="chingiz_cash_self">Наличные (Чингиз) - самообслуживание</option>
                        <option value="reserve">Резервный фонд Чингиза</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="transaction-amount">Сумма (руб.)</label>
                    <input type="number" id="transaction-amount" min="0" step="0.01" required>
                </div>
                
                <div class="form-group">
                    <label for="transaction-description">Описание</label>
                    <textarea id="transaction-description" rows="3"></textarea>
                </div>

                <div class="form-group" id="expense-category-group" style="display: none;">
                    <label for="transaction-expense-category">Категория расходов (для аналитики)</label>
                    <select id="transaction-expense-category">
                        <option value="">Автоматическое определение</option>
                        <option value="cogs">Себестоимость (COGS)</option>
                        <option value="direct">Прямые затраты</option>
                        <option value="indirect">Косвенные затраты</option>
                        <option value="fixed">Постоянные затраты</option>
                        <option value="variable">Переменные затраты</option>
                    </select>
                    <small id="expense-category-auto"></small>
                </div>

                <div class="form-group" id="saved-expense-group" style="display: none;">
                    <label for="saved-expense-select">Использовать сохраненный расход</label>
                    <select id="saved-expense-select">
                        <option value="">Выберите шаблон</option>
                    </select>
                </div>
                
                <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                    <button id="cancel-transaction-btn">Отмена</button>
                    <button id="save-transaction-btn" class="btn-secondary">Сохранить</button>
                </div>
            </div>
        </div>
        
        <!-- Модальное окно для управления резервом -->
        <div id="reserve-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000;">
            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: white; padding: 30px; border-radius: 12px; width: 90%; max-width: 500px;">
                <h3 id="reserve-modal-title">Управление резервным фондом</h3>
                
                <div class="form-group">
                    <label for="reserve-date">Дата</label>
                    <input type="date" id="reserve-date" required>
                </div>
                
                <div class="form-group">
                    <label for="reserve-amount-input">Сумма (руб.)</label>
                    <input type="number" id="reserve-amount-input" min="0" step="0.01" required>
                </div>
                
                <div class="form-group">
                    <label for="reserve-description">Описание</label>
                    <textarea id="reserve-description" rows="3"></textarea>
                </div>
                
                <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                    <button id="cancel-reserve-btn">Отмена</button>
                    <button id="save-reserve-btn" class="btn-secondary">Сохранить</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Конфигурация Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyC_klfpOSe-AzacQqzxzdZmy_cU0qNP6ow",
            authDomain: "reportsk-7ea5a.firebaseapp.com",
            projectId: "reportsk-7ea5a",
            storageBucket: "reportsk-7ea5a.firebasestorage.app",
            messagingSenderId: "866594757497",
            appId: "1:866594757497:web:eef363f6c6731d0481ada8"
        };

        // Инициализация Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Основные переменные
        let transactions = JSON.parse(localStorage.getItem('carwash_transactions')) || [];
        let reserveBalance = parseFloat(localStorage.getItem('carwash_reserve')) || 0;
        let savedExpenses = JSON.parse(localStorage.getItem('carwash_saved_expenses')) || [];
        let editingId = null;
        let reserveAction = null;
        let incomeChart = null;
        let expenseChart = null;
        let profitChart = null;
        let paymentChart = null;
        let incomeTrendChart = null;
        let expenseTrendChart = null;
        let incomeByCategoryChart = null;
        let expenseByCategoryChart = null;
        let currentUser = null;
        let reportGenerated = false;

        // Улучшенная система классификации расходов
        const expenseCategories = {
            cogs: {
                name: "Себестоимость",
                keywords: ["химия", "материал", "смарикомплекс", "оборудование", "запчасти", "инструмент", 
                          "расходники", "перчатки", "полотенца", "шампунь", "воск", "полироль", "щетки",
                          "пены", "автохимия", "моющее", "чистящее", "абразив", " паста", "герметик"]
            },
            direct: {
                name: "Прямые затраты",
                keywords: ["зарплата", "зп", "оператор", "мойщик", "администратор", "менеджер", 
                          "сотрудник", "премия", "отпускные", "больничный", "надбавка", "инструктаж"]
            },
            indirect: {
                name: "Косвенные затраты",
                keywords: ["реклама", "маркетинг", "интернет", "связь", "банковское обслуживание", 
                          "канцелярия", "офис", "юрист", "бухгалтер", "консультация", "лицензия", 
                          "программное обеспечение", "сайт", "соцсети"]
            },
            fixed: {
                name: "Постоянные затраты",
                keywords: ["аренда", "коммунал", "электричество", "вода", "отопление", "арендная плата", 
                          "лизинг", "амортизация", "страхование", "налоги", "аренда оборудования", 
                          "техобслуживание", "ремонт помещения"]
            },
            variable: {
                name: "Переменные затраты",
                keywords: ["транспорт", "командировка", "обучение", "сертификация", "мероприятие", 
                          "представительские", "хозяйственные", "прочие расходы", "непредвиденные"]
            }
        };

        // Функция для классификации расходов на основе описания
        function classifyExpense(description) {
            if (!description) return 'variable';
            
            const desc = description.toLowerCase();
            
            for (const [category, data] of Object.entries(expenseCategories)) {
                if (data.keywords.some(keyword => desc.includes(keyword))) {
                    return category;
                }
            }
            
            return 'variable';
        }

        // Получить название категории по ключу
        function getExpenseCategoryName(categoryKey) {
            return expenseCategories[categoryKey] ? expenseCategories[categoryKey].name : 'Не определена';
        }

        // Инициализация при загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            initializeFirebaseAuth();
            renderTransactions();
            updateDashboard();
            updateReserveDisplay();
            renderSavedExpenses();
            populateYearSelect();
            
            // Устанавливаем текущий месяц и год для отчетов
            const now = new Date();
            document.getElementById('report-year').value = now.getFullYear();
            document.getElementById('report-month').value = (now.getMonth() + 1).toString().padStart(2, '0');
        });

        // Заполнение выпадающего списка годов
        function populateYearSelect() {
            const yearSelect = document.getElementById('report-year');
            const currentYear = new Date().getFullYear();
            
            // Очищаем список
            yearSelect.innerHTML = '';
            
            // Добавляем годы от 2020 до текущего года + 1
            for (let year = 2020; year <= currentYear + 1; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                if (year === currentYear) {
                    option.selected = true;
                }
                yearSelect.appendChild(option);
            }
        }

        // Инициализация Firebase Auth
        function initializeFirebaseAuth() {
            auth.onAuthStateChanged((user) => {
                if (user) {
                    currentUser = user;
                    showUserInfo(user);
                    loadFromFirebase();
                } else {
                    currentUser = null;
                    hideUserInfo();
                    showAuthModal();
                }
            });
        }

        // Показать информацию о пользователе
        function showUserInfo(user) {
            document.getElementById('user-info').style.display = 'flex';
            document.getElementById('login-btn').style.display = 'none';
            document.getElementById('user-email').textContent = user.email;
            document.getElementById('user-avatar').textContent = user.email.charAt(0).toUpperCase();
        }

        // Скрыть информацию о пользователе
        function hideUserInfo() {
            document.getElementById('user-info').style.display = 'none';
            document.getElementById('login-btn').style.display = 'block';
        }

        // Показать модальное окно аутентификации
        function showAuthModal() {
            document.getElementById('auth-modal').style.display = 'flex';
        }

        // Скрыть модальное окно аутентификации
        function hideAuthModal() {
            document.getElementById('auth-modal').style.display = 'none';
        }

        // Загрузка данных из Firebase
        async function loadFromFirebase() {
            if (!currentUser) return;
            
            try {
                showFirebaseStatus('Загрузка данных из облака...', 'warning');
                
                const doc = await db.collection('users').doc(currentUser.uid).get();
                
                if (doc.exists) {
                    const data = doc.data();
                    
                    transactions = data.transactions || [];
                    reserveBalance = data.reserveBalance || 0;
                    savedExpenses = data.savedExpenses || [];
                    
                    localStorage.setItem('carwash_transactions', JSON.stringify(transactions));
                    localStorage.setItem('carwash_reserve', reserveBalance.toString());
                    localStorage.setItem('carwash_saved_expenses', JSON.stringify(savedExpenses));
                    
                    renderTransactions();
                    updateDashboard();
                    updateReserveDisplay();
                    renderSavedExpenses();
                    
                    showFirebaseStatus(`Данные успешно загружены (${transactions.length} операций)`, 'success');
                } else {
                    await saveToFirebase();
                    showFirebaseStatus('Создан новый профиль в облаке', 'success');
                }
            } catch (error) {
                console.error('Ошибка загрузки из Firebase:', error);
                showFirebaseStatus(`Ошибка загрузки: ${error.message}`, 'error');
            }
        }

        // Сохранение данных в Firebase
        async function saveToFirebase() {
            if (!currentUser) return;
            
            try {
                showFirebaseStatus('Сохранение данных в облако...', 'warning');
                
                function removeUndefinedFields(obj) {
                    if (Array.isArray(obj)) {
                        return obj.map(item => 
                            item && typeof item === 'object' ? removeUndefinedFields(item) : item
                        ).filter(item => item !== undefined);
                    } else if (obj && typeof obj === 'object') {
                        return Object.fromEntries(
                            Object.entries(obj)
                                .map(([key, value]) => [
                                    key, 
                                    value && typeof value === 'object' ? removeUndefinedFields(value) : value
                                ])
                                .filter(([_, value]) => value !== undefined)
                        );
                    }
                    return obj;
                }
                
                const cleanedTransactions = removeUndefinedFields(transactions);
                const cleanedSavedExpenses = removeUndefinedFields(savedExpenses);
                
                const data = removeUndefinedFields({
                    transactions: cleanedTransactions,
                    savedExpenses: cleanedSavedExpenses,
                    reserveBalance: reserveBalance,
                    lastUpdate: new Date().toISOString(),
                    email: currentUser.email
                });
                
                await db.collection('users').doc(currentUser.uid).set(data);
                
                showFirebaseStatus(`Данные успешно сохранены в облако (${transactions.length} операций)`, 'success');
            } catch (error) {
                console.error('Ошибка сохранения в Firebase:', error);
                showFirebaseStatus(`Ошибка сохранения: ${error.message}`, 'error');
            }
        }

        // Показать статус Firebase
        function showFirebaseStatus(message, type) {
            const statusElement = document.getElementById('firebase-status-message');
            statusElement.innerHTML = `<div class="firebase-status firebase-${type}">${message}</div>`;
            
            if (type !== 'warning') {
                setTimeout(() => {
                    statusElement.innerHTML = '';
                }, 5000);
            }
        }

        // Инициализация приложения
        function initializeApp() {
            // Навигация по вкладкам
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    this.classList.add('active');
                    document.getElementById(this.dataset.tab).classList.add('active');
                    
                    if (this.dataset.tab === 'transactions') {
                        renderTransactions();
                    }
                    
                    if (this.dataset.tab === 'saved-expenses') {
                        renderSavedExpenses();
                    }

                    if (this.dataset.tab === 'reports' && !reportGenerated) {
                        generateReport();
                        reportGenerated = true;
                    }
                });
            });
            
            // Фильтр периода на дашборде
            document.getElementById('period').addEventListener('change', function() {
                const customPeriod = document.getElementById('custom-period');
                if (this.value === 'custom') {
                    customPeriod.style.display = 'block';
                } else {
                    customPeriod.style.display = 'none';
                }
                updateDashboard();
            });
            
            // Обработчик изменения периода отчета
            document.getElementById('report-period').addEventListener('change', function() {
                const yearGroup = document.getElementById('report-year-group');
                const monthGroup = document.getElementById('report-month-group');
                
                if (this.value === 'year') {
                    yearGroup.style.display = 'block';
                    monthGroup.style.display = 'none';
                } else {
                    yearGroup.style.display = 'block';
                    monthGroup.style.display = 'block';
                }
            });
            
            // Поиск операций
            document.getElementById('search-input').addEventListener('input', function() {
                renderTransactions();
            });
            
            // Фильтры операций
            document.getElementById('filter-type').addEventListener('change', function() {
                renderTransactions();
            });
            
            document.getElementById('filter-category').addEventListener('change', function() {
                renderTransactions();
            });
            
            document.getElementById('filter-payment').addEventListener('change', function() {
                renderTransactions();
            });
            
            document.getElementById('filter-period').addEventListener('change', function() {
                renderTransactions();
            });
            
            // Кнопка добавления операции
            document.getElementById('add-transaction-btn').addEventListener('click', function() {
                showTransactionModal();
            });
            
            // Кнопки в модальном окне операции
            document.getElementById('cancel-transaction-btn').addEventListener('click', function() {
                hideTransactionModal();
            });
            
            document.getElementById('save-transaction-btn').addEventListener('click', function() {
                saveTransaction();
            });

            // Обработчик изменения типа операции в модальном окне
            document.getElementById('transaction-type').addEventListener('change', function() {
                const expenseCategoryGroup = document.getElementById('expense-category-group');
                const savedExpenseGroup = document.getElementById('saved-expense-group');
                
                if (this.value === 'expense') {
                    expenseCategoryGroup.style.display = 'block';
                    savedExpenseGroup.style.display = 'block';
                    updateSavedExpenseSelect();
                    
                    // Показываем автоматическую категорию на основе описания
                    const description = document.getElementById('transaction-description').value;
                    if (description) {
                        const autoCategory = classifyExpense(description);
                        document.getElementById('expense-category-auto').textContent = `Автоматически: ${getExpenseCategoryName(autoCategory)}`;
                    }
                } else {
                    expenseCategoryGroup.style.display = 'none';
                    savedExpenseGroup.style.display = 'none';
                }
            });

            // Обработчик изменения описания в модальном окне
            document.getElementById('transaction-description').addEventListener('input', function() {
                const transactionType = document.getElementById('transaction-type').value;
                if (transactionType === 'expense') {
                    const autoCategory = classifyExpense(this.value);
                    document.getElementById('expense-category-auto').textContent = `Автоматически: ${getExpenseCategoryName(autoCategory)}`;
                }
            });

            // Обработчик выбора сохраненного расхода
            document.getElementById('saved-expense-select').addEventListener('change', function() {
                const selectedId = this.value;
                if (selectedId) {
                    const savedExpense = savedExpenses.find(exp => exp.id === selectedId);
                    if (savedExpense) {
                        document.getElementById('transaction-category').value = savedExpense.category;
                        document.getElementById('transaction-payment').value = savedExpense.payment;
                        document.getElementById('transaction-amount').value = savedExpense.amount || '';
                        document.getElementById('transaction-description').value = savedExpense.description;
                        document.getElementById('transaction-expense-category').value = savedExpense.expenseCategory || '';
                        
                        // Обновляем автоматическую категорию
                        const autoCategory = classifyExpense(savedExpense.description);
                        document.getElementById('expense-category-auto').textContent = `Автоматически: ${getExpenseCategoryName(autoCategory)}`;
                    }
                }
            });
            
            // Экспорт данных
            document.getElementById('export-btn').addEventListener('click', function() {
                exportToExcel();
            });
            
            // Синхронизация с Firebase
            document.getElementById('sync-firebase-btn').addEventListener('click', function() {
                saveToFirebase();
            });
            
            // Генерация отчета
            document.getElementById('generate-report-btn').addEventListener('click', function() {
                generateReport();
            });
            
            // Сохранение отчета
            document.getElementById('save-report-btn').addEventListener('click', function() {
                saveReport();
            });
            
            // Выгрузка в Excel
            document.getElementById('export-excel-btn').addEventListener('click', function() {
                exportReportToExcel();
            });
            
            // Резервное копирование
            document.getElementById('backup-btn').addEventListener('click', function() {
                exportData(true);
            });
            
            // Восстановление из резервной копии
            document.getElementById('restore-btn').addEventListener('click', function() {
                document.getElementById('restore-file').click();
            });
            
            document.getElementById('restore-file').addEventListener('change', function(e) {
                importData(e, true);
            });
            
            // Управление резервом
            document.getElementById('add-reserve-btn').addEventListener('click', function() {
                showReserveModal('add');
            });
            
            document.getElementById('withdraw-reserve-btn').addEventListener('click', function() {
                showReserveModal('withdraw');
            });
            
            document.getElementById('cancel-reserve-btn').addEventListener('click', function() {
                hideReserveModal();
            });
            
            document.getElementById('save-reserve-btn').addEventListener('click', function() {
                saveReserveTransaction();
            });

            // Обработчики для сохраненных расходов
            document.getElementById('add-saved-expense-btn').addEventListener('click', function() {
                addSavedExpense();
            });

            // Обработчики для аутентификации
            document.getElementById('login-btn').addEventListener('click', function() {
                showAuthModal();
            });
            
            document.getElementById('logout-btn').addEventListener('click', function() {
                auth.signOut();
            });
            
            document.getElementById('close-auth-btn').addEventListener('click', function() {
                hideAuthModal();
            });
            
            document.getElementById('login-submit-btn').addEventListener('click', function() {
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                
                if (!email || !password) {
                    showFirebaseStatus('Заполните все поля', 'error');
                    return;
                }
                
                auth.signInWithEmailAndPassword(email, password)
                    .then((userCredential) => {
                        hideAuthModal();
                        showFirebaseStatus('Успешный вход', 'success');
                    })
                    .catch((error) => {
                        showFirebaseStatus(`Ошибка входа: ${error.message}`, 'error');
                    });
            });
            
            document.getElementById('register-submit-btn').addEventListener('click', function() {
                const email = document.getElementById('register-email').value;
                const password = document.getElementById('register-password').value;
                const confirmPassword = document.getElementById('register-confirm-password').value;
                
                if (!email || !password || !confirmPassword) {
                    showFirebaseStatus('Заполните все поля', 'error');
                    return;
                }
                
                if (password !== confirmPassword) {
                    showFirebaseStatus('Пароли не совпадают', 'error');
                    return;
                }
                
                if (password.length < 6) {
                    showFirebaseStatus('Пароль должен содержать минимум 6 символов', 'error');
                    return;
                }
                
                auth.createUserWithEmailAndPassword(email, password)
                    .then((userCredential) => {
                        hideAuthModal();
                        showFirebaseStatus('Успешная регистрация', 'success');
                    })
                    .catch((error) => {
                        showFirebaseStatus(`Ошибка регистрации: ${error.message}`, 'error');
                    });
            });
        }

        // Обновление выпадающего списка сохраненных расходов
        function updateSavedExpenseSelect() {
            const select = document.getElementById('saved-expense-select');
            select.innerHTML = '<option value="">Выберите шаблон</option>';
            
            savedExpenses.forEach(expense => {
                const option = document.createElement('option');
                option.value = expense.id;
                option.textContent = `${expense.description} (${getCategoryLabel(expense.category)})`;
                select.appendChild(option);
            });
        }

        // Добавление сохраненного расхода
        function addSavedExpense() {
            const category = document.getElementById('saved-expense-category').value;
            const payment = document.getElementById('saved-expense-payment').value;
            const amount = document.getElementById('saved-expense-amount').value;
            const description = document.getElementById('saved-expense-description').value;
            const expenseCategory = document.getElementById('saved-expense-category-type').value;
            
            if (!category || !payment || !description) {
                alert('Пожалуйста, заполните все обязательные поля');
                return;
            }
            
            const newSavedExpense = {
                id: Date.now().toString(),
                category,
                payment,
                amount: amount ? parseFloat(amount) : null,
                description,
                expenseCategory,
                createdAt: new Date().toISOString()
            };
            
            savedExpenses.push(newSavedExpense);
            
            localStorage.setItem('carwash_saved_expenses', JSON.stringify(savedExpenses));
            
            if (currentUser) {
                saveToFirebase();
            }
            
            document.getElementById('saved-expense-category').value = '';
            document.getElementById('saved-expense-payment').value = '';
            document.getElementById('saved-expense-amount').value = '';
            document.getElementById('saved-expense-description').value = '';
            document.getElementById('saved-expense-category-type').value = '';
            
            renderSavedExpenses();
            
            alert('Шаблон расхода успешно сохранен!');
        }

        // Удаление сохраненного расхода
        function deleteSavedExpense(id) {
            if (confirm('Вы уверены, что хотите удалить этот шаблон расхода?')) {
                savedExpenses = savedExpenses.filter(exp => exp.id !== id);
                
                localStorage.setItem('carwash_saved_expenses', JSON.stringify(savedExpenses));
                
                if (currentUser) {
                    saveToFirebase();
                }
                
                renderSavedExpenses();
            }
        }

        // Отображение сохраненных расходов
        function renderSavedExpenses() {
            const container = document.getElementById('saved-expenses-list');
            
            if (savedExpenses.length === 0) {
                container.innerHTML = '<p>Нет сохраненных шаблонов расходов</p>';
                return;
            }
            
            container.innerHTML = '';
            
            savedExpenses.forEach(expense => {
                const item = document.createElement('div');
                item.className = 'saved-expense-item';
                
                item.innerHTML = `
                    <div class="saved-expense-info">
                        <strong>${expense.description}</strong>
                        <div>Категория: ${getCategoryLabel(expense.category)}</div>
                        <div>Способ оплаты: ${getPaymentLabel(expense.payment)}</div>
                        ${expense.amount ? `<div>Сумма: ${expense.amount.toFixed(2)} руб.</div>` : ''}
                        ${expense.expenseCategory ? `<div>Категория расходов: ${getExpenseCategoryName(expense.expenseCategory)}</div>` : ''}
                    </div>
                    <div class="saved-expense-actions">
                        <button onclick="useSavedExpense('${expense.id}')">Использовать</button>
                        <button onclick="deleteSavedExpense('${expense.id}')" class="btn-danger">Удалить</button>
                    </div>
                `;
                
                container.appendChild(item);
            });
        }

        // Использование сохраненного расхода
        function useSavedExpense(id) {
            const expense = savedExpenses.find(exp => exp.id === id);
            if (!expense) return;
            
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            document.querySelector('.tab[data-tab="transactions"]').classList.add('active');
            document.getElementById('transactions').classList.add('active');
            
            showTransactionModal();
            
            document.getElementById('transaction-type').value = 'expense';
            document.getElementById('transaction-category').value = expense.category;
            document.getElementById('transaction-payment').value = expense.payment;
            document.getElementById('transaction-amount').value = expense.amount || '';
            document.getElementById('transaction-description').value = expense.description;
            document.getElementById('transaction-expense-category').value = expense.expenseCategory || '';
            
            // Обновляем видимость полей
            document.getElementById('expense-category-group').style.display = 'block';
            document.getElementById('saved-expense-group').style.display = 'block';
            
            // Обновляем автоматическую категорию
            const autoCategory = classifyExpense(expense.description);
            document.getElementById('expense-category-auto').textContent = `Автоматически: ${getExpenseCategoryName(autoCategory)}`;
            
            // Обновляем список сохраненных расходов
            updateSavedExpenseSelect();
        }
        
        // Показать модальное окно операции
        function showTransactionModal(id = null) {
            editingId = id;
            const modal = document.getElementById('transaction-modal');
            const title = document.getElementById('modal-title');
            const expenseCategoryGroup = document.getElementById('expense-category-group');
            const savedExpenseGroup = document.getElementById('saved-expense-group');
            
            if (id) {
                title.textContent = 'Редактировать операцию';
                const transaction = transactions.find(t => t.id === id);
                
                document.getElementById('transaction-date').value = transaction.date;
                document.getElementById('transaction-type').value = transaction.type;
                document.getElementById('transaction-category').value = transaction.category;
                document.getElementById('transaction-payment').value = transaction.payment;
                document.getElementById('transaction-amount').value = transaction.amount;
                document.getElementById('transaction-description').value = transaction.description || '';
                
                // Устанавливаем значение категории расходов, если операция - расход
                if (transaction.type === 'expense') {
                    expenseCategoryGroup.style.display = 'block';
                    savedExpenseGroup.style.display = 'block';
                    document.getElementById('transaction-expense-category').value = transaction.manualExpenseCategory || '';
                    
                    // Показываем автоматическую категорию
                    const autoCategory = classifyExpense(transaction.description);
                    document.getElementById('expense-category-auto').textContent = `Автоматически: ${getExpenseCategoryName(autoCategory)}`;
                    
                    // Обновляем список сохраненных расходов
                    updateSavedExpenseSelect();
                } else {
                    expenseCategoryGroup.style.display = 'none';
                    savedExpenseGroup.style.display = 'none';
                }
            } else {
                title.textContent = 'Добавить операцию';
                document.getElementById('transaction-date').value = new Date().toISOString().split('T')[0];
                document.getElementById('transaction-type').value = '';
                document.getElementById('transaction-category').value = '';
                document.getElementById('transaction-payment').value = '';
                document.getElementById('transaction-amount').value = '';
                document.getElementById('transaction-description').value = '';
                document.getElementById('transaction-expense-category').value = '';
                expenseCategoryGroup.style.display = 'none';
                savedExpenseGroup.style.display = 'none';
            }
            
            modal.style.display = 'block';
        }
        
        // Скрыть модальное окно операции
        function hideTransactionModal() {
            document.getElementById('transaction-modal').style.display = 'none';
            editingId = null;
        }
        
        // Показать модальное окно резерва
        function showReserveModal(action) {
            reserveAction = action;
            const modal = document.getElementById('reserve-modal');
            const title = document.getElementById('reserve-modal-title');
            
            if (action === 'add') {
                title.textContent = 'Пополнение резервного фонда';
            } else {
                title.textContent = 'Списание с резервного фонда';
            }
            
            document.getElementById('reserve-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('reserve-amount-input').value = '';
            document.getElementById('reserve-description').value = '';
            
            modal.style.display = 'block';
        }
        
        // Скрыть модальное окно резерва
        function hideReserveModal() {
            document.getElementById('reserve-modal').style.display = 'none';
            reserveAction = null;
        }
        
        // Сохранить операцию с резервом
        function saveReserveTransaction() {
            const date = document.getElementById('reserve-date').value;
            const amount = parseFloat(document.getElementById('reserve-amount-input').value);
            const description = document.getElementById('reserve-description').value;
            
            if (!date || !amount || amount <= 0) {
                alert('Пожалуйста, заполните все обязательные поля');
                return;
            }
            
            if (reserveAction === 'add') {
                reserveBalance += amount;
                
                // Добавляем запись о пополнении резерва
                const newTransaction = {
                    id: Date.now().toString(),
                    date: date,
                    type: 'expense',
                    category: 'reserve',
                    payment: 'reserve',
                    amount: amount,
                    description: description || 'Пополнение резервного фонда',
                    createdAt: new Date().toISOString(),
                    manualExpenseCategory: null
                };
                
                transactions.push(newTransaction);
            } else {
                if (amount > reserveBalance) {
                    alert('Недостаточно средств в резервном фонде');
                    return;
                }
                
                reserveBalance -= amount;
                
                // Добавляем запись о списании с резерва
                const newTransaction = {
                    id: Date.now().toString(),
                    date: date,
                    type: 'income',
                    category: 'reserve',
                    payment: 'reserve',
                    amount: amount,
                    description: description || 'Списание с резервного фонда',
                    createdAt: new Date().toISOString(),
                    manualExpenseCategory: null
                };
                
                transactions.push(newTransaction);
            }
            
            // Сохраняем в localStorage
            localStorage.setItem('carwash_reserve', reserveBalance.toString());
            localStorage.setItem('carwash_transactions', JSON.stringify(transactions));
            
            // Сохраняем в Firebase, если пользователь авторизован
            if (currentUser) {
                saveToFirebase();
            }
            
            // Обновляем интерфейс
            hideReserveModal();
            updateReserveDisplay();
            renderTransactions();
            updateDashboard();
        }
        
        // Обновление отображения резерва
        function updateReserveDisplay() {
            document.getElementById('reserve-amount').textContent = `${reserveBalance.toFixed(2)} руб.`;
        }
        
        // Сохранить операцию
        function saveTransaction() {
            const date = document.getElementById('transaction-date').value;
            const type = document.getElementById('transaction-type').value;
            const category = document.getElementById('transaction-category').value;
            const payment = document.getElementById('transaction-payment').value;
            const amount = parseFloat(document.getElementById('transaction-amount').value);
            const description = document.getElementById('transaction-description').value;
            const expenseCategory = document.getElementById('transaction-expense-category').value;
            
            if (!date || !type || !category || !payment || !amount) {
                alert('Пожалуйста, заполните все обязательные поля');
                return;
            }
            
            // Проверка на дубликаты
            const isDuplicate = transactions.some(t => 
                t.date === date &&
                t.type === type &&
                t.category === category &&
                t.payment === payment &&
                t.amount === amount &&
                t.description === description &&
                t.id !== editingId
            );
            
            if (isDuplicate) {
                alert('Операция с такими параметрами уже существует в этот день!');
                return;
            }
            
            if (editingId) {
                // Редактирование существующей операции
                const index = transactions.findIndex(t => t.id === editingId);
                if (index !== -1) {
                    transactions[index] = {
                        ...transactions[index],
                        date,
                        type,
                        category,
                        payment,
                        amount,
                        description,
                        manualExpenseCategory: type === 'expense' ? (expenseCategory || null) : null
                    };
                }
            } else {
                // Добавление новой операции
                const newTransaction = {
                    id: Date.now().toString(),
                    date,
                    type,
                    category,
                    payment,
                    amount,
                    description,
                    manualExpenseCategory: type === 'expense' ? (expenseCategory || null) : null,
                    createdAt: new Date().toISOString()
                };
                
                transactions.push(newTransaction);
            }
            
            // Сохраняем в localStorage
            localStorage.setItem('carwash_transactions', JSON.stringify(transactions));
            
            // Сохраняем в Firebase, если пользователь авторизован
            if (currentUser) {
                saveToFirebase();
            }
            
            // Обновляем интерфейс
            hideTransactionModal();
            renderTransactions();
            updateDashboard();
        }
        
        // Удалить операцию
        function deleteTransaction(id) {
            if (confirm('Вы уверены, что хотите удалить эту операцию?')) {
                transactions = transactions.filter(t => t.id !== id);
                localStorage.setItem('carwash_transactions', JSON.stringify(transactions));
                
                // Сохраняем в Firebase, если пользователь авторизован
                if (currentUser) {
                    saveToFirebase();
                }
                
                renderTransactions();
                updateDashboard();
            }
        }
        
        // Отображение списка операций
        function renderTransactions() {
            const tbody = document.getElementById('transactions-body');
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const filterType = document.getElementById('filter-type').value;
            const filterCategory = document.getElementById('filter-category').value;
            const filterPayment = document.getElementById('filter-payment').value;
            const filterPeriod = document.getElementById('filter-period').value;
            
            // Фильтрация операций
            let filteredTransactions = transactions;
            
            // Поиск по описанию
            if (searchTerm) {
                filteredTransactions = filteredTransactions.filter(t => 
                    t.description && t.description.toLowerCase().includes(searchTerm)
                );
            }
            
            // Фильтр по типу
            if (filterType) {
                filteredTransactions = filteredTransactions.filter(t => t.type === filterType);
            }
            
            // Фильтр по категории
            if (filterCategory) {
                filteredTransactions = filteredTransactions.filter(t => t.category === filterCategory);
            }
            
            // Фильтр по способу оплаты
            if (filterPayment) {
                filteredTransactions = filteredTransactions.filter(t => t.payment === filterPayment);
            }
            
            // Фильтр по периоду
            if (filterPeriod && filterPeriod !== 'all') {
                const now = new Date();
                let startDate, endDate;
                
                switch (filterPeriod) {
                    case 'current_month':
                        startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                        endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59, 999);
                        break;
                    case 'last_month':
                        startDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                        endDate = new Date(now.getFullYear(), now.getMonth(), 0, 23, 59, 59, 999);
                        break;
                    case 'last_3_months':
                        startDate = new Date(now.getFullYear(), now.getMonth() - 3, 1);
                        endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59, 999);
                        break;
                }
                
                filteredTransactions = filteredTransactions.filter(t => {
                    const transactionDate = new Date(t.date);
                    return transactionDate >= startDate && transactionDate <= endDate;
                });
            }
            
            // Сортировка по дате (новые сверху)
            filteredTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            if (filteredTransactions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center;">Нет операций</td></tr>';
                return;
            }
            
            tbody.innerHTML = '';
            
            filteredTransactions.forEach(transaction => {
                const row = document.createElement('tr');
                
                // Подсветка при поиске
                let description = transaction.description || '';
                if (searchTerm && description.toLowerCase().includes(searchTerm)) {
                    const regex = new RegExp(`(${searchTerm})`, 'gi');
                    description = description.replace(regex, '<span class="highlight">$1</span>');
                }
                
                // Определяем категорию расходов для отображения
                let expenseCategoryDisplay = '';
                if (transaction.type === 'expense') {
                    const manualCategory = transaction.manualExpenseCategory;
                    if (manualCategory) {
                        expenseCategoryDisplay = getExpenseCategoryName(manualCategory) + ' (ручная)';
                    } else {
                        const autoCategory = classifyExpense(transaction.description);
                        expenseCategoryDisplay = getExpenseCategoryName(autoCategory) + ' (авто)';
                    }
                }
                
                row.innerHTML = `
                    <td>${formatDate(transaction.date)}</td>
                    <td>${getTypeLabel(transaction.type)}</td>
                    <td>${getCategoryLabel(transaction.category)}</td>
                    <td>${getPaymentLabel(transaction.payment)}</td>
                    <td>${transaction.amount.toFixed(2)} руб.</td>
                    <td>${description}</td>
                    <td>${expenseCategoryDisplay}</td>
                    <td>
                        <button onclick="showTransactionModal('${transaction.id}')">Редактировать</button>
                        <button onclick="deleteTransaction('${transaction.id}')" class="btn-danger">Удалить</button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }

        // Обновление дашборда
        function updateDashboard() {
            const filteredTransactions = filterTransactionsByPeriod();
            
            const {
                detailingIncome, detailingExpense, detailingNet,
                self12Income, self12Expense, self12Net,
                self35Income, self35Expense, self35Net,
                chingizProfit, sultanProfit, totalProfit,
                mutualSettlement
            } = calculateProfits(filteredTransactions);

            // Расширенный анализ прибыльности
            const advancedAnalysis = calculateAdvancedProfits(filteredTransactions);
            updateAdvancedAnalytics(advancedAnalysis);
            createMiniCharts(filteredTransactions, advancedAnalysis);
            createTrendCharts();
            createCategoryTrendCharts();

            // Обновление интерфейса
            document.getElementById('detailing-profit-stat').textContent = `${detailingNet.toFixed(2)} руб.`;
            document.getElementById('detailing-margin-stat').textContent = `Маржа: ${advancedAnalysis.detailing.grossMargin.toFixed(1)}%`;
            
            document.getElementById('self12-profit-stat').textContent = `${self12Net.toFixed(2)} руб.`;
            document.getElementById('self12-margin-stat').textContent = `Маржа: ${advancedAnalysis.self12.grossMargin.toFixed(1)}%`;
            
            document.getElementById('self35-profit-stat').textContent = `${self35Net.toFixed(2)} руб.`;
            document.getElementById('self35-margin-stat').textContent = `Маржа: ${advancedAnalysis.self35.grossMargin.toFixed(1)}%`;
            
            // Обновление показателей рентабельности
            document.getElementById('detailing-profitability').textContent = `${advancedAnalysis.detailing.grossMargin.toFixed(1)}%`;
            document.getElementById('self12-profitability').textContent = `${advancedAnalysis.self12.grossMargin.toFixed(1)}%`;
            document.getElementById('self35-profitability').textContent = `${advancedAnalysis.self35.grossMargin.toFixed(1)}%`;
            
            document.getElementById('chingiz-profit-stat').textContent = `${chingizProfit.toFixed(2)} руб.`;
            document.getElementById('sultan-profit-stat').textContent = `${sultanProfit.toFixed(2)} руб.`;
            document.getElementById('total-profit-stat').textContent = `${totalProfit.toFixed(2)} руб.`;
            
            document.getElementById('settlement-amount').textContent = `${Math.abs(mutualSettlement).toFixed(2)} руб.`;
            
            const settlementText = document.getElementById('settlement-text');
            if (mutualSettlement > 0) {
                settlementText.textContent = 'Султан (собственник) должен перевести Чингизу (управляющему)';
                document.getElementById('settlement-amount').className = 'settlement-amount card-positive';
            } else if (mutualSettlement < 0) {
                settlementText.textContent = 'Чингиз (управляющий) должен перевести Султану (собственнику)';
                document.getElementById('settlement-amount').className = 'settlement-amount card-negative';
            } else {
                settlementText.textContent = 'Расчеты сбалансированы';
                document.getElementById('settlement-amount').className = 'settlement-amount card-neutral';
            }
        }
        
        // Создание мини-графиков для нового дизайна дашборда
        function createMiniCharts(transactions, analysisData) {
            const { detailing, self12, self35 } = analysisData;

            // График доходов по категориям
            const incomeCtx = document.getElementById('incomeChart').getContext('2d');
            if (incomeChart) incomeChart.destroy();
            
            incomeChart = new Chart(incomeCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Детейлинг', 'Посты 1-2', 'Посты 3-5'],
                    datasets: [{
                        data: [detailing.income, self12.income, self35.income],
                        backgroundColor: ['#4A6FA5', '#6B8E23', '#F0AD4E']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });

            // График расходов по категориям
            const expenseCtx = document.getElementById('expenseChart').getContext('2d');
            if (expenseChart) expenseChart.destroy();
            
            expenseChart = new Chart(expenseCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Детейлинг', 'Посты 1-2', 'Посты 3-5'],
                    datasets: [{
                        data: [detailing.operatingExpenses, self12.operatingExpenses, self35.operatingExpenses],
                        backgroundColor: ['#4A6FA5', '#6B8E23', '#F0AD4E']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });

            // График прибыли по направлениям
            const profitCtx = document.getElementById('profitChart').getContext('2d');
            if (profitChart) profitChart.destroy();
            
            profitChart = new Chart(profitCtx, {
                type: 'bar',
                data: {
                    labels: ['Детейлинг', 'Посты 1-2', 'Посты 3-5'],
                    datasets: [{
                        label: 'Чистая прибыль',
                        data: [detailing.netProfit, self12.netProfit, self35.netProfit],
                        backgroundColor: ['#4A6FA5', '#6B8E23', '#F0AD4E']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            // График способов оплаты
            const paymentMethods = {
                'sultan_akbars': 0,
                'sultan_sber': 0,
                'chingiz_cash': 0,
                'chingiz_card': 0,
                'sultan_sber_cash': 0,
                'chingiz_cash_self': 0,
                'reserve': 0
            };
            
            transactions
                .filter(t => t.type === 'income')
                .forEach(t => {
                    if (paymentMethods.hasOwnProperty(t.payment)) {
                        paymentMethods[t.payment] += t.amount;
                    }
                });
            
            const paymentCtx = document.getElementById('paymentChart').getContext('2d');
            if (paymentChart) paymentChart.destroy();
            
            paymentChart = new Chart(paymentCtx, {
                type: 'pie',
                data: {
                    labels: [
                        'Счет АББ Султана',
                        'Счет Сбер Султана',
                        'Наличные (Чингиз)',
                        'Счет Чингиза',
                        'Счет Сбер (Султан)',
                        'Наличные (Чингиз) - самооб.',
                        'Резерв'
                    ],
                    datasets: [{
                        data: [
                            paymentMethods.sultan_akbars,
                            paymentMethods.sultan_sber,
                            paymentMethods.chingiz_cash,
                            paymentMethods.chingiz_card,
                            paymentMethods.sultan_sber_cash,
                            paymentMethods.chingiz_cash_self,
                            paymentMethods.reserve
                        ],
                        backgroundColor: [
                            '#4A6FA5',
                            '#3A5A8C',
                            '#D9534F',
                            '#C9302C',
                            '#8E44AD',
                            '#7D3C98',
                            '#F0AD4E'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            }
                    }
                }
            });
        }

        // Создание графиков трендов
        function createTrendCharts() {
            // Подготовка данных за последние 6 месяцев
            const now = new Date();
            const months = [];
            const incomeData = [];
            const expenseData = [];
            
            for (let i = 5; i >= 0; i--) {
                const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
                const monthKey = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                const monthName = date.toLocaleDateString('ru-RU', { month: 'short', year: 'numeric' });
                
                months.push(monthName);
                
                // Фильтруем транзакции за месяц
                const monthTransactions = transactions.filter(t => {
                    const transactionDate = new Date(t.date);
                    return transactionDate.getFullYear() === date.getFullYear() && 
                           transactionDate.getMonth() === date.getMonth();
                });
                
                // Рассчитываем показатели
                const monthAnalysis = calculateAdvancedProfits(monthTransactions);
                const totalIncome = monthAnalysis.totals.totalIncome;
                const totalExpense = monthAnalysis.totals.totalCosts;
                
                incomeData.push(totalIncome);
                expenseData.push(totalExpense);
            }
            
            // График динамики доходов
            const incomeTrendCtx = document.getElementById('incomeTrendChart').getContext('2d');
            if (incomeTrendChart) incomeTrendChart.destroy();
            
            incomeTrendChart = new Chart(incomeTrendCtx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [
                        {
                            label: 'Доходы',
                            data: incomeData,
                            borderColor: '#4A6FA5',
                            backgroundColor: 'rgba(74, 111, 165, 0.1)',
                            tension: 0.3,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
            
            // График динамики расходов
            const expenseTrendCtx = document.getElementById('expenseTrendChart').getContext('2d');
            if (expenseTrendChart) expenseTrendChart.destroy();
            
            expenseTrendChart = new Chart(expenseTrendCtx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [
                        {
                            label: 'Расходы',
                            data: expenseData,
                            borderColor: '#D9534F',
                            backgroundColor: 'rgba(217, 83, 79, 0.1)',
                            tension: 0.3,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Создание графиков динамики по категориям
        function createCategoryTrendCharts() {
            // Подготовка данных за последние 6 месяцев
            const now = new Date();
            const months = [];
            const detailingIncomeData = [];
            const self12IncomeData = [];
            const self35IncomeData = [];
            const detailingExpenseData = [];
            const self12ExpenseData = [];
            const self35ExpenseData = [];
            
            for (let i = 5; i >= 0; i--) {
                const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
                const monthKey = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                const monthName = date.toLocaleDateString('ru-RU', { month: 'short', year: 'numeric' });
                
                months.push(monthName);
                
                // Фильтруем транзакции за месяц
                const monthTransactions = transactions.filter(t => {
                    const transactionDate = new Date(t.date);
                    return transactionDate.getFullYear() === date.getFullYear() && 
                           transactionDate.getMonth() === date.getMonth();
                });
                
                // Рассчитываем показатели по категориям
                const monthAnalysis = calculateAdvancedProfits(monthTransactions);
                
                detailingIncomeData.push(monthAnalysis.detailing.income);
                self12IncomeData.push(monthAnalysis.self12.income);
                self35IncomeData.push(monthAnalysis.self35.income);
                
                detailingExpenseData.push(monthAnalysis.detailing.operatingExpenses);
                self12ExpenseData.push(monthAnalysis.self12.operatingExpenses);
                self35ExpenseData.push(monthAnalysis.self35.operatingExpenses);
            }
            
            // График динамики доходов по направлениям
            const incomeByCategoryCtx = document.getElementById('incomeByCategoryChart').getContext('2d');
            if (incomeByCategoryChart) incomeByCategoryChart.destroy();
            
            incomeByCategoryChart = new Chart(incomeByCategoryCtx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [
                        {
                            label: 'Детейлинг',
                            data: detailingIncomeData,
                            borderColor: '#4A6FA5',
                            backgroundColor: 'rgba(74, 111, 165, 0.1)',
                            tension: 0.3,
                            fill: false
                        },
                        {
                            label: 'Посты 1-2',
                            data: self12IncomeData,
                            borderColor: '#6B8E23',
                            backgroundColor: 'rgba(107, 142, 35, 0.1)',
                            tension: 0.3,
                            fill: false
                        },
                        {
                            label: 'Посты 3-5',
                            data: self35IncomeData,
                            borderColor: '#F0AD4E',
                            backgroundColor: 'rgba(240, 173, 78, 0.1)',
                            tension: 0.3,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
            
            // График динамики расходов по направлениям
            const expenseByCategoryCtx = document.getElementById('expenseByCategoryChart').getContext('2d');
            if (expenseByCategoryChart) expenseByCategoryChart.destroy();
            
            expenseByCategoryChart = new Chart(expenseByCategoryCtx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [
                        {
                            label: 'Детейлинг',
                            data: detailingExpenseData,
                            borderColor: '#4A6FA5',
                            backgroundColor: 'rgba(74, 111, 165, 0.1)',
                            tension: 0.3,
                            fill: false
                        },
                        {
                            label: 'Посты 1-2',
                            data: self12ExpenseData,
                            borderColor: '#6B8E23',
                            backgroundColor: 'rgba(107, 142, 35, 0.1)',
                            tension: 0.3,
                            fill: false
                        },
                        {
                            label: 'Посты 3-5',
                            data: self35ExpenseData,
                            borderColor: '#F0AD4E',
                            backgroundColor: 'rgba(240, 173, 78, 0.1)',
                            tension: 0.3,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Обновление расширенной аналитики на дашборде
        function updateAdvancedAnalytics(analysisData) {
            const { detailing, self12, self35, totals } = analysisData;

            const overallMargin = totals.totalIncome > 0 ? (totals.totalNetProfit / totals.totalIncome) * 100 : 0;
            const grossMargin = totals.totalIncome > 0 ? (totals.totalGrossProfit / totals.totalIncome) * 100 : 0;
            const netMargin = totals.totalIncome > 0 ? (totals.totalNetProfit / totals.totalIncome) * 100 : 0;

            document.getElementById('overall-margin').textContent = overallMargin.toFixed(1) + '%';
            document.getElementById('gross-margin').textContent = grossMargin.toFixed(1) + '%';
            document.getElementById('net-margin').textContent = netMargin.toFixed(1) + '%';
        }

        // Улучшенная функция расчета прибыли с расширенной классификацией расходов
        function calculateAdvancedProfits(transactions) {
            const initBusinessMetrics = () => ({
                income: 0,
                costOfGoodsSold: 0,
                operatingExpenses: 0,
                directCosts: 0,
                indirectCosts: 0,
                fixedCosts: 0,
                variableCosts: 0
            });
            
            let detailing = initBusinessMetrics();
            let self12 = initBusinessMetrics();
            let self35 = initBusinessMetrics();

            transactions.forEach(transaction => {
                const amount = transaction.amount;
                const category = transaction.category;
                const description = (transaction.description || '').toLowerCase();
                
                if (transaction.type === 'income') {
                    if (category === 'detailing') detailing.income += amount;
                    else if (category === 'self12') self12.income += amount;
                    else if (category === 'self35') self35.income += amount;
                } else if (transaction.type === 'expense') {
                    let expenseCategory;
                    if (transaction.manualExpenseCategory) {
                        expenseCategory = transaction.manualExpenseCategory;
                    } else {
                        expenseCategory = classifyExpense(description);
                    }
                    
                    if (category === 'detailing') {
                        detailing[expenseCategory === 'cogs' ? 'costOfGoodsSold' : expenseCategory + 'Costs'] += amount;
                        detailing.operatingExpenses += amount;
                    } else if (category === 'self12') {
                        self12[expenseCategory === 'cogs' ? 'costOfGoodsSold' : expenseCategory + 'Costs'] += amount;
                        self12.operatingExpenses += amount;
                    } else if (category === 'self35') {
                        self35[expenseCategory === 'cogs' ? 'costOfGoodsSold' : expenseCategory + 'Costs'] += amount;
                        self35.operatingExpenses += amount;
                    }
                }
            });

            const calculateProfitMetrics = (business) => {
                const grossProfit = business.income - business.costOfGoodsSold;
                const netProfit = grossProfit - business.operatingExpenses;
                const grossMargin = business.income > 0 ? (grossProfit / business.income) * 100 : 0;
                const netMargin = business.income > 0 ? (netProfit / business.income) * 100 : 0;

                return {
                    ...business,
                    grossProfit,
                    netProfit,
                    grossMargin,
                    netMargin
                };
            };

            return {
                detailing: calculateProfitMetrics(detailing),
                self12: calculateProfitMetrics(self12),
                self35: calculateProfitMetrics(self35),
                totals: {
                    totalIncome: detailing.income + self12.income + self35.income,
                    totalGrossProfit: (detailing.income - detailing.costOfGoodsSold) + 
                                    (self12.income - self12.costOfGoodsSold) + 
                                    (self35.income - self35.costOfGoodsSold),
                    totalNetProfit: (detailing.income - detailing.operatingExpenses) + 
                                  (self12.income - self12.operatingExpenses) + 
                                  (self35.income - self35.operatingExpenses),
                    totalCosts: detailing.operatingExpenses + self12.operatingExpenses + self35.operatingExpenses
                }
            };
        }

        // Фильтрация транзакций по периоду
        function filterTransactionsByPeriod() {
            const period = document.getElementById('period').value;
            const now = new Date();
            let startDate, endDate;
            
            switch (period) {
                case 'current_month':
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59, 999);
                    break;
                case 'last_month':
                    startDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                    endDate = new Date(now.getFullYear(), now.getMonth(), 0, 23, 59, 59, 999);
                    break;
                case 'last_3_months':
                    startDate = new Date(now.getFullYear(), now.getMonth() - 3, 1);
                    endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59, 999);
                    break;
                case 'current_year':
                    startDate = new Date(now.getFullYear(), 0, 1);
                    endDate = new Date(now.getFullYear() + 1, 0, 0, 23, 59, 59, 999);
                    break;
                case 'last_year':
                    startDate = new Date(now.getFullYear() - 1, 0, 1);
                    endDate = new Date(now.getFullYear(), 0, 0, 23, 59, 59, 999);
                    break;
                case 'custom':
                    const start = document.getElementById('start-date').value;
                    const end = document.getElementById('end-date').value;
                    if (start && end) {
                        startDate = new Date(start);
                        endDate = new Date(end);
                        endDate.setHours(23, 59, 59, 999);
                    } else {
                        return transactions;
                    }
                    break;
                default:
                    return transactions;
            }
            
            return transactions.filter(t => {
                const transactionDate = new Date(t.date);
                return transactionDate >= startDate && transactionDate <= endDate;
            });
        }
        
        // Расчет прибылей и взаимных расчетов
        function calculateProfits(transactions) {
            let detailingIncome = 0;
            let detailingExpense = 0;
            
            let self12Income = 0;
            let self12Expense = 0;
            
            let self35Income = 0;
            let self35Expense = 0;
            
            let detailingIncomeChingiz = 0;
            let detailingIncomeSultan = 0;
            
            let self12IncomeChingiz = 0;
            let self12IncomeSultan = 0;
            
            let self35IncomeChingiz = 0;
            let self35IncomeSultan = 0;
            
            let detailingExpenseChingiz = 0;
            let detailingExpenseSultan = 0;
            
            let self12ExpenseChingiz = 0;
            let self12ExpenseSultan = 0;
            
            let self35ExpenseChingiz = 0;
            let self35ExpenseSultan = 0;
            
            transactions.forEach(t => {
                if (t.type === 'income') {
                    if (t.category === 'detailing') {
                        detailingIncome += t.amount;
                        if (t.payment === 'chingiz_cash' || t.payment === 'chingiz_card' || t.payment === 'reserve') {
                            detailingIncomeChingiz += t.amount;
                        } else {
                            detailingIncomeSultan += t.amount;
                        }
                    } else if (t.category === 'self12') {
                        self12Income += t.amount;
                        if (t.payment === 'chingiz_cash_self' || t.payment === 'reserve') {
                            self12IncomeChingiz += t.amount;
                        } else {
                            self12IncomeSultan += t.amount;
                        }
                    } else if (t.category === 'self35') {
                        self35Income += t.amount;
                        if (t.payment === 'chingiz_cash_self' || t.payment === 'reserve') {
                            self35IncomeChingiz += t.amount;
                        } else {
                            self35IncomeSultan += t.amount;
                        }
                    }
                } else {
                    if (t.category === 'detailing') {
                        detailingExpense += t.amount;
                        if (t.payment === 'chingiz_cash' || t.payment === 'chingiz_card' || t.payment === 'reserve') {
                            detailingExpenseChingiz += t.amount;
                        } else {
                            detailingExpenseSultan += t.amount;
                        }
                    } else if (t.category === 'self12') {
                        self12Expense += t.amount;
                        if (t.payment === 'chingiz_cash_self' || t.payment === 'reserve') {
                            self12ExpenseChingiz += t.amount;
                        } else {
                            self12ExpenseSultan += t.amount;
                        }
                    } else if (t.category === 'self35') {
                        self35Expense += t.amount;
                        if (t.payment === 'chingiz_cash_self' || t.payment === 'reserve') {
                            self35ExpenseChingiz += t.amount;
                        } else {
                            self35ExpenseSultan += t.amount;
                        }
                    }
                }
            });
            
            const detailingNet = detailingIncome - detailingExpense;
            const self12Net = self12Income - self12Expense;
            const self35Net = self35Income - self35Expense;
            
            const chingizProfit = (detailingNet + self12Net) / 2;
            const sultanProfit = (detailingNet + self12Net) / 2 + self35Net;
            const totalProfit = chingizProfit + sultanProfit;
            
            const chingizActual = (detailingIncomeChingiz + self12IncomeChingiz + self35IncomeChingiz) - 
                                 (detailingExpenseChingiz + self12ExpenseChingiz + self35ExpenseChingiz);
            
            const mutualSettlement = chingizProfit - chingizActual;
            
            return {
                detailingIncome, detailingExpense, detailingNet,
                self12Income, self12Expense, self12Net,
                self35Income, self35Expense, self35Net,
                chingizProfit, sultanProfit, totalProfit,
                mutualSettlement
            };
        }

        // Генерация отчета с улучшенной детализацией
        function generateReport() {
            const reportPeriod = document.getElementById('report-period').value;
            const reportYear = document.getElementById('report-year').value;
            const reportMonth = document.getElementById('report-month').value;
            
            let startDate, endDate;
            
            if (reportPeriod === 'year') {
                // Годовой отчет
                startDate = new Date(reportYear, 0, 1);
                endDate = new Date(reportYear, 11, 31, 23, 59, 59, 999);
            } else if (reportPeriod === 'first_half') {
                // Первая половина месяца
                startDate = new Date(reportYear, reportMonth - 1, 1);
                endDate = new Date(reportYear, reportMonth - 1, 15, 23, 59, 59, 999);
            } else if (reportPeriod === 'second_half') {
                // Вторая половина месяца
                startDate = new Date(reportYear, reportMonth - 1, 16);
                endDate = new Date(reportYear, reportMonth, 0, 23, 59, 59, 999);
            } else if (reportPeriod === 'current_month') {
                // Текущий месяц
                const now = new Date();
                startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59, 999);
            } else {
                // Произвольный период (не реализовано в этой версии)
                const now = new Date();
                startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59, 999);
            }
            
            const reportTransactions = transactions.filter(t => {
                const transactionDate = new Date(t.date);
                return transactionDate >= startDate && transactionDate <= endDate;
            });
            
            const {
                detailingIncome, detailingExpense, detailingNet,
                self12Income, self12Expense, self12Net,
                self35Income, self35Expense, self35Net,
                chingizProfit, sultanProfit, totalProfit,
                mutualSettlement
            } = calculateProfits(reportTransactions);

            const advancedAnalysis = calculateAdvancedProfits(reportTransactions);
            
            const incomeTransactions = reportTransactions.filter(t => t.type === 'income');
            const expenseTransactions = reportTransactions.filter(t => t.type === 'expense');
            
            let sultanIncome = 0;
            let chingizIncome = 0;
            let sultanExpense = 0;
            let chingizExpense = 0;
            
            // Детализация по источникам для Султана и Чингиза с разделением по постам
            let sultanIncomeDetails = {
                'sultan_akbars': 0,
                'sultan_sber': 0,
                'sultan_sber_cash': 0,
                'self12_sultan': 0, // посты 1-2 Султана
                'self35_sultan': 0  // посты 3-5 Султана
            };
            
            let chingizIncomeDetails = {
                'chingiz_cash': 0,
                'chingiz_card': 0,
                'chingiz_cash_self12': 0, // наличные от постов 1-2
                'chingiz_cash_self35': 0, // наличные от постов 3-5
                'reserve': 0
            };
            
            let sultanExpenseDetails = {
                'sultan_akbars': 0,
                'sultan_sber': 0,
                'sultan_sber_cash': 0,
                'self12_sultan': 0, // расходы по постам 1-2 Султана
                'self35_sultan': 0  // расходы по постам 3-5 Султана
            };
            
            let chingizExpenseDetails = {
                'chingiz_cash': 0,
                'chingiz_card': 0,
                'chingiz_cash_self12': 0,
                'chingiz_cash_self35': 0,
                'reserve': 0
            };
            
            reportTransactions.forEach(t => {
                if (t.type === 'income') {
                    if (t.payment === 'sultan_akbars' || t.payment === 'sultan_sber' || t.payment === 'sultan_sber_cash') {
                        sultanIncome += t.amount;
                        sultanIncomeDetails[t.payment] += t.amount;
                        
                        // Разделяем доходы Султана по постам
                        if (t.category === 'self12') {
                            sultanIncomeDetails['self12_sultan'] += t.amount;
                        } else if (t.category === 'self35') {
                            sultanIncomeDetails['self35_sultan'] += t.amount;
                        }
                    } else if (t.payment === 'chingiz_cash' || t.payment === 'chingiz_card' || t.payment === 'reserve') {
                        chingizIncome += t.amount;
                        chingizIncomeDetails[t.payment] += t.amount;
                    } else if (t.payment === 'chingiz_cash_self') {
                        chingizIncome += t.amount;
                        // Разделяем наличные по постам
                        if (t.category === 'self12') {
                            chingizIncomeDetails['chingiz_cash_self12'] += t.amount;
                        } else if (t.category === 'self35') {
                            chingizIncomeDetails['chingiz_cash_self35'] += t.amount;
                        }
                    }
                } else {
                    if (t.payment === 'sultan_akbars' || t.payment === 'sultan_sber' || t.payment === 'sultan_sber_cash') {
                        sultanExpense += t.amount;
                        sultanExpenseDetails[t.payment] += t.amount;
                        
                        // Разделяем расходы Султана по постам
                        if (t.category === 'self12') {
                            sultanExpenseDetails['self12_sultan'] += t.amount;
                        } else if (t.category === 'self35') {
                            sultanExpenseDetails['self35_sultan'] += t.amount;
                        }
                    } else if (t.payment === 'chingiz_cash' || t.payment === 'chingiz_card' || t.payment === 'reserve') {
                        chingizExpense += t.amount;
                        chingizExpenseDetails[t.payment] += t.amount;
                    } else if (t.payment === 'chingiz_cash_self') {
                        chingizExpense += t.amount;
                        // Разделяем наличные по постам
                        if (t.category === 'self12') {
                            chingizExpenseDetails['chingiz_cash_self12'] += t.amount;
                        } else if (t.category === 'self35') {
                            chingizExpenseDetails['chingiz_cash_self35'] += t.amount;
                        }
                    }
                }
            });
            
            // Формирование HTML отчета с улучшенной детализацией
            let reportHTML = `
                <h3>Отчет за период: ${formatDate(startDate)} - ${formatDate(endDate)}</h3>
                
                <div class="profit-analysis">
                    <h4>Сводные показатели</h4>
                    <div class="profit-metrics">
                        <div class="metric-card">
                            <div>Общая прибыль</div>
                            <div class="metric-value">${totalProfit.toFixed(2)} руб.</div>
                        </div>
                        <div class="metric-card">
                            <div>Прибыль Чингиза (управляющий)</div>
                            <div class="metric-value">${chingizProfit.toFixed(2)} руб.</div>
                        </div>
                        <div class="metric-card">
                            <div>Прибыль Султана (собственник)</div>
                            <div class="metric-value">${sultanProfit.toFixed(2)} руб.</div>
                        </div>
                        <div class="metric-card">
                            <div>Взаимные расчеты</div>
                            <div class="metric-value">${Math.abs(mutualSettlement).toFixed(2)} руб.</div>
                            <div>${mutualSettlement > 0 ? 'Султан (собственник) → Чингиз (управляющий)' : mutualSettlement < 0 ? 'Чингиз (управляющий) → Султан (собственник)' : 'Сбалансировано'}</div>
                        </div>
                    </div>
                </div>
                
                <div class="accounts-breakdown">
                    <div class="account-card">
                        <h4>Доходы по счетам Султана (собственник)</h4>
                        <div class="account-details">
                            <div class="account-item">
                                <span>Счет АББ Султана:</span>
                                <span>${sultanIncomeDetails.sultan_akbars.toFixed(2)} руб.</span>
                            </div>
                            <div class="account-item">
                                <span>Счет Сбер Султана:</span>
                                <span>${sultanIncomeDetails.sultan_sber.toFixed(2)} руб.</span>
                            </div>
                            <div class="account-item">
                                <span>Счет Сбер (Султан) - самообслуживание:</span>
                                <span>${sultanIncomeDetails.sultan_sber_cash.toFixed(2)} руб.</span>
                            </div>
                            <div class="account-item">
                                <span>Доходы от постов 1-2:</span>
                                <span>${sultanIncomeDetails.self12_sultan.toFixed(2)} руб.</span>
                            </div>
                            <div class="account-item">
                                <span>Доходы от постов 3-5:</span>
                                <span>${sultanIncomeDetails.self35_sultan.toFixed(2)} руб.</span>
                            </div>
                            <div class="account-item" style="border-top: 1px solid var(--dark); font-weight: bold;">
                                <span>Итого доходы Султана:</span>
                                <span>${sultanIncome.toFixed(2)} руб.</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="account-card">
                        <h4>Доходы по счетам Чингиза (управляющий)</h4>
                        <div class="account-details">
                            <div class="account-item">
                                <span>Наличные (Чингиз):</span>
                                <span>${chingizIncomeDetails.chingiz_cash.toFixed(2)} руб.</span>
                            </div>
                            <div class="account-item">
                                <span>Счет Чингиза:</span>
                                <span>${chingizIncomeDetails.chingiz_card.toFixed(2)} руб.</span>
                            </div>
                            <div class="account-item">
                                <span>Наличные (Чингиз) - самообслуживание (посты 1-2):</span>
                                <span>${chingizIncomeDetails.chingiz_cash_self12.toFixed(2)} руб.</span>
                            </div>
                            <div class="account-item">
                                <span>Наличные (Чингиз) - самообслуживание (посты 3-5):</span>
                                <span>${chingizIncomeDetails.chingiz_cash_self35.toFixed(2)} руб.</span>
                            </div>
                            <div class="account-item">
                                <span>Резервный фонд Чингиза:</span>
                                <span>${chingizIncomeDetails.reserve.toFixed(2)} руб.</span>
                            </div>
                            <div class="account-item" style="border-top: 1px solid var(--dark); font-weight: bold;">
                                <span>Итого доходы Чингиза:</span>
                                <span>${chingizIncome.toFixed(2)} руб.</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="account-card">
                        <h4>Расходы по счетам Султана (собственник)</h4>
                        <div class="account-details">
                            <div class="account-item">
                                <span>Счет АББ Султана:</span>
                                <span>${sultanExpenseDetails.sultan_akbars.toFixed(2)} руб.</span>
                            </div>
                            <div class="account-item">
                                <span>Счет Сбер Султана:</span>
                                <span>${sultanExpenseDetails.sultan_sber.toFixed(2)} руб.</span>
                            </div>
                            <div class="account-item">
                                <span>Счет Сбер (Султан) - самообслуживание:</span>
                                <span>${sultanExpenseDetails.sultan_sber_cash.toFixed(2)} руб.</span>
                            </div>
                            <div class="account-item">
                                <span>Расходы по постам 1-2:</span>
                                <span>${sultanExpenseDetails.self12_sultan.toFixed(2)} руб.</span>
                            </div>
                            <div class="account-item">
                                <span>Расходы по постам 3-5:</span>
                                <span>${sultanExpenseDetails.self35_sultan.toFixed(2)} руб.</span>
                            </div>
                            <div class="account-item" style="border-top: 1px solid var(--dark); font-weight: bold;">
                                <span>Итого расходы Султана:</span>
                                <span>${sultanExpense.toFixed(2)} руб.</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="account-card">
                        <h4>Расходы по счетам Чингиза (управляющий)</h4>
                        <div class="account-details">
                            <div class="account-item">
                                <span>Наличные (Чингиз):</span>
                                <span>${chingizExpenseDetails.chingiz_cash.toFixed(2)} руб.</span>
                            </div>
                            <div class="account-item">
                                <span>Счет Чингиза:</span>
                                <span>${chingizExpenseDetails.chingiz_card.toFixed(2)} руб.</span>
                            </div>
                            <div class="account-item">
                                <span>Наличные (Чингиз) - самообслуживание (посты 1-2):</span>
                                <span>${chingizExpenseDetails.chingiz_cash_self12.toFixed(2)} руб.</span>
                            </div>
                            <div class="account-item">
                                <span>Наличные (Чингиз) - самообслуживание (посты 3-5):</span>
                                <span>${chingizExpenseDetails.chingiz_cash_self35.toFixed(2)} руб.</span>
                            </div>
                            <div class="account-item">
                                <span>Резервный фонд Чингиза:</span>
                                <span>${chingizExpenseDetails.reserve.toFixed(2)} руб.</span>
                            </div>
                            <div class="account-item" style="border-top: 1px solid var(--dark); font-weight: bold;">
                                <span>Итого расходы Чингиза:</span>
                                <span>${chingizExpense.toFixed(2)} руб.</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="summary-cards">
                    <div class="card">
                        <h3>Детейлинг</h3>
                        <div class="card-value">${detailingNet.toFixed(2)} руб.</div>
                        <div>Доходы: ${detailingIncome.toFixed(2)} руб.</div>
                        <div>Расходы: ${detailingExpense.toFixed(2)} руб.</div>
                        <div>Валовая рентабельность: ${advancedAnalysis.detailing.grossMargin.toFixed(1)}%</div>
                    </div>
                    
                    <div class="card">
                        <h3>Самообслуживание (посты 1-2)</h3>
                        <div class="card-value">${self12Net.toFixed(2)} руб.</div>
                        <div>Доходы: ${self12Income.toFixed(2)} руб.</div>
                        <div>Расходы: ${self12Expense.toFixed(2)} руб.</div>
                        <div>Валовая рентабельность: ${advancedAnalysis.self12.grossMargin.toFixed(1)}%</div>
                    </div>
                    
                    <div class="card">
                        <h3>Самообслуживание (посты 3-5)</h3>
                        <div class="card-value">${self35Net.toFixed(2)} руб.</div>
                        <div>Доходы: ${self35Income.toFixed(2)} руб.</div>
                        <div>Расходы: ${self35Expense.toFixed(2)} руб.</div>
                        <div>Валовая рентабельность: ${advancedAnalysis.self35.grossMargin.toFixed(1)}%</div>
                    </div>
                </div>
                
                <div class="profit-details">
                    <div class="settlement-card">
                        <h3>Взаимные расчеты</h3>
                        <p>Сумма для уравнивания прибыли</p>
                        <div class="settlement-amount">${Math.abs(mutualSettlement).toFixed(2)} руб.</div>
                        <p>${mutualSettlement > 0 ? 'Султан (собственник) должен перевести Чингизу (управляющему)' : mutualSettlement < 0 ? 'Чингиз (управляющий) должен перевести Султану (собственнику)' : 'Расчеты сбалансированы'}</p>
                    </div>
                    
                    <div class="reserve-card">
                        <h3>Резервный фонд</h3>
                        <p>Текущий баланс резервного фонда</p>
                        <div class="settlement-amount">${reserveBalance.toFixed(2)} руб.</div>
                    </div>
                </div>
                
                <h4>Статистика операций</h4>
                <div class="summary-cards">
                    <div class="card">
                        <h3>Всего операций</h3>
                        <div class="card-value">${reportTransactions.length}</div>
                        <div>Доходы: ${incomeTransactions.length}</div>
                        <div>Расходы: ${expenseTransactions.length}</div>
                    </div>
                    
                    <div class="card">
                        <h3>Общие суммы</h3>
                        <div class="card-value">${(sultanIncome + chingizIncome).toFixed(2)} руб.</div>
                        <div>Общие доходы: ${(sultanIncome + chingizIncome).toFixed(2)} руб.</div>
                        <div>Общие расходы: ${(sultanExpense + chingizExpense).toFixed(2)} руб.</div>
                    </div>
                </div>
                
                <h4>Расширенная аналитика расходов</h4>
                <div class="expense-classification-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Категория бизнеса</th>
                                <th>Себестоимость (COGS)</th>
                                <th>Прямые затраты</th>
                                <th>Косвенные затраты</th>
                                <th>Постоянные затраты</th>
                                <th>Переменные затраты</th>
                                <th>Итого расходов</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Детейлинг</td>
                                <td>${advancedAnalysis.detailing.costOfGoodsSold.toFixed(2)}</td>
                                <td>${advancedAnalysis.detailing.directCosts.toFixed(2)}</td>
                                <td>${advancedAnalysis.detailing.indirectCosts.toFixed(2)}</td>
                                <td>${advancedAnalysis.detailing.fixedCosts.toFixed(2)}</td>
                                <td>${advancedAnalysis.detailing.variableCosts.toFixed(2)}</td>
                                <td>${advancedAnalysis.detailing.operatingExpenses.toFixed(2)}</td>
                            </tr>
                            <tr>
                                <td>Посты 1-2</td>
                                <td>${advancedAnalysis.self12.costOfGoodsSold.toFixed(2)}</td>
                                <td>${advancedAnalysis.self12.directCosts.toFixed(2)}</td>
                                <td>${advancedAnalysis.self12.indirectCosts.toFixed(2)}</td>
                                <td>${advancedAnalysis.self12.fixedCosts.toFixed(2)}</td>
                                <td>${advancedAnalysis.self12.variableCosts.toFixed(2)}</td>
                                <td>${advancedAnalysis.self12.operatingExpenses.toFixed(2)}</td>
                            </tr>
                            <tr>
                                <td>Посты 3-5</td>
                                <td>${advancedAnalysis.self35.costOfGoodsSold.toFixed(2)}</td>
                                <td>${advancedAnalysis.self35.directCosts.toFixed(2)}</td>
                                <td>${advancedAnalysis.self35.indirectCosts.toFixed(2)}</td>
                                <td>${advancedAnalysis.self35.fixedCosts.toFixed(2)}</td>
                                <td>${advancedAnalysis.self35.variableCosts.toFixed(2)}</td>
                                <td>${advancedAnalysis.self35.operatingExpenses.toFixed(2)}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="classification-info">
                    <p><strong>Пояснение к классификации расходов:</strong></p>
                    <ul>
                        <li><strong>Себестоимость (COGS):</strong> прямые затраты на производство услуг (химия, материалы, запчасти)</li>
                        <li><strong>Прямые затраты:</strong> расходы, напрямую связанные с оказанием услуг (зарплата операторов)</li>
                        <li><strong>Косвенные затраты:</strong> административные расходы (реклама, связь, банковские услуги)</li>
                        <li><strong>Постоянные затраты:</strong> расходы, не зависящие от объема услуг (аренда, коммунальные платежи)</li>
                        <li><strong>Переменные затраты:</strong> прочие расходы, зависящие от объема услуг</li>
                    </ul>
                </div>
            `;
            
            document.getElementById('report-content').innerHTML = reportHTML;
        }

        // Сохранение отчета
        function saveReport() {
            const reportContent = document.getElementById('report-content').innerHTML;
            const blob = new Blob([`
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Отчет автомойки</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; color: #333; }
                        .summary-cards { display: flex; gap: 20px; margin: 20px 0; }
                        .card { border: 1px solid #ddd; padding: 15px; border-radius: 5px; flex: 1; }
                        .settlement-card { background: #4A6FA5; color: white; padding: 20px; border-radius: 10px; margin: 20px 0; }
                        .reserve-card { background: #F0AD4E; color: white; padding: 20px; border-radius: 10px; margin: 20px 0; }
                        .profit-metrics { display: flex; gap: 15px; margin: 20px 0; }
                        .metric-card { background: rgba(255,255,255,0.15); padding: 15px; border-radius: 10px; text-align: center; flex: 1; }
                        .accounts-breakdown { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0; }
                        .account-card { border: 1px solid #ddd; padding: 15px; border-radius: 5px; }
                        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
                        th { background-color: #f5f5f5; }
                    </style>
                </head>
                <body>
                    ${reportContent}
                </body>
                </html>
            `], { type: 'text/html' });
            
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `отчет_автомойки_${new Date().toISOString().split('T')[0]}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Экспорт отчета в Excel
        function exportReportToExcel() {
            const reportPeriod = document.getElementById('report-period').value;
            const reportYear = document.getElementById('report-year').value;
            const reportMonth = document.getElementById('report-month').value;
            
            let startDate, endDate;
            
            if (reportPeriod === 'year') {
                startDate = new Date(reportYear, 0, 1);
                endDate = new Date(reportYear, 11, 31, 23, 59, 59, 999);
            } else if (reportPeriod === 'first_half') {
                startDate = new Date(reportYear, reportMonth - 1, 1);
                endDate = new Date(reportYear, reportMonth - 1, 15, 23, 59, 59, 999);
            } else if (reportPeriod === 'second_half') {
                startDate = new Date(reportYear, reportMonth - 1, 16);
                endDate = new Date(reportYear, reportMonth, 0, 23, 59, 59, 999);
            } else {
                const now = new Date();
                startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59, 999);
            }
            
            const reportTransactions = transactions.filter(t => {
                const transactionDate = new Date(t.date);
                return transactionDate >= startDate && transactionDate <= endDate;
            });
            
            const {
                detailingIncome, detailingExpense, detailingNet,
                self12Income, self12Expense, self12Net,
                self35Income, self35Expense, self35Net,
                chingizProfit, sultanProfit, totalProfit,
                mutualSettlement
            } = calculateProfits(reportTransactions);
            
            const advancedAnalysis = calculateAdvancedProfits(reportTransactions);
            
            // Создаем книгу Excel
            const wb = XLSX.utils.book_new();
            
            // Лист с общими данными
            const summaryData = [
                ['Отчет автомойки', `Период: ${formatDate(startDate)} - ${formatDate(endDate)}`],
                [''],
                ['Сводные показатели', ''],
                ['Общая прибыль', totalProfit.toFixed(2)],
                ['Прибыль Чингиза (управляющий)', chingizProfit.toFixed(2)],
                ['Прибыль Султана (собственник)', sultanProfit.toFixed(2)],
                ['Взаимные расчеты', Math.abs(mutualSettlement).toFixed(2)],
                ['Направление переводов', mutualSettlement > 0 ? 'Султан → Чингиз' : mutualSettlement < 0 ? 'Чингиз → Султан' : 'Сбалансировано'],
                [''],
                ['Показатели по направлениям', ''],
                ['Детейлинг - Доходы', detailingIncome.toFixed(2)],
                ['Детейлинг - Расходы', detailingExpense.toFixed(2)],
                ['Детейлинг - Чистая прибыль', detailingNet.toFixed(2)],
                ['Детейлинг - Валовая рентабельность', advancedAnalysis.detailing.grossMargin.toFixed(1) + '%'],
                ['Посты 1-2 - Доходы', self12Income.toFixed(2)],
                ['Посты 1-2 - Расходы', self12Expense.toFixed(2)],
                ['Посты 1-2 - Чистая прибыль', self12Net.toFixed(2)],
                ['Посты 1-2 - Валовая рентабельность', advancedAnalysis.self12.grossMargin.toFixed(1) + '%'],
                ['Посты 3-5 - Доходы', self35Income.toFixed(2)],
                ['Посты 3-5 - Расходы', self35Expense.toFixed(2)],
                ['Посты 3-5 - Чистая прибыль', self35Net.toFixed(2)],
                ['Посты 3-5 - Валовая рентабельность', advancedAnalysis.self35.grossMargin.toFixed(1) + '%']
            ];
            
            const ws_summary = XLSX.utils.aoa_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, ws_summary, "Сводный отчет");
            
            // Лист с транзакциями
            const transactionData = [['Дата', 'Тип', 'Категория', 'Способ оплаты', 'Сумма', 'Описание', 'Категория расходов']];
            
            reportTransactions.forEach(t => {
                let expenseCategoryDisplay = '';
                if (t.type === 'expense') {
                    const manualCategory = t.manualExpenseCategory;
                    if (manualCategory) {
                        expenseCategoryDisplay = getExpenseCategoryName(manualCategory) + ' (ручная)';
                    } else {
                        const autoCategory = classifyExpense(t.description);
                        expenseCategoryDisplay = getExpenseCategoryName(autoCategory) + ' (авто)';
                    }
                }
                
                transactionData.push([
                    t.date,
                    getTypeLabel(t.type),
                    getCategoryLabel(t.category),
                    getPaymentLabel(t.payment),
                    t.amount,
                    t.description || '',
                    expenseCategoryDisplay
                ]);
            });
            
            const ws_transactions = XLSX.utils.aoa_to_sheet(transactionData);
            XLSX.utils.book_append_sheet(wb, ws_transactions, "Операции");
            
            // Сохраняем файл
            XLSX.writeFile(wb, `отчет_автомойки_${formatDate(startDate)}_${formatDate(endDate)}.xlsx`);
        }

        // Экспорт данных в Excel
        function exportToExcel() {
            const data = [['Дата', 'Тип', 'Категория', 'Способ оплаты', 'Сумма', 'Описание', 'Категория расходов']];
            
            transactions.forEach(t => {
                let expenseCategoryDisplay = '';
                if (t.type === 'expense') {
                    const manualCategory = t.manualExpenseCategory;
                    if (manualCategory) {
                        expenseCategoryDisplay = getExpenseCategoryName(manualCategory) + ' (ручная)';
                    } else {
                        const autoCategory = classifyExpense(t.description);
                        expenseCategoryDisplay = getExpenseCategoryName(autoCategory) + ' (авто)';
                    }
                }
                
                data.push([
                    t.date,
                    getTypeLabel(t.type),
                    getCategoryLabel(t.category),
                    getPaymentLabel(t.payment),
                    t.amount,
                    t.description || '',
                    expenseCategoryDisplay
                ]);
            });
            
            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Операции");
            
            XLSX.writeFile(wb, "данные_автомойки.xlsx");
        }
        
        // Экспорт данных (резервная копия)
        function exportData(isBackup = false) {
            const data = {
                transactions,
                reserveBalance,
                savedExpenses,
                exportDate: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = isBackup ? 'backup_автомойки.json' : 'данные_автомойки.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // Импорт данных (восстановление из резервной копии)
        function importData(event, isRestore = false) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (isRestore) {
                        if (confirm('Восстановление данных заменит все текущие операции. Продолжить?')) {
                            transactions = data.transactions || [];
                            reserveBalance = data.reserveBalance || 0;
                            savedExpenses = data.savedExpenses || [];
                            
                            localStorage.setItem('carwash_transactions', JSON.stringify(transactions));
                            localStorage.setItem('carwash_reserve', reserveBalance.toString());
                            localStorage.setItem('carwash_saved_expenses', JSON.stringify(savedExpenses));
                            
                            if (currentUser) {
                                saveToFirebase();
                            }
                            
                            renderTransactions();
                            updateDashboard();
                            updateReserveDisplay();
                            renderSavedExpenses();
                            
                            alert('Данные успешно восстановлены!');
                        }
                    } else {
                        // Импорт данных с добавлением к существующим
                        const newTransactions = data.transactions || [];
                        const newSavedExpenses = data.savedExpenses || [];
                        
                        newTransactions.forEach(t => {
                            if (!transactions.some(existing => existing.id === t.id)) {
                                transactions.push(t);
                            }
                        });
                        
                        newSavedExpenses.forEach(exp => {
                            if (!savedExpenses.some(existing => existing.id === exp.id)) {
                                savedExpenses.push(exp);
                            }
                        });
                        
                        localStorage.setItem('carwash_transactions', JSON.stringify(transactions));
                        localStorage.setItem('carwash_saved_expenses', JSON.stringify(savedExpenses));
                        
                        if (currentUser) {
                            saveToFirebase();
                        }
                        
                        renderTransactions();
                        updateDashboard();
                        renderSavedExpenses();
                        
                        alert('Данные успешно импортированы!');
                    }
                } catch (error) {
                    alert('Ошибка при загрузке файла: ' + error.message);
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }
        
        // Вспомогательные функции
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('ru-RU');
        }
        
        function getTypeLabel(type) {
            return type === 'income' ? 'Доход' : 'Расход';
        }
        
        function getCategoryLabel(category) {
            switch (category) {
                case 'detailing': return 'Детейлинг';
                case 'self12': return 'Самообслуживание (посты 1-2)';
                case 'self35': return 'Самообслуживание (посты 3-5)';
                case 'reserve': return 'Резервный фонд';
                default: return category;
            }
        }
        
        function getPaymentLabel(payment) {
            switch (payment) {
                case 'sultan_akbars': return 'Счет АББ Султана';
                case 'sultan_sber': return 'Счет Сбер Султана';
                case 'chingiz_cash': return 'Наличные (Чингиз)';
                case 'chingiz_card': return 'Счет Чингиза';
                case 'sultan_sber_cash': return 'Счет Сбер (Султан) - самообслуживание';
                case 'chingiz_cash_self': return 'Наличные (Чингиз) - самообслуживание';
                case 'reserve': return 'Резервный фонд Чингиза';
                default: return payment;
            }
        }
    </script>
</body>
</html>